{"version":3,"sources":["img/zipkin-logo.png","components/App/HeaderMenuItem.tsx","translations/en/messages.js","util/locale.ts","translations/es/messages.js","translations/fr/messages.js","translations/zh-cn/messages.js","components/App/LanguageSelector.tsx","components/App/TraceIdSearch.tsx","components/App/slice.ts","constants/api.js","slices/tracesSlice.ts","util/trace.js","components/App/TraceJsonUploader.tsx","components/UiConfig/UiConfig.jsx","util/fetch-resource.js","constants/color.ts","components/App/Layout.tsx","components/DependenciesPage/NodeDetailData.tsx","components/DependenciesPage/VizceralWrapper.tsx","components/DependenciesPage/DependenciesGraph.tsx","components/common/ExplainBox.tsx","slices/dependenciesSlice.ts","components/common/LoadingIndicator.tsx","components/DependenciesPage/DependenciesPage.tsx","components/DiscoverPage/Criterion.ts","components/DiscoverPage/lookback.ts","components/DiscoverPage/LookbackMenu.tsx","components/DiscoverPage/SearchBar/HowToUse.tsx","components/DiscoverPage/SearchBar/SuggestionList.tsx","components/DiscoverPage/SearchBar/CriterionBox.tsx","slices/autocompleteValuesSlice.ts","slices/remoteServicesSlice.ts","slices/servicesSlice.ts","slices/spansSlice.ts","components/DiscoverPage/SearchBar/SearchBar.tsx","util/timestamp.js","components/common/ServiceBadge.jsx","components/DiscoverPage/TraceSummaryRow.tsx","components/DiscoverPage/TraceSummaryTable.tsx","components/DiscoverPage/DiscoverPageContent.tsx","slices/autocompleteKeysSlice.ts","components/DiscoverPage/DiscoverPage.tsx","prop-types/index.js","components/TracePage/TraceSummaryHeader.jsx","components/TracePage/sizing.js","components/TracePage/TraceTimeline/TraceTree.jsx","components/TracePage/TraceTimeline/TraceTimelineRow.jsx","components/TracePage/TraceTimeline/TimeMarker.jsx","components/TracePage/TraceTimeline/TraceTimeline.jsx","components/TracePage/TraceTimelineHeader/TimeMarker.jsx","components/TracePage/TraceTimelineHeader/TraceTimelineHeader.jsx","components/TracePage/SpanDetail/util.js","components/TracePage/SpanDetail/SpanTags.jsx","components/TracePage/SpanDetail/SpanAnnotation.jsx","components/TracePage/SpanDetail/SpanAnnotationGraph.jsx","components/TracePage/SpanDetail/SpanAnnotations.jsx","components/TracePage/SpanDetail/SpanDetail.jsx","components/TracePage/TraceSummary.jsx","components/TracePage/TracePage.jsx","reducers/index.ts","store/configure-store.js","components/App/AlertSnackbar.tsx","components/App/App.tsx","index.tsx","zipkin/span-cleaner.js","zipkin/span-node.js","zipkin/clock-skew.js","zipkin/trace-constants.js","zipkin/span-row.js","zipkin/trace.js"],"names":["module","exports","useStyles","makeStyles","theme","createStyles","root","minHeight","paddingRight","spacing","paddingLeft","color","palette","grey","textDecoration","borderTop","borderBottom","display","alignItems","justifyContent","cursor","common","white","HeaderMenuItem","icon","title","path","classes","isSelected","useLocation","pathname","to","className","classNames","size","Title","styled","Typography","attrs","variant","allMessages","en","es","fr","i18n","setupI18n","messages","locale","override","localStorage","getItem","browserLanguage","navigator","language","toLowerCase","Object","prototype","hasOwnProperty","call","hyphenIndex","indexOf","stripped","substring","getLocale","localeData","zh","LANGUAGES","name","LanguageSelector","useLingui","anchorEl","setAnchorEl","React","useState","handleButtonClick","useCallback","event","preventDefault","currentTarget","handleMenuClose","currentLocale","handleMenuItemClick","dataset","setItem","setLocale","window","location","reload","Button","onClick","startIcon","endIcon","data-testid","find","lang","Menu","keepMounted","open","Boolean","onClose","map","MenuItem","key","data-locale","TraceIdSearch","history","useHistory","traceId","setTraceId","handleChange","target","value","handleKeyDown","push","TextField","label","onChange","onKeyDown","placeholder","_","appSlice","createSlice","reducers","clearAlert","state","alertOpen","setAlert","action","alert","payload","initialState","message","severity","actions","BASE_PATH","base","document","getElementsByTagName","length","getAttribute","replace","extractBasePath","ZIPKIN_API","UI_CONFIG","SERVICES","REMOTE_SERVICES","SPANS","TRACES","TRACE","DEPENDENCIES","AUTOCOMPLETE_KEYS","AUTOCOMPLETE_VALUES","treeCorrectedForClockSkew","traceSummary","buildTraceSummary","traceSummaries","buildTraceSummaries","detailedTraceSummary","buildDetailedTraceSummary","require","searchTraces","createAsyncThunk","async","params","thunkApi","ps","URLSearchParams","search","traces","getState","prevQuery","toString","query","resp","fetch","api","ok","Error","statusText","newTraces","json","reduce","acc","rawTrace","skewCorrectedTrace","get","keys","loadTrace","adjustedTrace","loadJsonTrace","rawTraceStr","blob","Promise","resolve","reject","reader","FileReader","onload","result","onerror","error","readAsText","readFileAsync","JSON","parse","trace","Array","isArray","first","id","binaryAnnotations","localEndpoint","remoteEndpoint","tags","ensureV2TraceData","isLoading","undefined","tracesSlice","clearSearch","extraReducers","builder","addCase","pending","newSearchState","fulfilled","forEach","rejected","meta","arg","TraceJsonUploader","dispatch","useDispatch","inputEl","useRef","handleClick","current","click","handleFileChange","file","files","then","unwrapResult","catch","err","FileInput","ref","Tooltip","IconButton","faUpload","input","type","ConfigContext","createContext","configResource","promise","response","read","fetchResource","defaultConfig","environment","queryLimit","defaultLookback","searchEnabled","dependency","lowErrorRate","highErrorRate","enabled","UiConfig","children","Provider","UiConfigContext","UiConfigConsumer","Consumer","useUiConfig","useContext","createMuiTheme","primary","main","contrastText","darkTheme","allColors","colors","allColorThemes","selectServiceTheme","serviceName","hash","str","i","charCodeAt","Math","abs","generateHash","selectServiceColor","dark","selectColorByErrorType","errorType","Layout","config","Box","CssBaseline","width","height","Logo","alt","ml","faSearch","faProjectDiagram","ThemeProvider","mr","supportUrl","href","faQuestionCircle","component","ToolbarSpace","AppBar","MuiAppBar","position","Toolbar","MuiToolbar","img","src","logoSrc","div","overflowWrap","flexGrow","minWidth","searchTracesButton","noDataMessage","opacity","tablePaper","marginRight","marginLeft","maxHeight","overflowY","borderRadius","tableHeadCell","top","padding","backgroundColor","zIndex","tableCell","wordBreak","withRouter","targetEdges","sourceEdges","handleSearchTracesButtonClick","set","shownDataList","edges","selectNodeName","edge","formatter","totalEdges","source","flexDirection","pt","pb","pr","pl","bgcolor","faSquare","borderColor","paddingBottom","overflow","d","left","bottom","right","data","metrics","normal","danger","nameKey","dataKey","outerRadius","fill","Paper","Table","TableHead","TableRow","TableCell","TableBody","VizceralExt","Vizceral","componentWillUnmount","this","vizceral","animate","VizceralWrapper","props","filterConnections","object","filterNodes","incomingConnections","conn","outgoingConnections","reactSelectStyles","control","option","clearIndicator","dropdownIndicator","containerGrid","graphItemGrid","nodeDetailDataItemGrid","boxShadow","shadows","vizceralWrapper","DependenciesGraph","dependencies","useTheme","vizStyle","colorText","colorTextDisabled","colorConnectionLine","colorTraffic","warning","secondary","colorDonutInternalColor","light","colorDonutInternalColorHighlighted","colorLabelBorder","colorLabelText","colorTrafficHighlighted","focusedNodeName","setFocusedNodeName","filter","setFilter","handleFilterChange","selected","actionMeta","nodes","createdTs","useMemo","nodeNames","node","includes","parent","child","callCount","errorCount","getNodesAndEdges","moment","valueOf","handleObjectHighlight","highlightedObject","getName","maxVolume","a","b","max","filterOptions","sort","localeCompare","Grid","container","item","xs","allowDraggingOfNodes","targetFramerate","traffic","renderer","layout","connections","updated","objectHighlighted","styles","filters","passes","isClearable","options","NodeDetailData","ExplainBox","memo","headerText","text","mt","mb","loadDependencies","lookback","endTs","dependenciesSlice","clearDependencies","LoadingIndicator","dateTimePicker","dateTimePickerInput","fontSize","searchButton","timeRange","setTimeRange","startTime","endTime","startTimeStr","parseInt","endTimeStr","useTimeRange","tempTimeRange","setTempTimeRange","subtract","days","useEffect","diff","useFetchDependencies","useSelector","handleStartTimeChange","handleEndTimeChange","handleSearchButtonClick","content","p","inputVariant","format","InputProps","m","newCriterion","shortid","generate","millisecondsToValue","fixedLookbackMap","duration","minutes","hours","cur","modal","fixedLookbackItemGrid","borderRight","divider","list","LookbackMenu","close","isOpeningDialog","setIsOpeningDialog","handleDialogOpen","handleDialogClose","handleOutsideClick","millis","setMillis","initialMillis","setStartTime","initialStartTime","setEndTime","initialEndTime","handleMillisChange","date","handleListItemClick","handleMillisApplyButtonClick","handleRangeApplyButtonClick","ClickAwayListener","onClickAway","elevation","List","ListItem","button","ListItemText","inputProps","min","onOpen","fullWidth","Root","background","paper","Code","code","ExampleList","ul","ExampleListItem","li","HowToUse","isFocused","SuggestionList","suggestions","isLoadingSuggestions","suggestionIndex","onItemClick","listEls","setListEl","index","el","scrollIntoView","CircularProgress","suggestion","fadeIn","keyframes","FocusedRoot","DeleteButton","Input","initialText","criterion","CriterionBox","criteria","criterionIndex","serviceNames","remoteServiceNames","spanNames","autocompleteKeys","autocompleteValues","isLoadingServiceNames","isLoadingRemoteServiceNames","isLoadingSpanNames","isLoadingAutocompleteValues","onFocus","onBlur","onDecide","onDelete","loadAutocompleteValues","setText","fixedText","setFixedText","useMount","focus","prevIsFocused","useLayoutEffect","strs","split","keyText","valueText","ss","isEnteringKey","s","setSuggestionIndex","newText","nextSuggestionIndex","handleDeleteButtonClick","stopPropagation","maxWidth","whiteSpace","textOverflow","faTimes","autocompleteKey","autocompleteValuesSlice","loadRemoteServices","remoteServices","remoteServicesSlice","loadServices","services","servicesSlice","loadSpans","spans","spansSlice","addButton","connect","setCriterionIndex","handleCriterionFocus","handleCriterionChange","newCriteria","handleCriterionBlur","handleCriterionDelete","handleCriterionDecide","nextCriterionIndex","handleAddButtonClick","prevServiceName","isFocusedRef","setTimeout","activeElement","tagName","addEventListener","removeEventListener","flexWrap","border","faPlus","formatDuration","toFixed","formatTimestampMicros","timestamp","formatTimestamp","slice","flexShrink","buttonBase","clickableButton","transition","transitions","create","short","defaultProps","count","ServiceBadgeImpl","data-test","ServiceBadge","TraceSummaryRow","toggleFilter","toggleOpen","sortedServiceSummaries","serviceSummaries","spanCount","handleToggleOpen","ServiceNameTypography","spanName","FromNowTypography","fromNow","align","DurationBar","infoClass","Link","CollapsibleTableCell","Collapse","in","timeout","unmountOnExit","margin","TraceIdTypography","BadgesWrapper","serviceSummary","selectColorByInfoClass","colSpan","TraceSummaryTable","traceSummaryOpenMap","toggleTraceSummaryOpen","order","setOrder","orderBy","setOrderBy","handleSortButtonClick","cellkey","prev","TableContainer","sortDirection","TableSortLabel","active","direction","data-cellkey","buildApiQuery","limit","annotationQuery","match","parseDuration","join","lb","asMilliseconds","DiscoverPageContent","setQueryParams","ret","tagQuery","exp","startTs","valueStr","useQueryParams","useFetchTraces","tempCriteria","setTempCriteria","tempLookback","setTempLookback","fixed","initialLookback","tempLimit","setTempLimit","lookbackDisplay","handleLimitChange","c","isShowingLookbackMenu","setIsShowingLookbackMenu","toggleLookbackMenu","closeLookbackMenu","isOpeningSettings","setIsOpeningSettings","handleSettingsButtonClick","handleFiltersChange","setFilters","from","add","Set","newFilters","useFilters","expandAll","collapseAll","setTraceSummaryOpenMap","newTraceSummaryOpenMap","useTraceSummaryOpenState","filteredTraceSummaries","serviceNameSet","has","Container","SearchBar","SearchButton","SettingsButton","isOpening","Divider","LookbackButton","ButtonGroup","Autocomplete","multiple","renderInput","rest","faHistory","faSync","loadAutocompleteKeys","autocompleteKeysSlice","isLoadingAutocompleteKeys","spanTagPropTypes","PropTypes","shape","string","isRequired","spanTagsPropTypes","arrayOf","spanAnnotationPropTypes","number","endpoint","relativeTime","spanAnnotationsPropTypes","detailedSpanPropTypes","spanId","parentId","childIds","durationStr","annotations","depth","detailedSpansPropTypes","spanServiceNameSummary","spanServiceNameSummaries","traceSummaryPropTypes","servicePercentage","serviceNameAndSpanCounts","rootSpan","upperBox","paddingTop","serviceNameAndSpanName","textTransform","lowerBox","marginTop","marginBottom","traceInfo","traceInfoEntry","traceInfoLabel","fontWeight","traceInfoValue","actionButton","lineHeight","actionButtonIcon","TraceSummaryHeader","rootSpanIndex","logsUrl","traceJsonUrl","archivePostUrl","archiveUrl","archiveClick","span","method","headers","body","stringify","status","entry","justify","download","faDownload","rel","faFileAlt","spanTreeLineWidthPercentPerDepth","serviceNameBadgeTranslate","spanToggleButtonTranslate","spanBarRowOffsetY","spanBarOffsetY","spanBarLinePosY","spanBarRowHeight","spanBarWidthPercent","spanBarOffsetXPercent","spanTreeWidthPercent","line","stroke","strokeWidth","spanToggleButton","buttonIcon","spanToggleButtonInternal","serviceBadgeText","TraceTree","childrenHiddenSpanIds","onChildrenToggle","horizontalLineDataList","verticalLineDataList","buttonDataList","serviceNameDataList","stack","currentSpan","stackTop","x","y","isClosed","popped","j","pop","y1","y2","buildTraceTree","x1","x2","transform","serviceNameWidthPercent","rx","ry","textAnchor","dominantBaseline","spanToggleButtonLengthOfSide","bar","row","TraceTimelineRow","onRowClick","spanDuration","spanTimestamp","calculateLeftAndWidth","isTextLeft","style","classnames","TimeMarker","timeMarkers","portion","xPercent","propTypes","currentSpanId","isRootedTrace","bool","func","TraceTimeline","version","xmlns","spanCounts","idx","marker","textButton","TraceTimelineHeader","isRerooted","onResetRerootButtonClick","isSpanDetailOpened","onSpanDetailToggle","onCollapseButtonClick","onExpandButtonClick","disabled","faAngleUp","faAngleDown","faAngleDoubleRight","faAngleDoubleLeft","generateAnnotationKey","annotation","generateTagKey","tag","cell","typography","fontWeightBold","SpanTags","SpanAnnotation","e","svg","circle","SpanAnnotationGraph","onAnnotationCircleClick","currentAnnotationKey","minTs","maxTs","minBy","maxBy","annotationKey","cx","cy","r","SpanAnnotations","setCurrentAnnotationKey","areAllAnnotationsOpened","setAreAllAnnotationsOpened","handleAnnotationCircleClick","currentAnnotation","handleExpandToggle","currentAnnotaionKey","borderLeft","annotationsAndTagsBox","annotationsAndTagsTitle","spanIds","spanIdEntry","spanIdLabel","spanIdValue","SpanDetail","findSpanIndex","findIndex","TraceSummary","hasRootSpan","setRootSpanIndex","currentSpanIndex","setCurrentSpanIndex","childrenHiddenSpanIndices","setChildrenHiddenSpanIndices","setIsSpanDetailOpened","traceTimelineWidthPercent","handleChildrenToggle","spanIndex","handleResetRerootButtonClick","handleTimelineRowClick","rerootedTree","shownTree","childrenHiddenSpanDepth","ts","handleSpanDetailToggle","handleExpandButtonClick","expandedSpanIndices","handleCollapseButtonClick","TracePageImpl","firstUpdate","createReducer","combineReducers","reducer","configureStore","createStore","applyMiddleware","thunk","AlertSnackbar","app","onSnackbarClose","Snackbar","autoHideDuration","anchorOrigin","vertical","horizontal","Alert","App","useTitle","fallback","utils","MomentUtils","store","basename","exact","DiscoverPage","DependenciesPage","TracePage","ReactDOM","render","getElementById","normalizeTraceId","padStart","startsWith","isEndpoint","merge","res","kind","sortBy","unionWith","isEqual","debug","shared","compare","isUndefined","compareShared","leftNotShared","rightNotShared","cleanupComparator","bySpanId","byShared","byService","byIpV4","ipv4","ipv6","compareEndpoint","spanComparator","mergeV2ById","last","cleaned","clean","next","port","portAsInt","splice","sorted","SpanNode","constructor","_parent","_span","_children","_setParent","newParent","setSpan","addChild","queueRootMostSpans","queue","traverse","spanCallback","shift","keyString","endpointString","nodeByTimestamp","SpanNodeBuilder","_debug","_rootSpan","_keyToNode","_spanToParent","_index","idKey","parentKey","_process","noEndpointKey","prefix","console","log","build","sortTreeByTimestamp","ClockSkew","skew","_endpoint","_skew","ipsMatch","adjustTimestamps","annotationLength","adjust","skewFromParent","oneWay","clientTimestamp","serverTimestamp","clientDuration","serverDuration","server","client","latency","getClockSkew","childrenOfRoot","rootSpanId","ConstantNames","getErrorType","currentErrorType","ann","formatEndpoint","toAnnotationRow","localFormatted","isDerived","maybePushServiceName","getServiceName","isNullOrUndefined","newSpanRow","spansToMerge","isLeafSpan","sharedTimestamp","sharedDuration","nextLocalServiceName","nextRemoteServiceName","begin","end","msTs","wsTs","wrTs","mrTs","annotationsToAdd","beginAnnotation","endAnnotation","parseAnnotationRows","maybePushAnnotation","tagRows","addr","tagRow","endpoints","parseTagRows","t","sameKeyAndValue","maybePushTag","addTimestamps","timestamps","getMaxDuration","pushEntry","dict","groupedTimestamps","addServiceNameTimestampDuration","rootServiceName","rootSpanName","formatDate","utc","mkDurationStr","summaries","maxDuration","parseFloat","entries","sts","maxSpanDuration","summary","getServiceSummaries","t1","t2","durationComparison","addLayoutDetails","spanRow","traceTimestamp","traceDuration","depthClass","serviceNameToCount","modelview","getTraceTimestampAndDuration","grandChild","concat","spansBackup","time","timeMarkersBackup"],"mappings":"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","file":"static/js/main.1f5ed6e2.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/zipkin-logo.95e14668.png\";","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { IconProp } from '@fortawesome/fontawesome-svg-core';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { Theme, Typography, createStyles, makeStyles } from '@material-ui/core';\nimport classNames from 'classnames';\nimport React from 'react';\nimport { Link, useLocation } from 'react-router-dom';\nimport styled from 'styled-components';\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      minHeight: 64,\n      paddingRight: theme.spacing(2),\n      paddingLeft: theme.spacing(2),\n      color: theme.palette.grey[500],\n      textDecoration: 'none',\n      borderTop: `2px solid transparent`,\n      borderBottom: `2px solid transparent`,\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      cursor: 'pointer',\n      '&:hover': {\n        color: theme.palette.grey[100],\n      },\n    },\n    'root--selected': {\n      color: theme.palette.common.white,\n      borderBottom: `2px solid ${theme.palette.common.white}`,\n    },\n  }),\n);\n\ninterface HeaderMenuItemProps {\n  icon: IconProp;\n  title: string;\n  path: string;\n}\n\nconst HeaderMenuItem: React.FC<HeaderMenuItemProps> = ({\n  icon,\n  title,\n  path,\n}) => {\n  const classes = useStyles();\n  const location = useLocation();\n  const isSelected = path === location.pathname;\n\n  return (\n    <Link\n      to={path}\n      className={classNames(classes.root, {\n        [classes['root--selected']]: isSelected,\n      })}\n    >\n      <FontAwesomeIcon icon={icon} size=\"lg\" />\n      <Title>{title}</Title>\n    </Link>\n  );\n};\n\nexport default HeaderMenuItem;\n\nconst Title = styled(Typography).attrs({\n  variant: 'body1',\n})`\n  margin-left: ${({ theme }) => theme.spacing(1.5)}px;\n`;\n","/*eslint-disable*/export const messages={\"1 Result\":\"1 Result\",\"Address\":\"Address\",\"Annotations\":\"Annotations\",\"Archive Trace\":\"Archive Trace\",\"Change Language\":\"Change Language\",\"Dependencies\":\"Dependencies\",\"Dependencies Page\":\"Dependencies Page\",\"Depth\":\"Depth\",\"Download JSON\":\"Download JSON\",\"Duration\":\"Duration\",\"End Time\":\"End Time\",\"Failed to load this file\":\"Failed to load this file\",\"Filter\":\"Filter\",\"Find a trace\":\"Find a trace\",\"Limit\":\"Limit\",\"None\":\"None\",\"One Result\":\"One Result\",\"Only V2 format is supported\":\"Only V2 format is supported\",\"Parent ID\":\"Parent ID\",\"Please select criteria in the search bar. Then, click the search button.\":\"Please select criteria in the search bar. Then, click the search button.\",\"Please select the criteria for your trace lookup\":\"Please select the criteria for your trace lookup\",\"Please select the start and end time. Then, click the search button.\":\"Please select the start and end time. Then, click the search button.\",\"Relative Time\":\"Relative Time\",\"Repository\":\"Repository\",\"Root\":\"Root\",\"Search Dependencies\":\"Search Dependencies\",\"Search Traces\":\"Search Traces\",\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\":\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\",\"Service Name\":\"Service Name\",\"Services\":\"Services\",\"Span ID\":\"Span ID\",\"Spans\":\"Spans\",\"Start Time\":\"Start Time\",\"Support\":\"Support\",\"Tags\":\"Tags\",\"This file does not contain JSON\":\"This file does not contain JSON\",\"Total Spans\":\"Total Spans\",\"Trace ID\":\"Trace ID\",\"Upload JSON\":\"Upload JSON\",\"View Logs\":\"View Logs\",\"Zipkin\":\"Zipkin\",\"Zipkin Home\":\"Zipkin Home\",\"hide annotations\":\"hide annotations\",\"show all annotations\":\"show all annotations\",\"{0} Results\":[[\"0\"],\" Results\"]};","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { setupI18n } from '@lingui/core';\nimport { messages as enMessages } from '../translations/en/messages';\nimport { messages as esMessages } from '../translations/es/messages';\nimport { messages as frMessages } from '../translations/fr/messages';\nimport { messages as zhCnMessages } from '../translations/zh-cn/messages';\n\nconst localeStorageKey = 'localeOverride';\n\nconst allMessages = {\n  en: enMessages,\n  es: esMessages,\n  fr: frMessages,\n  'zh-cn': zhCnMessages,\n};\n\nexport function getLocale(): string {\n  const override = localStorage.getItem(localeStorageKey);\n  if (override) {\n    return override;\n  }\n\n  const browserLanguage = navigator.language.toLowerCase();\n\n  if (Object.prototype.hasOwnProperty.call(allMessages, browserLanguage)) {\n    return browserLanguage;\n  }\n\n  const hyphenIndex = browserLanguage.indexOf('-');\n  if (hyphenIndex >= 0) {\n    const stripped = browserLanguage.substring(0, hyphenIndex);\n    if (Object.prototype.hasOwnProperty.call(allMessages, stripped)) {\n      return stripped;\n    }\n  }\n\n  // Default to English if we don't support the current browser language.\n  return 'en';\n}\n\nexport function setLocale(locale: string) {\n  localStorage.setItem(localeStorageKey, locale);\n}\n\nexport const i18n = setupI18n({\n  messages: allMessages as any,\n  locale: getLocale(),\n  localeData: {\n    en: {},\n    es: {},\n    fr: {},\n    zh: {},\n  },\n});\n","/*eslint-disable*/export const messages={\"1 Result\":\"1 Resultado\",\"Address\":\"Direcci\\xF3n\",\"Annotations\":\"Anotaciones\",\"Archive Trace\":\"Archivar Traza\",\"Change Language\":\"Cambiar Idioma\",\"Dependencies\":\"Dependencias\",\"Dependencies Page\":\"P\\xE1gina de Dependencies\",\"Depth\":\"Profundidad\",\"Download JSON\":\"Descargar JSON\",\"Duration\":\"Duraci\\xF3n\",\"End Time\":\"Tiempo de Fin\",\"Failed to load this file\":\"Fallo al cargar este archivo\",\"Filter\":\"Filtro\",\"Find a trace\":\"Encuentra un rastro\",\"Limit\":\"L\\xEDmite\",\"None\":\"Ninguno\",\"One Result\":\"Un Resultado\",\"Only V2 format is supported\":\"Solo el formato V2 es soportado\",\"Parent ID\":\"ID de Traza Padre\",\"Please select criteria in the search bar. Then, click the search button.\":\"Por favor, selecciona un criterio en la barra de b\\xFAsqueda. Luego, haz clic en el bot\\xF3n buscar.\",\"Please select the criteria for your trace lookup\":\"Por favor, selecciona el criterio para tu b\\xFAsqueda de trazas\",\"Please select the start and end time. Then, click the search button.\":\"Por favor, selecciona el tiempo de inicio y fin. Luego, haz clic en el bot\\xF3n buscar.\",\"Relative Time\":\"Tiempo Relativo\",\"Repository\":\"Repositorio\",\"Root\":\"Ra\\xEDz\",\"Search Dependencies\":\"Buscar Dependencias\",\"Search Traces\":\"Buscar Trazas\",\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\":\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\",\"Service Name\":\"Nombre del Servicio\",\"Services\":\"Servicios\",\"Span ID\":\"ID de Tramo\",\"Spans\":\"Tramos\",\"Start Time\":\"Tiempo de Inicio\",\"Support\":\"Soporte\",\"Tags\":\"Etiquetas\",\"This file does not contain JSON\":\"Este archivo no contiene JSON\",\"Total Spans\":\"Tramos Totales\",\"Trace ID\":\"ID de Traza\",\"Upload JSON\":\"Subir JSON\",\"View Logs\":\"Ver Logs\",\"Zipkin\":\"Zipkin\",\"Zipkin Home\":\"Zipkin Inicio\",\"hide annotations\":\"ocultar anotaciones\",\"show all annotations\":\"mostrar todas las anotaciones\",\"{0} Results\":[[\"0\"],\" Resultados\"]};","/*eslint-disable*/export const messages={\"1 Result\":\"1 R\\xE9sultat\",\"Address\":\"Adresse\",\"Annotations\":\"Annotations\",\"Archive Trace\":\"Trace Archiv\\xE9e\",\"Dependencies\":\"D\\xE9pendances\",\"Depth\":\"Profondeur\",\"Download JSON\":\"T\\xE9l\\xE9charger JSON\",\"Duration\":\"Dur\\xE9e\",\"End Time\":\"Fin\",\"Find a trace\":\"Trouver une trace\",\"Limit\":\"Limite\",\"None\":\"Aucun\",\"Parent ID\":\"ID Parent\",\"Please select criteria in the search bar. Then, click the search button.\":\"S'il vous pla\\xEEt s\\xE9lectionnez un crit\\xE8re dans la barre de recherche. Puis cliquez sur le bouton de recherche\",\"Please select the start and end time. Then, click the search button.\":\"S'il vous pla\\xEEt s\\xE9lectionnez la date de d\\xE9but et de fin. Puis cliquez sur le bouton de recherche\",\"Relative Time\":\"Temps Relatif\",\"Root\":\"Racine\",\"Search Dependencies\":\"Rechercher les d\\xE9pendances\",\"Search Traces\":\"Rechercher les traces\",\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\":\"La recherche a \\xE9t\\xE9 d\\xE9sactiv\\xE9e via la propri\\xE9t\\xE9 searchEnabled. Vous pouvez toujours afficher des traces sp\\xE9cifiques dont vous connaissez l'identifiant de trace en le saisissant dans la zone de texte \\\"ID Trace ... \\\" en haut \\xE0 droite.\",\"Services\":\"Services\",\"Span ID\":\"ID Section\",\"Spans\":\"Sections\",\"Start Time\":\"D\\xE9but\",\"Support\":\"Support\",\"Tags\":\"\\xC9tiquettes\",\"Total Spans\":\"Sections Total\",\"Trace ID\":\"ID Trace\",\"Upload JSON\":\"Charger un JSON\",\"View Logs\":\"Voir les journaux\",\"Zipkin\":\"Zipkin\",\"hide annotations\":\"masquer les annotations\",\"show all annotations\":\"afficher toutes les annotations\",\"{0} Results\":[[\"0\"],\" R\\xE9sultats\"]};","/*eslint-disable*/export const messages={\"1 Result\":\"1 \\u6761\\u7ED3\\u679C\",\"Address\":\"\\u5730\\u5740\",\"Annotations\":\"Annotations\",\"Archive Trace\":\"\\u5B58\\u6863Trace\",\"Change Language\":\"\\u6539\\u53D8\\u8BED\\u8A00\",\"Dependencies\":\"\\u4F9D\\u8D56\",\"Dependencies Page\":\"\\u4F9D\\u8D56\\u9875\\u9762\",\"Depth\":\"\\u6DF1\\u5EA6\",\"Download JSON\":\"\\u4E0B\\u8F7DJSON\\u6570\\u636E\",\"Duration\":\"\\u6301\\u7EED\\u65F6\\u95F4\",\"End Time\":\"\\u7EC8\\u6B62\\u65F6\\u95F4\",\"Failed to load this file\":\"\\u4E0B\\u8F7D\\u6587\\u4EF6\\u5931\\u8D25\",\"Filter\":\"\\u8FC7\\u6EE4\",\"Find a trace\":\"\\u627E\\u5230\\u4E00\\u4E2A\\u75D5\\u8FF9\",\"Limit\":\"\\u6570\\u91CF\",\"None\":\"\\u7A7A\",\"One Result\":\"1\\u6761\\u7ED3\\u679C\",\"Only V2 format is supported\":\"\\u4EC5\\u652F\\u6301V2\\u683C\\u5F0F\",\"Parent ID\":\"Parent ID\",\"Please select criteria in the search bar. Then, click the search button.\":\"\\u8BF7\\u5728\\u641C\\u7D22\\u680F\\u4E2D\\u9009\\u62E9\\u6761\\u4EF6\\uFF0C \\u7136\\u540E\\u70B9\\u51FB\\u6309\\u94AE\\u8FDB\\u884C\\u67E5\\u627E\",\"Please select the criteria for your trace lookup\":\"\\u8BF7\\u9009\\u62E9\\u6761\\u4EF6\\u8FDB\\u884Ctrace\\u67E5\\u627E\",\"Please select the start and end time. Then, click the search button.\":\"\\u8BF7\\u9009\\u62E9\\u8D77\\u59CB\\u65F6\\u95F4\\u548C\\u7EC8\\u6B62\\u65F6\\u95F4\\uFF0C \\u7136\\u540E\\u70B9\\u51FB\\u6309\\u94AE\\u8FDB\\u884C\\u67E5\\u627E\",\"Relative Time\":\"\\u76F8\\u5BF9\\u65F6\\u95F4\",\"Repository\":\"\\u4ED3\\u5E93\",\"Root\":\"Root\",\"Search Dependencies\":\"\\u67E5\\u8BE2\\u4F9D\\u8D56\",\"Search Traces\":\"\\u67E5\\u8BE2trace\\u94FE\\u8DEF\",\"Searching has been disabled via the searchEnabled property. You can still view specific traces of which you know the trace id by entering it in the \\\"Trace ID...\\\" textbox on the top-right.\":\"\\u5DF2\\u901A\\u8FC7searchEnabled\\u5C5E\\u6027\\u7981\\u7528\\u641C\\u7D22\\uFF0C\\u901A\\u8FC7\\u5728\\u53F3\\u4E0A\\u89D2\\u7684 \\\"Trace ID...\\\"\\u6587\\u672C\\u6846\\u4E2D\\u8F93\\u5165trace id\\uFF0C\\u60A8\\u4ECD\\u7136\\u53EF\\u4EE5\\u67E5\\u770B\\u5DF2\\u77E5trace id\\u7684\\u8DDF\\u8E2A\\u4FE1\\u606F\",\"Service Name\":\"\\u670D\\u52A1\",\"Services\":\"\\u670D\\u52A1\",\"Span ID\":\"Span ID\",\"Spans\":\"Spans\",\"Start Time\":\"\\u5F00\\u59CB\\u65F6\\u95F4\",\"Support\":\"\\u652F\\u6301\",\"Tags\":\"\\u6807\\u7B7E\",\"This file does not contain JSON\":\"\\u6B64\\u6587\\u4EF6\\u4E0D\\u5305\\u542BJSON\\u6570\\u636E\",\"Total Spans\":\"Span\\u603B\\u6570\",\"Trace ID\":\"Trace ID\",\"Upload JSON\":\"\\u4E0A\\u4F20JSON\\u6570\\u636E\",\"View Logs\":\"\\u67E5\\u770B\\u65E5\\u5FD7\",\"Zipkin\":\"Zipkin\",\"Zipkin Home\":\"Zipkin Home\",\"hide annotations\":\"\\u9690\\u85CFannotations\",\"show all annotations\":\"\\u663E\\u793A\\u5168\\u90E8annotations\",\"{0} Results\":[[\"0\"],\" \\u6761\\u7ED3\\u679C\"]};","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { useLingui } from '@lingui/react';\nimport { Button, Menu, MenuItem } from '@material-ui/core';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport TranslateIcon from '@material-ui/icons/Translate';\nimport React, { useCallback } from 'react';\n\nimport { setLocale } from '../../util/locale';\n\n// We want to display all the languages in native language, not current locale, so hard-code the\n// strings here instead of using internationalization.\n//\n// Exported for testing\nexport const LANGUAGES = [\n  {\n    locale: 'en',\n    name: 'English',\n  },\n  {\n    locale: 'es',\n    name: 'Espaol',\n  },\n  {\n    locale: 'fr',\n    name: 'Franais',\n  },\n  {\n    locale: 'zh-cn',\n    name: ' ()',\n  },\n];\n\nconst LanguageSelector = () => {\n  const { i18n } = useLingui();\n\n  const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);\n\n  const handleButtonClick = useCallback(\n    (event: React.MouseEvent<HTMLButtonElement>) => {\n      event.preventDefault();\n      setAnchorEl(event.currentTarget);\n    },\n    [],\n  );\n\n  const handleMenuClose = useCallback(() => {\n    setAnchorEl(null);\n  }, []);\n\n  const currentLocale = i18n.locale;\n\n  const handleMenuItemClick = useCallback(\n    (event: React.MouseEvent<HTMLLIElement>) => {\n      setAnchorEl(null);\n      const { locale } = event.currentTarget.dataset;\n      if (!locale) {\n        return;\n      }\n      if (locale === currentLocale) {\n        return;\n      }\n      setLocale(locale);\n      window.location.reload();\n    },\n    [currentLocale],\n  );\n\n  return (\n    <>\n      <Button\n        onClick={handleButtonClick}\n        startIcon={<TranslateIcon />}\n        endIcon={<ExpandMoreIcon />}\n        data-testid=\"change-language-button\"\n      >\n        {LANGUAGES.find((lang) => lang.locale === currentLocale)?.name}\n      </Button>\n      <Menu\n        anchorEl={anchorEl}\n        keepMounted\n        open={Boolean(anchorEl)}\n        onClose={handleMenuClose}\n      >\n        {LANGUAGES.map((lang) => (\n          <MenuItem\n            key={lang.locale}\n            onClick={handleMenuItemClick}\n            data-locale={lang.locale}\n            data-testid={`language-list-item-${lang.locale}`}\n          >\n            {lang.name}\n          </MenuItem>\n        ))}\n      </Menu>\n    </>\n  );\n};\n\nexport default LanguageSelector;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { useLingui } from '@lingui/react';\nimport { TextField } from '@material-ui/core';\nimport { t } from '@lingui/macro';\nimport React, { useCallback, useState } from 'react';\nimport { useHistory } from 'react-router-dom';\n\nconst TraceIdSearch: React.FC = () => {\n  const { i18n } = useLingui();\n  const history = useHistory();\n\n  const [traceId, setTraceId] = useState('');\n\n  const handleChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      setTraceId(event.target.value);\n    },\n    [],\n  );\n\n  const handleKeyDown = useCallback(\n    (event: React.KeyboardEvent<HTMLInputElement>) => {\n      if (event.key === 'Enter') {\n        history.push({\n          pathname: `/traces/${traceId}`,\n        });\n      }\n    },\n    [history, traceId],\n  );\n\n  return (\n    <TextField\n      label=\"Search by trace ID\"\n      value={traceId}\n      onChange={handleChange}\n      onKeyDown={handleKeyDown}\n      variant=\"outlined\"\n      size=\"small\"\n      placeholder={`${i18n._(t`Trace ID`)}...`}\n    />\n  );\n};\n\nexport default TraceIdSearch;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { Color } from '@material-ui/lab/Alert';\nimport { createSlice, PayloadAction } from '@reduxjs/toolkit';\n\ninterface Alert {\n  message: string;\n  severity: Color;\n}\n\ninterface AppState {\n  alert: Alert;\n  // We don't use truthiness of alert to control whether the alert is open or not to allow a clean\n  // animation when closing the alert, which requires the alert to still be rendered even when the\n  // snackbar is set to closed.\n  alertOpen: boolean;\n}\n\nconst initialState: AppState = {\n  alert: {\n    message: '',\n    severity: 'info',\n  },\n  alertOpen: false,\n};\n\nconst appSlice = createSlice({\n  name: 'app',\n  reducers: {\n    clearAlert(state): AppState {\n      return {\n        ...state,\n        alertOpen: false,\n      };\n    },\n    setAlert(state, action: PayloadAction<Alert>): AppState {\n      return {\n        ...state,\n        alert: action.payload,\n        alertOpen: true,\n      };\n    },\n  },\n  initialState,\n});\n\nexport default appSlice;\n\nexport const { clearAlert, setAlert } = appSlice.actions;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nconst extractBasePath = () => {\n  const base = document.getElementsByTagName('base');\n  if (base.length === 0) {\n    return '/zipkin';\n  }\n  return base[0].getAttribute('href').replace(/\\/+$/, '');\n};\n\nexport const BASE_PATH = extractBasePath();\n\nexport const ZIPKIN_API = `${BASE_PATH}/api/v2`;\nexport const UI_CONFIG = `${BASE_PATH}/config.json`;\nexport const SERVICES = `${ZIPKIN_API}/services`;\nexport const REMOTE_SERVICES = `${ZIPKIN_API}/remoteServices`;\nexport const SPANS = `${ZIPKIN_API}/spans`;\nexport const TRACES = `${ZIPKIN_API}/traces`;\nexport const TRACE = `${ZIPKIN_API}/trace`;\nexport const DEPENDENCIES = `${ZIPKIN_API}/dependencies`;\nexport const AUTOCOMPLETE_KEYS = `${ZIPKIN_API}/autocompleteKeys`;\nexport const AUTOCOMPLETE_VALUES = `${ZIPKIN_API}/autocompleteValues`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\nimport AdjustedTrace from '../models/AdjustedTrace';\nimport Span from '../models/Span';\nimport TraceSummary from '../models/TraceSummary';\nimport { ensureV2TraceData } from '../util/trace';\n\nconst {\n  treeCorrectedForClockSkew,\n  traceSummary: buildTraceSummary,\n  traceSummaries: buildTraceSummaries,\n  detailedTraceSummary: buildDetailedTraceSummary,\n} = require('../zipkin');\n\nexport const searchTraces = createAsyncThunk(\n  'traces/search',\n  async (params: { [key: string]: string }, thunkApi) => {\n    const ps = new URLSearchParams(params);\n\n    // We need to import RootState in order to give the type to getState.\n    // Importing RootState will result in a cyclic import.\n    // So use any type to avoid this.\n    const { search, traces }: TracesState = (thunkApi.getState() as any).traces;\n    // If the query is the same as the previous query, it will not fetch again.\n    if (search.prevQuery === ps.toString()) {\n      return {\n        traces,\n        traceSummaries: search.traceSummaries,\n        query: ps.toString(),\n      };\n    }\n\n    const resp = await fetch(`${api.TRACES}?${ps.toString()}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const rawTraces: Span[][] = await resp.json();\n\n    const newTraces = rawTraces.reduce(\n      (acc, rawTrace) => {\n        const [{ traceId }] = rawTrace;\n        const skewCorrectedTrace = treeCorrectedForClockSkew(rawTrace);\n        acc[traceId] = {\n          rawTrace,\n          skewCorrectedTrace,\n        };\n        return acc;\n      },\n      {} as {\n        [key: string]: {\n          rawTrace: Span[];\n          skewCorrectedTrace: any;\n        };\n      },\n    );\n\n    const traceSummaries: TraceSummary[] = buildTraceSummaries(\n      ps.get('serviceName'),\n      Object.keys(newTraces).map((traceId) =>\n        buildTraceSummary(newTraces[traceId].skewCorrectedTrace),\n      ),\n    );\n\n    return {\n      traces: newTraces,\n      traceSummaries,\n      query: ps.toString(),\n    };\n  },\n);\n\nexport const loadTrace = createAsyncThunk(\n  'traces/load',\n  async (traceId: string, thunkApi) => {\n    // We need to import RootState in order to give the type to getState.\n    // Importing RootState will result in a cyclic import.\n    // So use any type to avoid this.\n    const { traces }: TracesState = (thunkApi.getState() as any).traces;\n\n    if (traces[traceId]) {\n      const { rawTrace, skewCorrectedTrace } = traces[traceId];\n      let { adjustedTrace } = traces[traceId];\n      if (adjustedTrace) {\n        // this trace has already been calculated by buildDetailedTraceSummary\n        return traces[traceId];\n      }\n      if (skewCorrectedTrace) {\n        adjustedTrace = buildDetailedTraceSummary(skewCorrectedTrace);\n        return {\n          rawTrace,\n          skewCorrectedTrace,\n          adjustedTrace,\n        };\n      }\n    }\n\n    const resp = await fetch(`${api.TRACE}/${traceId}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const rawTrace: Span[] = await resp.json();\n    const skewCorrectedTrace = treeCorrectedForClockSkew(rawTrace);\n    const adjustedTrace: AdjustedTrace = buildDetailedTraceSummary(\n      skewCorrectedTrace,\n    );\n    return {\n      rawTrace,\n      skewCorrectedTrace,\n      adjustedTrace,\n    };\n  },\n);\n\nconst readFileAsync = (blob: Blob) => {\n  return new Promise<any>((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => {\n      resolve(reader.result);\n    };\n    reader.onerror = () => {\n      reject(reader.error);\n    };\n    reader.readAsText(blob);\n  });\n};\n\nexport const loadJsonTrace = createAsyncThunk(\n  'traces/loadJson',\n  async (blob: Blob) => {\n    const rawTraceStr = await readFileAsync(blob);\n    const rawTrace: Span[] = JSON.parse(rawTraceStr);\n    ensureV2TraceData(rawTrace);\n    const [{ traceId }] = rawTrace;\n    const skewCorrectedTrace = treeCorrectedForClockSkew(rawTrace);\n    const adjustedTrace: AdjustedTrace = buildDetailedTraceSummary(\n      skewCorrectedTrace,\n    );\n    return {\n      traceId,\n      trace: {\n        rawTrace,\n        skewCorrectedTrace,\n        adjustedTrace,\n      },\n    };\n  },\n);\n\nexport interface TracesState {\n  traces: {\n    [traceId: string]: {\n      // When fetching a specific trace, these isLoading and error states are used.\n      // They are not used in the search.\n      isLoading?: boolean;\n      error?: SerializedError;\n\n      rawTrace?: Span[];\n      adjustedTrace?: AdjustedTrace;\n      // This is a trace data with only the clock-skew modified.\n      // It is the intermediate data used to optimize the conversion process of the trace.\n      skewCorrectedTrace?: any;\n    };\n  };\n  search: {\n    // When searching, isLoading and error states are used.\n    // They are not used when fetching a specific trace.\n    isLoading: boolean;\n    error?: SerializedError;\n    // Save the previous query to avoid doing the same query unnecessarily.\n    prevQuery?: string;\n    traceSummaries: TraceSummary[];\n  };\n}\n\nconst initialState: TracesState = {\n  traces: {},\n  search: {\n    isLoading: false,\n    error: undefined,\n    prevQuery: undefined,\n    traceSummaries: [],\n  },\n};\n\nconst tracesSlice = createSlice({\n  name: 'traces',\n  initialState,\n  reducers: {\n    clearSearch: (state) => {\n      state.search.isLoading = false;\n      state.search.error = undefined;\n      state.search.prevQuery = undefined;\n      state.search.traceSummaries = [];\n    },\n  },\n  extraReducers: (builder) => {\n    builder.addCase(searchTraces.pending, (state) => {\n      const newSearchState = {\n        ...state.search,\n        isLoading: true,\n        error: undefined,\n      };\n      state.search = newSearchState;\n    });\n\n    builder.addCase(searchTraces.fulfilled, (state, action) => {\n      const { traces } = action.payload;\n      const newTraces = { ...state.traces };\n      Object.keys(traces).forEach((traceId) => {\n        newTraces[traceId] = traces[traceId];\n      });\n      const newSearchState = {\n        isLoading: false,\n        error: undefined,\n        prevQuery: action.payload.query,\n        traceSummaries: action.payload.traceSummaries,\n      };\n      state.search = newSearchState;\n      state.traces = newTraces;\n    });\n\n    builder.addCase(searchTraces.rejected, (state, action) => {\n      const newSearchState = {\n        ...state.search,\n        isLoading: false,\n        error: action.error,\n      };\n      state.search = newSearchState;\n    });\n\n    builder.addCase(loadTrace.pending, (state, action) => {\n      const traceId = action.meta.arg;\n      const newTraces = { ...state.traces };\n      if (!newTraces[traceId]) {\n        newTraces[traceId] = {};\n      }\n      newTraces[traceId].isLoading = true;\n      newTraces[traceId].error = undefined;\n      state.traces = newTraces;\n    });\n\n    builder.addCase(loadTrace.fulfilled, (state, action) => {\n      const traceId = action.meta.arg;\n      const newTraces = { ...state.traces };\n      newTraces[traceId] = { ...action.payload };\n      newTraces[traceId].isLoading = false;\n      newTraces[traceId].error = undefined;\n      state.traces = newTraces;\n    });\n\n    builder.addCase(loadTrace.rejected, (state, action) => {\n      const traceId = action.meta.arg;\n      const newTraces = { ...state.traces };\n      newTraces[traceId].isLoading = false;\n      newTraces[traceId].error = action.error;\n      state.traces = newTraces;\n    });\n\n    // It's easier to handle isLoading and error statuses on the component side,\n    // so don't change them here.\n    builder.addCase(loadJsonTrace.fulfilled, (state, action) => {\n      const { traceId, trace } = action.payload;\n      const newTraces = { ...state.traces };\n      newTraces[traceId] = trace;\n      state.traces = newTraces;\n    });\n  },\n});\n\nexport default tracesSlice;\n\nexport const { clearSearch } = tracesSlice.actions;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nexport const ensureV2TraceData = (trace) => {\n  if (!Array.isArray(trace) || trace.length === 0) {\n    throw new Error('input is not a list');\n  }\n  const [first] = trace;\n  if (!first.traceId || !first.id) {\n    throw new Error('List<Span> implies at least traceId and id fields');\n  }\n  if (\n    first.binaryAnnotations ||\n    (!first.localEndpoint && !first.remoteEndpoint && !first.tags)\n  ) {\n    throw new Error(\n      'v1 format is not supported. For help, contact https://gitter.im/openzipkin/zipkin',\n    );\n  }\n};\n\nexport const hasRootSpan = (trace) => {\n  switch (trace.length) {\n    case 0:\n      return false;\n    case 1:\n      return true;\n    default:\n      if (trace[0].depth < trace[1].depth) {\n        return true;\n      }\n      return false;\n  }\n};\n","import { Trans } from '@lingui/macro';\n/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { faUpload } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { IconButton, Tooltip } from '@material-ui/core';\nimport { unwrapResult } from '@reduxjs/toolkit';\nimport React, { useCallback, useRef } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport styled from 'styled-components';\n\nimport { setAlert } from './slice';\nimport { loadJsonTrace } from '../../slices/tracesSlice';\n\nconst TraceJsonUploader: React.FC = () => {\n  const dispatch = useDispatch();\n  const history = useHistory();\n  const inputEl = useRef<HTMLInputElement>(null);\n\n  const handleClick = useCallback(() => {\n    if (inputEl.current) {\n      inputEl.current.click();\n    }\n  }, []);\n\n  const handleFileChange = useCallback(\n    (event) => {\n      const [file] = event.target.files;\n      dispatch(loadJsonTrace(file))\n        .then(unwrapResult)\n        .then(({ traceId }) => {\n          history.push({\n            pathname: `/traces/${traceId}`,\n          });\n        })\n        .catch((err) => {\n          dispatch(\n            setAlert({\n              message: `Failed to load file: ${err.message}`,\n              severity: 'error',\n            }),\n          );\n        });\n    },\n    [dispatch, history],\n  );\n\n  return (\n    <>\n      <FileInput ref={inputEl} onChange={handleFileChange} />\n      <Tooltip title={<Trans>Upload JSON</Trans>}>\n        <IconButton onClick={handleClick}>\n          <FontAwesomeIcon icon={faUpload} size=\"sm\" />\n        </IconButton>\n      </Tooltip>\n    </>\n  );\n};\n\nexport default TraceJsonUploader;\n\nconst FileInput = styled.input.attrs({\n  type: 'file',\n})`\n  display: none;\n`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React, { useContext } from 'react';\n\nimport { UI_CONFIG } from '../../constants/api';\nimport fetchResource from '../../util/fetch-resource';\n\nconst ConfigContext = React.createContext();\n\nconst configResource = fetchResource(\n  fetch(UI_CONFIG).then((response) => response.json()),\n);\n\nconst propTypes = {\n  children: PropTypes.element.isRequired,\n};\n\nexport const defaultConfig = {\n  environment: '',\n  queryLimit: 10,\n  defaultLookback: 15 * 60 * 1000, // 15 minutes\n  searchEnabled: true,\n  dependency: {\n    lowErrorRate: 0.5, // 50% of calls in error turns line yellow\n    highErrorRate: 0.75, // 75% of calls in error turns line red\n    enabled: true,\n  },\n};\n\nexport const UiConfig = ({ children }) => {\n  const response = configResource.read();\n  Object.keys(defaultConfig).forEach((key) => {\n    if (!response[key]) {\n      response[key] = defaultConfig[key];\n    }\n  });\n\n  return (\n    <ConfigContext.Provider value={response}>{children}</ConfigContext.Provider>\n  );\n};\n\nUiConfig.propTypes = propTypes;\n\nexport const UiConfigContext = ConfigContext;\nexport const UiConfigConsumer = ConfigContext.Consumer;\n\nexport const useUiConfig = () => useContext(UiConfigContext);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/**\n * Converts a promise to a resource as used in React Suspense nomenclature. A resource provides a\n * read() method which will either suspend rendering until the promise is resolved or return / throw\n * the result of the promise if it is already resolved. This allows React Suspense to continue\n * rendering work while the promise is being resolved.\n */\nexport default (promise) => {\n  let response;\n  let error;\n\n  // In Javascript, there is no way to synchronously know whether a promise is resolved. Even if\n  // it's already resolved, we are guaranteed to suspend once. Since it's unlikely the promise has\n  // resolved at this point anyways, it's not a huge deal though.\n  promise.then(\n    (resp) => {\n      response = resp;\n    },\n    (err) => {\n      error = err;\n    },\n  );\n\n  return {\n    read() {\n      if (error) {\n        throw error;\n      } else if (response) {\n        return response;\n      } else {\n        // Throwing a promise is how to tell React to suspend rendering until it is resolved.\n        throw promise;\n      }\n    },\n  };\n};\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { createMuiTheme } from '@material-ui/core/styles';\nimport * as colors from '@material-ui/core/colors';\n\nexport const primaryColor = '#6a9fb5';\n\nexport const theme = createMuiTheme({\n  palette: {\n    primary: {\n      main: primaryColor,\n      contrastText: '#fff',\n    },\n  },\n});\n\nexport const darkTheme = createMuiTheme({\n  palette: {\n    type: 'dark',\n    primary: {\n      main: primaryColor,\n      contrastText: '#fff',\n    },\n  },\n});\n\nexport const allColors = [\n  colors.red,\n  colors.pink,\n  colors.purple,\n  colors.deepPurple,\n  colors.indigo,\n  colors.blue,\n  colors.lightBlue,\n  colors.cyan,\n  colors.teal,\n  colors.green,\n  colors.lightGreen,\n  colors.lime,\n  colors.yellow,\n  colors.amber,\n  colors.orange,\n  colors.deepOrange,\n  colors.brown,\n  colors.grey,\n  colors.blueGrey,\n];\n\nexport const allColorThemes = allColors.map((color) =>\n  createMuiTheme({\n    palette: {\n      primary: {\n        main: color[500],\n      },\n    },\n  }),\n);\n\n/* eslint no-bitwise: [\"error\", { \"allow\": [\"<<\", \"|=\"] }] */\nconst generateHash = (str: string) => {\n  let hash = 0;\n  if (str.length === 0) return hash;\n  for (let i = 0; i < str.length; i += 1) {\n    const c = str.charCodeAt(i);\n    hash = (hash << 5) - hash + c;\n    hash |= 0; // Convert to 32bit integer\n  }\n  return Math.abs(hash); // Only positive number.\n};\n\nexport const selectServiceTheme = (serviceName: string) => {\n  const hash = generateHash(serviceName);\n  return allColorThemes[hash % allColors.length];\n};\n\nexport const selectServiceColor = (serviceName: string) =>\n  selectServiceTheme(serviceName).palette.primary.dark;\n\nexport const selectColorByErrorType = (errorType: string) => {\n  switch (errorType) {\n    case 'transient':\n      return colors.red[500];\n    case 'critical':\n      return colors.red[500];\n    default:\n      return theme.palette.primary.main;\n  }\n};\n\nexport const selectColorByInfoClass = (infoClass: string) => {\n  switch (infoClass) {\n    case 'trace-error-transient':\n      return selectColorByErrorType('transient');\n    case 'trace-error-critical':\n      return selectColorByErrorType('critical');\n    default:\n      return selectColorByErrorType('none');\n  }\n};\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport {\n  faProjectDiagram,\n  faSearch,\n  faQuestionCircle,\n} from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { t } from '@lingui/macro';\nimport { useLingui } from '@lingui/react';\nimport {\n  AppBar as MuiAppBar,\n  Box,\n  CssBaseline,\n  ThemeProvider,\n  Toolbar as MuiToolbar,\n  Typography,\n  IconButton as MuiIconButton,\n  Tooltip,\n} from '@material-ui/core';\nimport React from 'react';\nimport styled from 'styled-components';\n\nimport HeaderMenuItem from './HeaderMenuItem';\nimport LanguageSelector from './LanguageSelector';\nimport TraceIdSearch from './TraceIdSearch';\nimport TraceJsonUploader from './TraceJsonUploader';\nimport { useUiConfig } from '../UiConfig';\nimport { darkTheme } from '../../constants/color';\nimport logoSrc from '../../img/zipkin-logo.png';\n\nconst Layout: React.FC = ({ children }) => {\n  const { i18n } = useLingui();\n  const config = useUiConfig();\n\n  return (\n    <Box display=\"flex\">\n      <CssBaseline />\n      <AppBar>\n        <Toolbar>\n          <Box\n            width=\"100%\"\n            display=\"flex\"\n            justifyContent=\"space-between\"\n            alignItems=\"center\"\n          >\n            <Box display=\"flex\" alignItems=\"center\">\n              <Box\n                width={64}\n                height={64}\n                display=\"flex\"\n                justifyContent=\"center\"\n                alignItems=\"center\"\n              >\n                <Logo alt={i18n._(t`Zipkin`)} />\n              </Box>\n              <Title>\n                <strong>Zipkin</strong>\n              </Title>\n              <Box display=\"flex\" ml={3}>\n                <HeaderMenuItem\n                  title={i18n._(t`Find a trace`)}\n                  path=\"/\"\n                  icon={faSearch}\n                />\n                {config.dependency.enabled && (\n                  <HeaderMenuItem\n                    title={i18n._(t`Dependencies`)}\n                    path=\"/dependency\"\n                    icon={faProjectDiagram}\n                  />\n                )}\n              </Box>\n            </Box>\n            <ThemeProvider theme={darkTheme}>\n              <Box display=\"flex\" alignItems=\"center\">\n                <LanguageSelector />\n                <Box mr={2} ml={2}>\n                  <TraceJsonUploader />\n                </Box>\n                <TraceIdSearch />\n                {config.supportUrl && (\n                  <Box ml={1}>\n                    <Tooltip title={i18n._(t`Support`)}>\n                      <MuiIconButton href={config.supportUrl}>\n                        <FontAwesomeIcon icon={faQuestionCircle} />\n                      </MuiIconButton>\n                    </Tooltip>\n                  </Box>\n                )}\n              </Box>\n            </ThemeProvider>\n          </Box>\n        </Toolbar>\n      </AppBar>\n      <Box component=\"main\" width=\"100%\">\n        <ToolbarSpace />\n        {children}\n      </Box>\n    </Box>\n  );\n};\n\nexport default Layout;\n\nconst AppBar = styled(MuiAppBar).attrs({\n  position: 'fixed',\n})`\n  background-color: ${({ theme }) => theme.palette.grey[800]};\n  z-index: 1300;\n`;\n\nconst Toolbar = styled(MuiToolbar)`\n  padding-left: 0;\n`;\n\nconst Logo = styled.img.attrs({\n  src: logoSrc,\n})`\n  width: 42px;\n  height: 42px;\n`;\n\nconst Title = styled(Typography).attrs({\n  variant: 'h5',\n})`\n  margin-left: ${({ theme }) => theme.spacing(2)}px;\n  margin-right: ${({ theme }) => theme.spacing(2)}px;\n`;\n\nconst ToolbarSpace = styled.div`\n  min-height: 64px;\n`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { faSquare, faSearch } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport {\n  Box,\n  Button,\n  Paper,\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableRow,\n  Theme,\n  Typography,\n  createStyles,\n  makeStyles,\n} from '@material-ui/core';\nimport React, { useCallback } from 'react';\nimport { withRouter, RouteComponentProps } from 'react-router-dom';\nimport { PieChart, Pie, Cell, ResponsiveContainer } from 'recharts';\n\nimport Edge from './Edge';\nimport { selectServiceColor } from '../../constants/color';\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    title: {\n      overflowWrap: 'break-word',\n      flexGrow: 1,\n      minWidth: 10, // break-word in flex-box\n    },\n    searchTracesButton: {\n      display: 'flex',\n    },\n    noDataMessage: {\n      opacity: 0.8,\n    },\n    tablePaper: {\n      marginRight: theme.spacing(2),\n      marginLeft: theme.spacing(2),\n      maxHeight: 180,\n      overflowY: 'auto',\n      borderRadius: 3,\n    },\n    tableHeadCell: {\n      top: 0,\n      position: 'sticky',\n      padding: `${theme.spacing(1)}px ${theme.spacing(2)}px`,\n      backgroundColor: theme.palette.grey[200],\n      zIndex: 1,\n    },\n    tableCell: {\n      wordBreak: 'break-all',\n      padding: `${theme.spacing(1)}px ${theme.spacing(2)}px`,\n    },\n  }),\n);\n\ninterface NodeDetailDataProps extends RouteComponentProps {\n  serviceName: string;\n  targetEdges: Edge[];\n  sourceEdges: Edge[];\n}\n\nconst NodeDetailDataImpl: React.FC<NodeDetailDataProps> = ({\n  serviceName,\n  targetEdges,\n  sourceEdges,\n  history,\n}) => {\n  const classes = useStyles();\n\n  const handleSearchTracesButtonClick = useCallback(() => {\n    const params = new URLSearchParams();\n    params.set('serviceName', serviceName);\n    history.push({\n      pathname: '/',\n      search: params.toString(),\n    });\n  }, [serviceName, history]);\n\n  const shownDataList = [] as {\n    title: string;\n    edges: Edge[];\n    selectNodeName: (edge: Edge) => string;\n    formatter: (totalEdges: number) => string;\n  }[];\n  if (targetEdges.length !== 0) {\n    shownDataList.push({\n      title: 'Uses',\n      edges: targetEdges,\n      selectNodeName: (edge: Edge) => edge.target,\n      formatter: (totalEdges: number) =>\n        `This service uses ${totalEdges} service${totalEdges <= 1 ? '' : 's'}`,\n    });\n  }\n  if (sourceEdges.length !== 0) {\n    shownDataList.push({\n      title: 'Used',\n      edges: sourceEdges,\n      selectNodeName: (edge: Edge) => edge.source,\n      formatter: (totalEdges: number) =>\n        `This service is used by ${totalEdges} service${\n          totalEdges <= 1 ? '' : 's'\n        }`,\n    });\n  }\n\n  return (\n    <Box height=\"100%\" display=\"flex\" flexDirection=\"column\">\n      <Box\n        pt={2}\n        pb={1}\n        pr={2}\n        pl={2}\n        bgcolor=\"grey.200\"\n        color=\"text.secondary\"\n        display=\"flex\"\n        justifyContent=\"space-between\"\n      >\n        <Box display=\"flex\" alignItems=\"center\">\n          <Box mr={0.75}>\n            <FontAwesomeIcon\n              icon={faSquare}\n              size=\"lg\"\n              color={selectServiceColor(serviceName)}\n            />\n          </Box>\n          <Typography variant=\"h5\" className={classes.title}>\n            {serviceName}\n          </Typography>\n        </Box>\n        <Button\n          variant=\"outlined\"\n          onClick={handleSearchTracesButtonClick}\n          data-testid=\"search-traces-button\"\n        >\n          <FontAwesomeIcon icon={faSearch} />\n          <Box component=\"span\" ml={0.75}>\n            Traces\n          </Box>\n        </Button>\n      </Box>\n      <Box\n        height={100}\n        flexGrow={1}\n        bgcolor=\"background.paper\"\n        borderColor=\"divider\"\n        borderTop={1}\n        paddingBottom={2}\n        overflow=\"auto\"\n      >\n        {shownDataList.map((d) => (\n          <Box display=\"flex\" flexDirection=\"column\">\n            <Box height={180} position=\"relative\">\n              <Box\n                position=\"absolute\"\n                top={15}\n                left={15}\n                display=\"flex\"\n                alignItems=\"center\"\n              >\n                <Box color=\"text.secondary\">\n                  <Typography variant=\"h6\">{d.title}</Typography>\n                </Box>\n                <Box color=\"text.hint\" ml={1}>\n                  (traced requests)\n                </Box>\n              </Box>\n              <Box position=\"absolute\" bottom={10} right={15}>\n                <Box color=\"text.hint\" ml={1}>\n                  {d.formatter(d.edges.length)}\n                </Box>\n              </Box>\n              <ResponsiveContainer>\n                <PieChart>\n                  <Pie\n                    data={d.edges.map((edge) => ({\n                      name: d.selectNodeName(edge),\n                      value: edge.metrics.normal + edge.metrics.danger,\n                    }))}\n                    nameKey=\"name\"\n                    dataKey=\"value\"\n                    outerRadius={60}\n                  >\n                    {d.edges.map((edge) => (\n                      <Cell\n                        key={d.selectNodeName(edge)}\n                        fill={selectServiceColor(d.selectNodeName(edge))}\n                      />\n                    ))}\n                  </Pie>\n                </PieChart>\n              </ResponsiveContainer>\n            </Box>\n            <Paper className={classes.tablePaper}>\n              <Table>\n                <TableHead>\n                  <TableRow>\n                    <TableCell className={classes.tableHeadCell}>\n                      Service Name\n                    </TableCell>\n                    <TableCell className={classes.tableHeadCell}>\n                      Call\n                    </TableCell>\n                    <TableCell className={classes.tableHeadCell}>\n                      Error\n                    </TableCell>\n                  </TableRow>\n                </TableHead>\n                <TableBody>\n                  {d.edges.map((edge) => (\n                    <TableRow>\n                      <TableCell className={classes.tableCell}>\n                        <FontAwesomeIcon\n                          icon={faSquare}\n                          color={selectServiceColor(d.selectNodeName(edge))}\n                        />\n                        <Box component=\"span\" ml={0.5}>\n                          {d.selectNodeName(edge)}\n                        </Box>\n                      </TableCell>\n                      <TableCell className={classes.tableCell}>\n                        {edge.metrics.normal}\n                      </TableCell>\n                      <TableCell className={classes.tableCell}>\n                        {edge.metrics.danger}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </Paper>\n          </Box>\n        ))}\n      </Box>\n    </Box>\n  );\n};\n\nexport default withRouter(NodeDetailDataImpl);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport React from 'react';\nimport Vizceral from 'vizceral-react';\n\n// Vizceral (vizceral-react) does not release some resources when unmounting the component.\n// Therefore, when Vizceral is mounted many times, rendering speed decreases.\n// So this class inherits Vizceral and overrides componentWillUnmount for releasing resources.\nclass VizceralExt extends Vizceral {\n  componentWillUnmount() {\n    this.vizceral.animate = () => {};\n    delete this.vizceral;\n  }\n}\n\n// This component is defined to avoid the strict type checking.\nconst VizceralWrapper = (props: any) => {\n  return <VizceralExt {...props} />;\n};\n\nexport default VizceralWrapper;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-shadow */\n\nimport {\n  Box,\n  Grid,\n  Theme,\n  createStyles,\n  makeStyles,\n  useTheme,\n} from '@material-ui/core';\nimport moment from 'moment';\nimport React, { CSSProperties, useState, useCallback, useMemo } from 'react';\nimport ReactSelect, { ValueType, ActionMeta } from 'react-select';\nimport { AutoSizer } from 'react-virtualized';\n\nimport Edge from './Edge';\nimport NodeDetailData from './NodeDetailData';\nimport VizceralWrapper from './VizceralWrapper';\nimport Dependencies from '../../models/Dependencies';\n\n// These filter functions use any type because they are passed directly to untyped JS code.\nconst filterConnections = (object: any, value: any) => {\n  if (!value) {\n    return true;\n  }\n  if (object.name === value) {\n    return true;\n  }\n  return object.source.name === value || object.target.name === value;\n};\n\nconst filterNodes = (object: any, value: any) => {\n  if (!value) {\n    return true;\n  }\n  if (object.name === value) {\n    return true;\n  }\n  return (\n    object.incomingConnections.find(\n      (conn: any) => conn.source.name === value,\n    ) ||\n    object.outgoingConnections.find((conn: any) => conn.target.name === value)\n  );\n};\n\n// Export for testing.\nexport const getNodesAndEdges = (dependencies: Dependencies) => {\n  const nodes: { name: string }[] = [];\n  const edges: Edge[] = [];\n\n  dependencies.forEach((edge) => {\n    const nodeNames = nodes.map((node) => node.name);\n\n    if (!nodeNames.includes(edge.parent)) {\n      nodes.push({ name: edge.parent });\n    }\n    if (!nodeNames.includes(edge.child)) {\n      nodes.push({ name: edge.child });\n    }\n\n    edges.push({\n      source: edge.parent,\n      target: edge.child,\n      metrics: {\n        normal: edge.callCount || 0,\n        danger: edge.errorCount || 0,\n      },\n    });\n  });\n  return { nodes, edges };\n};\n\n// IntelliJ may miss on \"Unused property\" analysis. Double-check here as we don't test CSS:\n// https://github.com/JedWatson/react-select/blob/cba15309c4d7523ab6a785c8d5c0c7ec1048e22f/packages/react-select/src/styles.js#L38-L61\nconst reactSelectStyles = {\n  control: (base: CSSProperties) => ({\n    ...base,\n    width: '15rem',\n  }),\n  option: (base: CSSProperties) => ({\n    ...base,\n    cursor: 'pointer',\n  }),\n  clearIndicator: (base: CSSProperties) => ({\n    ...base,\n    cursor: 'pointer',\n  }),\n  dropdownIndicator: (base: CSSProperties) => ({\n    ...base,\n    cursor: 'pointer',\n  }),\n};\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    containerGrid: {\n      height: '100%',\n    },\n    graphItemGrid: {\n      height: '100%',\n    },\n    nodeDetailDataItemGrid: {\n      height: '100%',\n      boxShadow: theme.shadows[10],\n      zIndex: 1,\n    },\n    vizceralWrapper: {\n      // In Firefox, 100% height does not work...\n      '& .vizceral': {\n        height: '99%',\n      },\n    },\n  }),\n);\n\ninterface DependenciesGraphProps {\n  dependencies: Dependencies;\n}\n\nconst DependenciesGraph: React.FC<DependenciesGraphProps> = ({\n  dependencies,\n}) => {\n  const classes = useStyles();\n  const theme = useTheme();\n  const vizStyle = {\n    colorText: theme.palette.primary.contrastText,\n    colorTextDisabled: theme.palette.primary.contrastText,\n    colorConnectionLine: theme.palette.grey[800],\n    colorTraffic: {\n      normal: theme.palette.primary.dark,\n      warning: theme.palette.secondary.dark,\n      danger: theme.palette.secondary.dark,\n    },\n    colorDonutInternalColor: theme.palette.primary.light,\n    colorDonutInternalColorHighlighted: theme.palette.primary.light,\n    colorLabelBorder: theme.palette.primary.dark,\n    colorLabelText: theme.palette.primary.contrastText,\n    colorTrafficHighlighted: {\n      normal: theme.palette.primary.main,\n    },\n  };\n\n  const [focusedNodeName, setFocusedNodeName] = useState('');\n\n  const [filter, setFilter] = useState('');\n  const handleFilterChange = useCallback(\n    (\n      selected: ValueType<{ value: string }>,\n      actionMeta: ActionMeta<{ value: string; label: string }>,\n    ) => {\n      setFocusedNodeName('');\n      if (actionMeta.action === 'clear') {\n        setFilter('');\n        return;\n      }\n      if (actionMeta.action === 'select-option') {\n        if (selected && 'value' in selected /* Type refinement */) {\n          setFilter(selected.value);\n        }\n      }\n    },\n    [],\n  );\n\n  const { nodes, edges, createdTs } = useMemo(() => {\n    const { nodes, edges } = getNodesAndEdges(dependencies);\n    return {\n      nodes,\n      edges,\n      createdTs: moment().valueOf(),\n    };\n  }, [dependencies]);\n\n  const targetEdges = useMemo(() => {\n    if (focusedNodeName) {\n      return edges.filter((edge) => edge.source === focusedNodeName);\n    }\n    return [];\n  }, [edges, focusedNodeName]);\n\n  const sourceEdges = useMemo(() => {\n    if (focusedNodeName) {\n      return edges.filter((edge) => edge.target === focusedNodeName);\n    }\n    return [];\n  }, [edges, focusedNodeName]);\n\n  // These filter functions use any type because they are passed directly to untyped JS code.\n  const handleObjectHighlight = useCallback(\n    (highlightedObject?: any) => {\n      if (!highlightedObject) {\n        setFocusedNodeName('');\n        return;\n      }\n      if (\n        highlightedObject.type === 'node' &&\n        highlightedObject.getName() !== focusedNodeName\n      ) {\n        setFocusedNodeName(highlightedObject.getName());\n      }\n    },\n    [focusedNodeName],\n  );\n\n  const maxVolume = useMemo(() => {\n    if (edges.length > 0) {\n      return edges\n        .map((edge) => edge.metrics.normal + edge.metrics.danger)\n        .reduce((a, b) => Math.max(a, b));\n    }\n    return 0;\n  }, [edges]);\n\n  const filterOptions = useMemo(\n    () =>\n      nodes\n        .map((node) => ({\n          value: node.name,\n          label: node.name,\n        }))\n        .sort((a, b) => a.value.localeCompare(b.value)),\n    [nodes],\n  );\n\n  return (\n    <Box width=\"100%\" height=\"100%\" data-testid=\"dependencies-graph\">\n      <Grid container className={classes.containerGrid}>\n        <Grid\n          item\n          xs={focusedNodeName ? 7 : 12}\n          className={classes.graphItemGrid}\n        >\n          <AutoSizer>\n            {({ width, height }) => (\n              <Box\n                width={width}\n                height={height}\n                position=\"relative\"\n                className={classes.vizceralWrapper}\n              >\n                <VizceralWrapper\n                  allowDraggingOfNodes\n                  targetFramerate={30}\n                  traffic={{\n                    renderer: 'region',\n                    layout: 'ltrTree',\n                    name: 'dependencies-graph',\n                    maxVolume: maxVolume * 50,\n                    nodes,\n                    connections: edges,\n                    updated: createdTs,\n                  }}\n                  objectHighlighted={handleObjectHighlight}\n                  styles={vizStyle}\n                  key={\n                    // Normally, when updating filters, Vizsceral will show and hide nodes without relaying\n                    // them out. For a large dependency graph, this often won't let us see well the\n                    // information about the filtered nodes, so we prefer to force a relayout any time we\n                    // update the filter. Changing the key based on the filter like this causes react to\n                    // destroy and reconstruct the component from scratch, which will have a layout zooming\n                    // in on the filtered nodes.\n                    filter\n                  }\n                  filters={[\n                    {\n                      name: 'shownConnections',\n                      type: 'connection',\n                      passes: filterConnections,\n                      value: filter,\n                    },\n                    {\n                      name: 'shownNodes',\n                      type: 'node',\n                      passes: filterNodes,\n                      value: filter,\n                    },\n                  ]}\n                />\n              </Box>\n            )}\n          </AutoSizer>\n          <Box position=\"absolute\" left={30} top={30}>\n            <ReactSelect\n              isClearable\n              options={filterOptions}\n              onChange={handleFilterChange}\n              value={!filter ? undefined : { value: filter, label: filter }}\n              styles={reactSelectStyles}\n            />\n          </Box>\n        </Grid>\n        {focusedNodeName ? (\n          <Grid item xs={5} className={classes.nodeDetailDataItemGrid}>\n            <NodeDetailData\n              serviceName={focusedNodeName}\n              targetEdges={targetEdges}\n              sourceEdges={sourceEdges}\n            />\n          </Grid>\n        ) : null}\n      </Grid>\n    </Box>\n  );\n};\n\nexport default DependenciesGraph;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { IconDefinition } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { Box, Typography } from '@material-ui/core';\nimport React from 'react';\n\ninterface ExplainBoxProps {\n  icon: IconDefinition;\n  headerText: React.ReactNode;\n  text: React.ReactNode;\n}\n\nconst ExplainBox = React.memo<ExplainBoxProps>(({ icon, headerText, text }) => {\n  return (\n    <Box\n      top={64}\n      left={0}\n      right={0}\n      bottom={0}\n      position=\"fixed\"\n      display=\"flex\"\n      alignItems=\"center\"\n      justifyContent=\"center\"\n      flexDirection=\"column\"\n      color=\"text.secondary\"\n      zIndex={-1}\n    >\n      <FontAwesomeIcon icon={icon} size=\"10x\" />\n      <Box mt={3} mb={2}>\n        <Typography variant=\"h4\">{headerText}</Typography>\n      </Box>\n      <Typography variant=\"body1\">{text}</Typography>\n    </Box>\n  );\n});\n\nexport default ExplainBox;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\nimport Dependencies from '../models/Dependencies';\n\nexport const loadDependencies = createAsyncThunk(\n  'dependencies/fetch',\n  async (params: { lookback?: number; endTs: number }) => {\n    const ps = new URLSearchParams();\n    if (params.lookback) {\n      ps.set('lookback', params.lookback.toString());\n    }\n    ps.set('endTs', params.endTs.toString());\n\n    const resp = await fetch(`${api.DEPENDENCIES}?${ps.toString()}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const json = await resp.json();\n    return json as Dependencies;\n  },\n);\n\nexport interface DependenciesState {\n  isLoading: boolean;\n  dependencies: Dependencies;\n  error?: SerializedError;\n}\n\nconst initialState: DependenciesState = {\n  isLoading: false,\n  dependencies: [],\n  error: undefined,\n};\n\nconst dependenciesSlice = createSlice({\n  name: 'dependencies',\n  initialState,\n  reducers: {\n    clearDependencies: (state) => {\n      state.isLoading = false;\n      state.dependencies = [];\n      state.error = undefined;\n    },\n  },\n  extraReducers: (builder) => {\n    builder.addCase(loadDependencies.pending, (state) => {\n      state.isLoading = true;\n      state.dependencies = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadDependencies.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.dependencies = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadDependencies.rejected, (state, action) => {\n      state.isLoading = false;\n      state.dependencies = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport const { clearDependencies } = dependenciesSlice.actions;\n\nexport default dependenciesSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { Box, useTheme } from '@material-ui/core';\nimport React from 'react';\nimport { ScaleLoader } from 'react-spinners';\n\nexport const LoadingIndicator: React.FC = () => {\n  const theme = useTheme();\n\n  return (\n    <Box\n      display=\"flex\"\n      justifyContent=\"center\"\n      mt={10}\n      mb={10}\n      data-testid=\"loading-indicator\"\n    >\n      <ScaleLoader color={theme.palette.primary.light} />\n    </Box>\n  );\n};\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { faSearch, faProjectDiagram } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { t, Trans } from '@lingui/macro';\nimport { useLingui } from '@lingui/react';\nimport {\n  Box,\n  Button,\n  Theme,\n  createStyles,\n  makeStyles,\n} from '@material-ui/core';\nimport { KeyboardDateTimePicker } from '@material-ui/pickers';\nimport { MaterialUiPickersDate } from '@material-ui/pickers/typings/date';\nimport { History, Location } from 'history';\nimport moment from 'moment';\nimport React, { useEffect, useState, useCallback, useMemo } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { withRouter, RouteComponentProps } from 'react-router-dom';\n\nimport DependenciesGraph from './DependenciesGraph';\nimport { clearAlert, setAlert } from '../App/slice';\nimport ExplainBox from '../common/ExplainBox';\nimport {\n  clearDependencies,\n  loadDependencies,\n} from '../../slices/dependenciesSlice';\nimport { RootState } from '../../store';\nimport { LoadingIndicator } from '../common/LoadingIndicator';\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    dateTimePicker: {\n      marginLeft: theme.spacing(1),\n      marginRight: theme.spacing(1),\n    },\n    dateTimePickerInput: {\n      fontSize: '1rem',\n      height: '1.8rem',\n      padding: `${theme.spacing(0.4)}px ${theme.spacing(0.6)}px`,\n    },\n    searchButton: {\n      fontSize: '1.2rem',\n      padding: theme.spacing(1),\n      minWidth: 0,\n      width: 32,\n      height: 32,\n    },\n  }),\n);\n\ninterface DependenciesPageProps extends RouteComponentProps {}\n\nconst useTimeRange = (history: History, location: Location) => {\n  const setTimeRange = useCallback(\n    (timeRange: { startTime: moment.Moment; endTime: moment.Moment }) => {\n      const ps = new URLSearchParams(location.search);\n      ps.set('startTime', timeRange.startTime.valueOf().toString());\n      ps.set('endTime', timeRange.endTime.valueOf().toString());\n      history.push({\n        pathname: location.pathname,\n        search: ps.toString(),\n      });\n    },\n    [history, location.pathname, location.search],\n  );\n\n  const timeRange = useMemo(() => {\n    const ps = new URLSearchParams(location.search);\n    const startTimeStr = ps.get('startTime');\n    let startTime;\n    if (startTimeStr) {\n      startTime = moment(parseInt(startTimeStr, 10));\n    }\n\n    const endTimeStr = ps.get('endTime');\n    let endTime;\n    if (endTimeStr) {\n      endTime = moment(parseInt(endTimeStr, 10));\n    }\n\n    return {\n      startTime,\n      endTime,\n    };\n  }, [location.search]);\n\n  return { timeRange, setTimeRange };\n};\n\nconst useFetchDependencies = (timeRange: {\n  startTime?: moment.Moment;\n  endTime?: moment.Moment;\n}) => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    if (!timeRange.startTime || !timeRange.endTime) {\n      dispatch(clearDependencies());\n      return;\n    }\n    const lookback = timeRange.endTime.diff(timeRange.startTime);\n    dispatch(\n      loadDependencies({ lookback, endTs: timeRange.endTime.valueOf() }),\n    );\n  }, [dispatch, timeRange.endTime, timeRange.startTime]);\n};\n\nconst DependenciesPageImpl: React.FC<DependenciesPageProps> = ({\n  history,\n  location,\n}) => {\n  const classes = useStyles();\n  const { i18n } = useLingui();\n  const dispatch = useDispatch();\n\n  // tempTimeRange manages a time range which is inputted in the form.\n  // On the other hand, timeRange is a time range obtained from the URL search params.\n  const { timeRange, setTimeRange } = useTimeRange(history, location);\n  const [tempTimeRange, setTempTimeRange] = useState({\n    startTime: timeRange.startTime\n      ? timeRange.startTime\n      : moment().subtract({ days: 1 }),\n    endTime: timeRange.endTime ? timeRange.endTime : moment(),\n  });\n  useFetchDependencies(timeRange);\n\n  const { isLoading, dependencies, error } = useSelector(\n    (state: RootState) => state.dependencies,\n  );\n\n  useEffect(() => {\n    if (error) {\n      dispatch(\n        setAlert({\n          message: 'Failed to load dependencies...',\n          severity: 'error',\n        }),\n      );\n    } else {\n      dispatch(clearAlert());\n    }\n  }, [error, dispatch]);\n\n  const handleStartTimeChange = useCallback(\n    (startTime: MaterialUiPickersDate) => {\n      if (startTime) {\n        setTempTimeRange({ ...tempTimeRange, startTime });\n      }\n    },\n    [tempTimeRange],\n  );\n\n  const handleEndTimeChange = useCallback(\n    (endTime: MaterialUiPickersDate) => {\n      if (endTime) {\n        setTempTimeRange({ ...tempTimeRange, endTime });\n      }\n    },\n    [tempTimeRange],\n  );\n\n  const handleSearchButtonClick = useCallback(() => {\n    setTimeRange(tempTimeRange);\n  }, [setTimeRange, tempTimeRange]);\n\n  useEffect(() => {\n    return () => {\n      dispatch(clearDependencies());\n    };\n  }, [dispatch]);\n\n  let content: JSX.Element;\n  if (isLoading) {\n    content = <LoadingIndicator />;\n  } else if (dependencies.length > 0) {\n    content = <DependenciesGraph dependencies={dependencies} />;\n  } else {\n    content = (\n      <ExplainBox\n        icon={faProjectDiagram}\n        headerText={<Trans>Search Dependencies</Trans>}\n        text={\n          <Trans>\n            Please select the start and end time. Then, click the search button.\n          </Trans>\n        }\n      />\n    );\n  }\n\n  return (\n    <Box\n      width=\"100%\"\n      height=\"calc(100vh - 64px)\"\n      display=\"flex\"\n      flexDirection=\"column\"\n    >\n      <Box bgcolor=\"background.paper\" boxShadow={3} p={3}>\n        <Box display=\"flex\" justifyContent=\"center\" alignItems=\"center\">\n          <KeyboardDateTimePicker\n            label={i18n._(t`Start Time`)}\n            inputVariant=\"outlined\"\n            value={tempTimeRange.startTime}\n            onChange={handleStartTimeChange}\n            format=\"MM/DD/YYYY HH:mm:ss\"\n            className={classes.dateTimePicker}\n            InputProps={{ classes: { input: classes.dateTimePickerInput } }}\n          />\n          -\n          <KeyboardDateTimePicker\n            label={i18n._(t`End Time`)}\n            inputVariant=\"outlined\"\n            value={tempTimeRange.endTime}\n            onChange={handleEndTimeChange}\n            format=\"MM/DD/YYYY HH:mm:ss\"\n            className={classes.dateTimePicker}\n            InputProps={{ classes: { input: classes.dateTimePickerInput } }}\n          />\n          <Button\n            color=\"primary\"\n            variant=\"contained\"\n            onClick={handleSearchButtonClick}\n            className={classes.searchButton}\n            data-testid=\"search-button\"\n          >\n            <FontAwesomeIcon icon={faSearch} />\n          </Button>\n        </Box>\n      </Box>\n      <Box m={4} flexGrow={1}>\n        {content}\n      </Box>\n    </Box>\n  );\n};\n\nexport default withRouter(DependenciesPageImpl);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport shortid from 'shortid';\n\ntype Criterion = {\n  key: string;\n  value: string;\n  id: string; // for React key props.\n};\n\nexport const newCriterion = (key: string = '', value: string = '') => {\n  return {\n    key,\n    value,\n    id: shortid.generate(),\n  };\n};\n\nexport default Criterion;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport moment from 'moment';\n\nexport type FixedLookbackValue =\n  | '1m'\n  | '5m'\n  | '15m'\n  | '30m'\n  | '1h'\n  | '2h'\n  | '3h'\n  | '6h'\n  | '12h'\n  | '1d'\n  | '2d'\n  | '7d';\n\nexport const millisecondsToValue: { [key: number]: FixedLookbackValue } = {\n  [60 * 1000]: '1m',\n  [60 * 1000 * 5]: '5m',\n  [60 * 1000 * 15]: '15m',\n  [60 * 1000 * 30]: '30m',\n  [60 * 1000 * 60]: '1h',\n  [60 * 1000 * 60 * 2]: '2h',\n  [60 * 1000 * 60 * 3]: '3h',\n  [60 * 1000 * 60 * 6]: '6h',\n  [60 * 1000 * 60 * 12]: '12h',\n  [60 * 1000 * 60 * 24]: '1d',\n  [60 * 1000 * 60 * 24 * 2]: '2d',\n  [60 * 1000 * 60 * 24 * 7]: '7d',\n};\n\nexport interface FixedLookback {\n  type: 'fixed';\n  value: FixedLookbackValue;\n  endTime: moment.Moment;\n}\n\nexport interface RangeLookback {\n  type: 'range';\n  startTime: moment.Moment;\n  endTime: moment.Moment;\n}\n\nexport interface MillisLookback {\n  type: 'millis';\n  value: number;\n  endTime: moment.Moment;\n}\n\nexport type Lookback = FixedLookback | RangeLookback | MillisLookback;\n\ninterface FixedLookbackEntry {\n  duration: moment.Duration;\n  value: FixedLookbackValue;\n  display: string;\n}\n\nexport const fixedLookbacks: Array<FixedLookbackEntry> = [\n  {\n    duration: moment.duration({ minutes: 1 }),\n    value: '1m',\n    display: 'Last 1 minute',\n  },\n  {\n    duration: moment.duration({ minutes: 5 }),\n    value: '5m',\n    display: 'Last 5 minutes',\n  },\n  {\n    duration: moment.duration({ minutes: 15 }),\n    value: '15m',\n    display: 'Last 15 minutes',\n  },\n  {\n    duration: moment.duration({ minutes: 30 }),\n    value: '30m',\n    display: 'Last 30 minutes',\n  },\n  {\n    duration: moment.duration({ hours: 1 }),\n    value: '1h',\n    display: 'Last 1 hour',\n  },\n  {\n    duration: moment.duration({ hours: 2 }),\n    value: '2h',\n    display: 'Last 2 hours',\n  },\n  {\n    duration: moment.duration({ hours: 3 }),\n    value: '3h',\n    display: 'Last 3 hours',\n  },\n  {\n    duration: moment.duration({ hours: 6 }),\n    value: '6h',\n    display: 'Last 6 hours',\n  },\n  {\n    duration: moment.duration({ hours: 12 }),\n    value: '12h',\n    display: 'Last 12 hours',\n  },\n  {\n    duration: moment.duration({ days: 1 }),\n    value: '1d',\n    display: 'Last 1 day',\n  },\n  {\n    duration: moment.duration({ days: 2 }),\n    value: '2d',\n    display: 'Last 2 days',\n  },\n  {\n    duration: moment.duration({ days: 7 }),\n    value: '7d',\n    display: 'Last 7 days',\n  },\n];\n\nexport const fixedLookbackMap = fixedLookbacks.reduce((acc, cur) => {\n  acc[cur.value] = cur;\n  return acc;\n}, {} as { [key: string]: FixedLookbackEntry });\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport {\n  Box,\n  Button,\n  ClickAwayListener,\n  Grid,\n  List,\n  ListItem,\n  ListItemText,\n  Paper,\n  TextField,\n  Theme,\n  createStyles,\n  makeStyles,\n} from '@material-ui/core';\nimport { KeyboardDateTimePicker } from '@material-ui/pickers';\nimport { MaterialUiPickersDate } from '@material-ui/pickers/typings/date';\nimport moment, { Moment } from 'moment';\nimport React, { useCallback, useState } from 'react';\n\nimport { fixedLookbackMap, FixedLookbackValue, Lookback } from './lookback';\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    root: {\n      position: 'absolute',\n      top: 45,\n      right: 0,\n      height: 420,\n      width: 600,\n      zIndex: theme.zIndex.modal,\n    },\n    containerGrid: {\n      height: '100%',\n    },\n    fixedLookbackItemGrid: {\n      height: '100%',\n      overflowY: 'auto',\n      borderRight: `1px solid ${theme.palette.divider}`,\n    },\n    list: {\n      padding: 0,\n    },\n  }),\n);\n\ninterface LookbackMenuProps {\n  close: () => void;\n  onChange: (lookback: Lookback) => void;\n  lookback: Lookback;\n}\n\nconst initialMillis = (lookback: Lookback): number => {\n  if (lookback.type === 'millis') {\n    return lookback.value;\n  }\n  return 0;\n};\n\nconst initialStartTime = (lookback: Lookback): Moment => {\n  if (lookback.type === 'range') {\n    return lookback.startTime;\n  }\n  return moment().subtract(1, 'h');\n};\n\nconst initialEndTime = (lookback: Lookback): Moment => {\n  if (lookback.type === 'range') {\n    return lookback.endTime;\n  }\n  return moment();\n};\n\nconst LookbackMenu: React.FC<LookbackMenuProps> = ({\n  close,\n  onChange,\n  lookback,\n}) => {\n  const classes = useStyles();\n\n  // LookbackMenu is closed when click on the outside of the component.\n  // This state is needed to prevent LookbackMenu component from closing\n  // when the dialog of DateTimePicker is clicked.\n  const [isOpeningDialog, setIsOpeningDialog] = useState(false);\n\n  const handleDialogOpen = useCallback(() => {\n    setIsOpeningDialog(true);\n  }, []);\n\n  const handleDialogClose = useCallback(() => {\n    setIsOpeningDialog(false);\n  }, []);\n\n  const handleOutsideClick = useCallback(() => {\n    if (!isOpeningDialog) {\n      close();\n    }\n  }, [close, isOpeningDialog]);\n\n  // For Millis Lookback\n  const [millis, setMillis] = useState(initialMillis(lookback));\n  // Range Lookback\n  const [startTime, setStartTime] = useState(initialStartTime(lookback));\n  const [endTime, setEndTime] = useState(initialEndTime(lookback));\n\n  const handleMillisChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      setMillis(parseInt(event.target.value, 10));\n    },\n    [],\n  );\n\n  const handleStartTimeChange = useCallback((date: MaterialUiPickersDate) => {\n    if (date) {\n      setStartTime(date);\n    }\n  }, []);\n\n  const handleEndTimeChange = useCallback((date: MaterialUiPickersDate) => {\n    if (date) {\n      setEndTime(date);\n    }\n  }, []);\n\n  const handleListItemClick = (value: FixedLookbackValue) => () => {\n    onChange({\n      type: 'fixed',\n      value,\n      endTime: moment(),\n    });\n    close();\n  };\n\n  const handleMillisApplyButtonClick = useCallback(() => {\n    onChange({\n      type: 'millis',\n      endTime: moment(),\n      value: millis,\n    });\n    close();\n  }, [close, millis, onChange]);\n\n  const handleRangeApplyButtonClick = useCallback(() => {\n    onChange({\n      type: 'range',\n      startTime,\n      endTime,\n    });\n    close();\n  }, [startTime, endTime, onChange, close]);\n\n  return (\n    <ClickAwayListener onClickAway={handleOutsideClick}>\n      <Paper elevation={5} className={classes.root}>\n        <Grid container className={classes.containerGrid}>\n          <Grid item xs={5} className={classes.fixedLookbackItemGrid}>\n            <List className={classes.list}>\n              {([\n                '1m',\n                '5m',\n                '15m',\n                '30m',\n                '1h',\n                '2h',\n                '3h',\n                '6h',\n                '12h',\n                '1d',\n                '2d',\n                '7d',\n              ] as FixedLookbackValue[]).map((value) => (\n                <ListItem\n                  button\n                  onClick={handleListItemClick(value)}\n                  key={value}\n                  data-testid={`lookback-${value}`}\n                >\n                  <ListItemText primary={fixedLookbackMap[value].display} />\n                </ListItem>\n              ))}\n            </List>\n          </Grid>\n          <Grid item xs={7}>\n            <Box p={2}>\n              <Box fontSize=\"1.1rem\" color=\"text.secondary\" mb={2}>\n                Millis Lookback\n              </Box>\n              <TextField\n                label=\"Milliseconds\"\n                onChange={handleMillisChange}\n                value={millis.toString()}\n                variant=\"outlined\"\n                size=\"small\"\n                type=\"number\"\n                inputProps={{\n                  min: '0',\n                  'data-testid': 'millis-input',\n                }}\n              />\n              <Box display=\"flex\" justifyContent=\"flex-end\" mt={1}>\n                <Button\n                  variant=\"contained\"\n                  color=\"secondary\"\n                  onClick={handleMillisApplyButtonClick}\n                  data-testid=\"millis-apply-button\"\n                >\n                  Apply\n                </Button>\n              </Box>\n            </Box>\n            <Box p={2} borderTop={1} borderColor=\"divider\">\n              <Box fontSize=\"1.1rem\" color=\"text.secondary\" mb={2}>\n                Range Lookback\n              </Box>\n              <Box mb={2}>\n                <KeyboardDateTimePicker\n                  label=\"Start Time\"\n                  inputVariant=\"outlined\"\n                  format=\"MM/DD/YYYY HH:mm:ss\"\n                  value={startTime}\n                  onChange={handleStartTimeChange}\n                  onOpen={handleDialogOpen}\n                  onClose={handleDialogClose}\n                  data-testid=\"date-time-picker\"\n                  size=\"small\"\n                  fullWidth\n                />\n              </Box>\n              <Box mb={2}>\n                <KeyboardDateTimePicker\n                  label=\"End Time\"\n                  inputVariant=\"outlined\"\n                  format=\"MM/DD/YYYY HH:mm:ss\"\n                  value={endTime}\n                  onChange={handleEndTimeChange}\n                  onOpen={handleDialogOpen}\n                  onClose={handleDialogClose}\n                  data-testid=\"date-time-picker\"\n                  size=\"small\"\n                  fullWidth\n                />\n              </Box>\n              <Box display=\"flex\" justifyContent=\"flex-end\">\n                <Button\n                  variant=\"contained\"\n                  color=\"secondary\"\n                  onClick={handleRangeApplyButtonClick}\n                  data-testid=\"apply-button\"\n                >\n                  Apply\n                </Button>\n              </Box>\n            </Box>\n          </Grid>\n        </Grid>\n      </Paper>\n    </ClickAwayListener>\n  );\n};\n\nexport default LookbackMenu;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { Typography } from '@material-ui/core';\nimport React from 'react';\nimport styled from 'styled-components';\n\nconst Root = styled.div`\n  position: absolute;\n  top: 45px;\n  left: 0px;\n  right: 0px;\n  border-radius: 1px;\n  background-color: ${({ theme }) => theme.palette.background.paper};\n  box-shadow: ${({ theme }) => theme.shadows[3]};\n  max-height: 300px;\n  overflow: auto;\n  z-index: ${({ theme }) => theme.zIndex.modal};\n  padding: ${({ theme }) => theme.spacing(1)}px;\n`;\n\nconst Code = styled.code`\n  padding: 2px;\n  background-color: ${({ theme }) => theme.palette.grey[100]};\n  border: 1px solid ${({ theme }) => theme.palette.grey[300]};\n  border-radius: 3px;\n  box-sizing: border-box;\n  display: inline-block;\n  font-family: monospace;\n`;\n\nconst ExampleList = styled.ul`\n  margin-block-start: ${({ theme }) => theme.spacing(0.5)}px;\n  margin-block-end: ${({ theme }) => theme.spacing(0.5)}px;\n`;\n\nconst ExampleListItem = styled.li`\n  padding-top: 2px;\n  padding-bottom: 2px;\n`;\n\ninterface HowToUseProps {\n  target: 'minDuration' | 'maxDuration' | 'tagQuery';\n}\n\nconst HowToUse: React.FC<HowToUseProps> = ({ target }) => {\n  let content;\n\n  switch (target) {\n    case 'minDuration':\n    case 'maxDuration':\n      content = (\n        <>\n          <Typography variant=\"h6\">Examples</Typography>\n          <ExampleList>\n            <ExampleListItem>\n              <Code>{target}=10s</Code>\n              &nbsp;(Seconds)\n            </ExampleListItem>\n            <ExampleListItem>\n              <Code>{target}=10ms</Code>\n              &nbsp;(Milliseconds)\n            </ExampleListItem>\n            <ExampleListItem>\n              <Code>{target}=10us</Code>\n              &nbsp;(Microseconds)\n            </ExampleListItem>\n          </ExampleList>\n          If no units are specified, the number is treated as <Code>us</Code>.\n          <Code>{target}=10</Code> is the same as <Code>{target}=10us</Code>.\n        </>\n      );\n      break;\n    case 'tagQuery':\n      content = (\n        <>\n          Limit results to traces that include one or more tags. Tags are only\n          searchable by their exact value. Use <Code> and </Code> to combine\n          terms.\n          <Code> or </Code> is not supported.\n          <Typography variant=\"h6\">Example</Typography>\n          <ExampleList>\n            <ExampleListItem>\n              <Code>tagQuery=error and http.method=POST</Code>\n            </ExampleListItem>\n          </ExampleList>\n        </>\n      );\n      break;\n    default:\n      break;\n  }\n\n  return <Root>{content}</Root>;\n};\n\nexport default HowToUse;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { CircularProgress } from '@material-ui/core';\nimport React, { useEffect, useRef } from 'react';\nimport styled from 'styled-components';\n\nconst Root = styled.div<{ isLoading: boolean }>`\n  position: absolute;\n  top: 45px;\n  left: 0px;\n  right: 0px;\n  border-radius: 1px;\n  background-color: ${({ theme }) => theme.palette.background.paper};\n  box-shadow: ${({ theme }) => theme.shadows[3]};\n  max-height: 300px;\n  overflow: auto;\n  z-index: ${({ theme }) => theme.zIndex.modal};\n\n  ${({ isLoading, theme }) =>\n    !isLoading\n      ? ''\n      : `\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: ${theme.spacing(1)}px;\n      `}\n`;\n\nconst List = styled.ul`\n  list-style-type: none;\n  margin: 0px;\n  padding: 0px;\n  font-size: 1.1rem;\n`;\n\nconst ListItem = styled.li<{ isFocused: boolean }>`\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-right: 12px;\n  padding-left: 12px;\n  border-left: ${({ isFocused, theme }) =>\n    `5px solid ${isFocused ? theme.palette.primary.main : 'rgba(0, 0, 0, 0)'}`};\n  cursor: pointer;\n  &:hover {\n    background-color: ${({ theme }) => theme.palette.grey[300]};\n  }\n`;\n\ninterface SuggestionListProps {\n  suggestions: string[];\n  isLoadingSuggestions: boolean;\n  suggestionIndex: number;\n  onItemClick: (index: number) => () => void;\n}\n\nconst SuggestionList: React.FC<SuggestionListProps> = ({\n  suggestions,\n  isLoadingSuggestions,\n  suggestionIndex,\n  onItemClick,\n}) => {\n  const listEls = useRef<HTMLLIElement[]>([]);\n  const setListEl = (index: number) => (el: HTMLLIElement) => {\n    listEls.current[index] = el;\n  };\n\n  useEffect(() => {\n    if (suggestionIndex === -1) {\n      return;\n    }\n    listEls.current[suggestionIndex].scrollIntoView(false);\n  }, [suggestionIndex]);\n\n  if (isLoadingSuggestions) {\n    return (\n      <Root isLoading>\n        <CircularProgress size={20} />\n      </Root>\n    );\n  }\n\n  return (\n    <Root isLoading={false}>\n      <List>\n        {suggestions.map((suggestion, index) => (\n          <ListItem\n            key={suggestion}\n            ref={setListEl(index)}\n            isFocused={suggestionIndex === index}\n            onClick={onItemClick(index)}\n          >\n            {suggestion}\n          </ListItem>\n        ))}\n      </List>\n    </Root>\n  );\n};\n\nexport default SuggestionList;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-shadow */\n\nimport { faTimes } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { Box, ClickAwayListener } from '@material-ui/core';\nimport React, {\n  useCallback,\n  useEffect,\n  useLayoutEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport { useMount } from 'react-use';\nimport styled, { keyframes } from 'styled-components';\n\nimport HowToUse from './HowToUse';\nimport SuggestionList from './SuggestionList';\nimport Criterion, { newCriterion } from '../Criterion';\n\nconst fadeIn = keyframes`\n  0% { opacity: 0 }\n  30% { opacity: 0.1 }\n  70% { opacity: 0.9 }\n  100% { opacity: 1 }\n`;\n\nconst Root = styled(Box)`\n  display: flex;\n  height: 40px;\n  border-radius: 3px;\n  box-shadow: ${({ theme }) => theme.shadows[1]};\n  overflow: hidden;\n  margin-right: ${({ theme }) => theme.spacing(1)}px;\n  font-size: 1.1rem;\n  color: ${({ theme }) => theme.palette.common.white};\n  cursor: pointer;\n  & > *:hover {\n    opacity: 0.9;\n  }\n  animation: 0.25s 0s both ${fadeIn};\n`;\n\nconst FocusedRoot = styled(Box)`\n  margin-right: ${({ theme }) => theme.spacing(2)}px;\n  position: relative;\n  animation: 0.25s 0s both ${fadeIn};\n  z-index: ${({ theme }) => theme.zIndex.modal};\n`;\n\nconst DeleteButton = styled.button`\n  height: 100%;\n  width: 30;\n  color: ${({ theme }) => theme.palette.common.white};\n  background-color: ${({ theme }) => theme.palette.primary.main};\n  cursor: pointer;\n  border: none;\n  &:focus {\n    outline: none;\n  }\n`;\n\nconst Input = styled.input.attrs(() => ({\n  'data-testid': 'criterion-input',\n}))`\n  width: 350px;\n  height: 40px;\n  padding: 10px;\n  box-sizing: border-box;\n  font-size: 1.1rem;\n`;\n\ninterface CriterionBoxProps {\n  criteria: Criterion[];\n  criterion: Criterion;\n  criterionIndex: number;\n  serviceNames: string[];\n  remoteServiceNames: string[];\n  spanNames: string[];\n  autocompleteKeys: string[];\n  autocompleteValues: string[];\n  isLoadingServiceNames: boolean;\n  isLoadingRemoteServiceNames: boolean;\n  isLoadingSpanNames: boolean;\n  isLoadingAutocompleteValues: boolean;\n  isFocused: boolean;\n  onFocus: (index: number) => void;\n  onBlur: () => void;\n  onDecide: (index: number) => void;\n  onChange: (index: number, criterion: Criterion) => void;\n  onDelete: (index: number) => void;\n  loadAutocompleteValues: (autocompleteKey: string) => void;\n}\n\nconst initialText = (criterion: Criterion) => {\n  if (criterion.key) {\n    if (criterion.value) {\n      return `${criterion.key}=${criterion.value}`;\n    }\n    return `${criterion.key}=`;\n  }\n  return '';\n};\n\nconst CriterionBox: React.FC<CriterionBoxProps> = ({\n  criteria,\n  criterion,\n  criterionIndex,\n  serviceNames,\n  remoteServiceNames,\n  spanNames,\n  autocompleteKeys,\n  autocompleteValues,\n  isLoadingServiceNames,\n  isLoadingRemoteServiceNames,\n  isLoadingSpanNames,\n  isLoadingAutocompleteValues,\n  isFocused,\n  onFocus,\n  onBlur,\n  onDecide,\n  onChange,\n  onDelete,\n  loadAutocompleteValues,\n}) => {\n  const inputEl = useRef<HTMLInputElement>(null);\n\n  const [text, setText] = useState(initialText(criterion));\n  const [fixedText, setFixedText] = useState(initialText(criterion));\n\n  useMount(() => {\n    if (inputEl.current) {\n      inputEl.current.focus();\n    }\n  });\n\n  const prevIsFocused = useRef(isFocused);\n  useLayoutEffect(() => {\n    if (prevIsFocused.current && !isFocused) {\n      if (!fixedText) {\n        onDelete(criterionIndex);\n        return;\n      }\n      let strs = fixedText.split('=');\n\n      if (strs.length === 1 || strs[1] === '') {\n        switch (strs[0]) {\n          // If the value does not exist in these conditions, delete this criterion.\n          case 'serviceName':\n          case 'spanName':\n          case 'remoteServiceName':\n          case 'maxDuration':\n          case 'minDuration':\n          case 'tagQuery':\n            setFixedText('');\n            onDelete(criterionIndex);\n            return;\n          default:\n            break;\n        }\n      }\n\n      // If the length is greater than 2, there is more than one \"=\" in the text.\n      // Service names, span names, and tag's keys and values can contain '=',\n      // so this is also valid.\n      // In this case, treat the first \"=\" as a separator between key and value.\n      if (strs.length > 2) {\n        strs = fixedText.split(/=(.+)/);\n      }\n      onChange(criterionIndex, newCriterion(strs[0], strs[1] || ''));\n    } else if (!prevIsFocused.current && isFocused) {\n      if (inputEl.current) {\n        inputEl.current.focus();\n      }\n    }\n    prevIsFocused.current = isFocused;\n  }, [isFocused, fixedText, onChange, onDelete, criterionIndex]);\n\n  const [keyText, valueText] = useMemo(() => {\n    const ss = fixedText.split('=');\n    return [ss[0], ss[1] || ''];\n  }, [fixedText]);\n\n  const isEnteringKey = !text.includes('=');\n  const isLoadingSuggestions = useMemo(() => {\n    if (isEnteringKey) {\n      return false;\n    }\n    switch (keyText) {\n      case 'serviceName':\n        return isLoadingServiceNames;\n      case 'spanName':\n        return isLoadingSpanNames;\n      case 'remoteServiceName':\n        return isLoadingRemoteServiceNames;\n      default:\n        if (autocompleteKeys.includes(keyText)) {\n          return isLoadingAutocompleteValues;\n        }\n    }\n    return false;\n  }, [\n    keyText,\n    isEnteringKey,\n    isLoadingServiceNames,\n    isLoadingSpanNames,\n    isLoadingRemoteServiceNames,\n    isLoadingAutocompleteValues,\n    autocompleteKeys,\n  ]);\n\n  const suggestions = useMemo(() => {\n    if (isEnteringKey) {\n      let keys;\n\n      // spanName and remoteServiceName are fetched after serviceName is\n      // selected, so so they will not be displayed until serviceName is selected.\n      if (criteria.find(({ key }) => key === 'serviceName')) {\n        keys = [\n          'serviceName',\n          'spanName',\n          'remoteServiceName',\n          'maxDuration',\n          'minDuration',\n          'tagQuery',\n          ...autocompleteKeys,\n        ];\n      } else {\n        keys = [\n          'serviceName',\n          'maxDuration',\n          'minDuration',\n          'tagQuery',\n          ...autocompleteKeys,\n        ];\n      }\n\n      return keys\n        .filter(\n          (key) =>\n            !criteria.find((criterion) => criterion.key === key) ||\n            criterion.key === key,\n        )\n        .filter((key) => key.includes(keyText));\n    }\n\n    let ss: string[];\n    switch (keyText) {\n      case 'serviceName':\n        ss = serviceNames;\n        break;\n      case 'spanName':\n        ss = spanNames;\n        break;\n      case 'remoteServiceName':\n        ss = remoteServiceNames;\n        break;\n      default:\n        if (autocompleteKeys.includes(keyText)) {\n          ss = autocompleteValues;\n          break;\n        }\n        return undefined;\n    }\n    return ss.filter((s) => s.includes(valueText));\n  }, [\n    autocompleteKeys,\n    autocompleteValues,\n    serviceNames,\n    spanNames,\n    remoteServiceNames,\n    isEnteringKey,\n    keyText,\n    valueText,\n    criteria,\n    criterion,\n  ]);\n\n  useEffect(() => {\n    if (autocompleteKeys.includes(keyText)) {\n      loadAutocompleteValues(keyText);\n    }\n  }, [keyText, autocompleteKeys, loadAutocompleteValues]);\n\n  const [suggestionIndex, setSuggestionIndex] = useState(-1);\n\n  const handleChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      setText(event.target.value);\n      setFixedText(event.target.value);\n      setSuggestionIndex(-1);\n    },\n    [],\n  );\n\n  const handleKeyDown = useCallback(\n    (event: React.KeyboardEvent<HTMLInputElement>) => {\n      switch (event.key) {\n        case 'Enter':\n          event.preventDefault();\n          if (isEnteringKey) {\n            if (!text) {\n              onDecide(criterionIndex);\n              return;\n            }\n            const newText = `${text}=`;\n            setText(newText);\n            setFixedText(newText);\n            setSuggestionIndex(-1);\n          } else {\n            setFixedText(text);\n            setSuggestionIndex(-1);\n            onDecide(criterionIndex);\n          }\n          break;\n        case 'ArrowUp': {\n          event.preventDefault();\n          if (\n            isLoadingSuggestions ||\n            !suggestions ||\n            suggestions.length === 0 ||\n            !(suggestionIndex > 0)\n          ) {\n            break;\n          }\n          const nextSuggestionIndex = suggestionIndex - 1;\n          setSuggestionIndex(nextSuggestionIndex);\n          if (isEnteringKey) {\n            setText(suggestions[nextSuggestionIndex]);\n          } else {\n            setText(`${keyText}=${suggestions[nextSuggestionIndex]}`);\n          }\n          break;\n        }\n        case 'ArrowDown':\n        case 'Tab': {\n          event.preventDefault();\n          if (\n            isLoadingSuggestions ||\n            !suggestions ||\n            suggestions.length === 0\n          ) {\n            break;\n          }\n          let nextSuggestionIndex: number;\n          if (suggestionIndex === suggestions.length - 1) {\n            nextSuggestionIndex = 0;\n          } else {\n            nextSuggestionIndex = suggestionIndex + 1;\n          }\n          setSuggestionIndex(nextSuggestionIndex);\n          if (isEnteringKey) {\n            setText(suggestions[nextSuggestionIndex]);\n          } else {\n            setText(`${keyText}=${suggestions[nextSuggestionIndex]}`);\n          }\n          break;\n        }\n        case 'Escape': {\n          onDecide(criterionIndex);\n          break;\n        }\n        default:\n          break;\n      }\n    },\n    [\n      isEnteringKey,\n      text,\n      onDecide,\n      criterionIndex,\n      isLoadingSuggestions,\n      suggestions,\n      suggestionIndex,\n      keyText,\n    ],\n  );\n\n  const handleDeleteButtonClick = useCallback(\n    (event: React.MouseEvent<HTMLButtonElement>) => {\n      event.stopPropagation();\n      onDelete(criterionIndex);\n    },\n    [onDelete, criterionIndex],\n  );\n\n  const handleSuggestionItemClick = (index: number) => () => {\n    if (!suggestions) {\n      return;\n    }\n    if (isEnteringKey) {\n      const newText = `${suggestions[index]}=`;\n      setText(newText);\n      setFixedText(newText);\n      setSuggestionIndex(-1);\n      if (inputEl.current) {\n        // When the suggestion is clicked, the focus is removed from input.\n        // So need to refocus.\n        inputEl.current.focus();\n      }\n    } else {\n      const newText = `${keyText}=${suggestions[index]}`;\n      setText(newText);\n      setFixedText(newText);\n      setSuggestionIndex(-1);\n      onDecide(criterionIndex);\n    }\n  };\n\n  const handleClick = useCallback(() => {\n    onFocus(criterionIndex);\n  }, [criterionIndex, onFocus]);\n\n  if (!isFocused) {\n    return (\n      <Root onClick={handleClick}>\n        <Box\n          maxWidth={150}\n          height=\"100%\"\n          bgcolor=\"primary.dark\"\n          p={1}\n          overflow=\"hidden\"\n          whiteSpace=\"nowrap\"\n          textOverflow=\"ellipsis\"\n        >\n          {criterion.key}\n        </Box>\n        {criterion.value && (\n          <Box\n            maxWidth={200}\n            height=\"100%\"\n            bgcolor=\"primary.main\"\n            p={1}\n            overflow=\"hidden\"\n            whiteSpace=\"nowrap\"\n            textOverflow=\"ellipsis\"\n          >\n            {criterion.value}\n          </Box>\n        )}\n        <DeleteButton type=\"button\" onClick={handleDeleteButtonClick}>\n          <FontAwesomeIcon icon={faTimes} size=\"lg\" />\n        </DeleteButton>\n      </Root>\n    );\n  }\n\n  return (\n    <ClickAwayListener onClickAway={onBlur}>\n      <FocusedRoot>\n        <Input\n          ref={inputEl}\n          value={text}\n          onKeyDown={handleKeyDown}\n          onChange={handleChange}\n        />\n        {(isLoadingSuggestions ||\n          (suggestions && suggestions.length !== 0)) && (\n          <SuggestionList\n            suggestions={suggestions || []}\n            isLoadingSuggestions={isLoadingSuggestions}\n            suggestionIndex={suggestionIndex}\n            onItemClick={handleSuggestionItemClick}\n          />\n        )}\n        {!isEnteringKey &&\n          (keyText === 'minDuration' ||\n            keyText === 'maxDuration' ||\n            keyText === 'tagQuery') && <HowToUse target={keyText} />}\n      </FocusedRoot>\n    </ClickAwayListener>\n  );\n};\n\nexport default CriterionBox;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\n\nexport const loadAutocompleteValues = createAsyncThunk(\n  'autocompleteValues/fetch',\n  async (autocompleteKey: string) => {\n    const params = new URLSearchParams();\n    params.set('key', autocompleteKey);\n    const resp = await fetch(`${api.AUTOCOMPLETE_VALUES}?${params.toString()}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const json = await resp.json();\n    return json as string[];\n  },\n);\n\nexport interface AutocompleteValuesState {\n  isLoading: boolean;\n  autocompleteValues: string[];\n  error?: SerializedError;\n}\n\nconst initialState: AutocompleteValuesState = {\n  isLoading: false,\n  autocompleteValues: [],\n  error: undefined,\n};\n\nconst autocompleteValuesSlice = createSlice({\n  name: 'autocompleteValues',\n  initialState,\n  reducers: {},\n  extraReducers: (builder) => {\n    builder.addCase(loadAutocompleteValues.pending, (state) => {\n      state.isLoading = true;\n      state.autocompleteValues = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadAutocompleteValues.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.autocompleteValues = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadAutocompleteValues.rejected, (state, action) => {\n      state.isLoading = false;\n      state.autocompleteValues = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport default autocompleteValuesSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\n\nexport const loadRemoteServices = createAsyncThunk(\n  'remoteServices/fetch',\n  async (serviceName: string) => {\n    const params = new URLSearchParams();\n    params.set('serviceName', serviceName);\n    const resp = await fetch(`${api.REMOTE_SERVICES}?${params.toString()}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const json = await resp.json();\n    return json as string[];\n  },\n);\n\nexport interface RemoteServicesState {\n  isLoading: boolean;\n  remoteServices: string[];\n  error?: SerializedError;\n}\n\nconst initialState: RemoteServicesState = {\n  isLoading: false,\n  remoteServices: [],\n  error: undefined,\n};\n\nconst remoteServicesSlice = createSlice({\n  name: 'remoteServices',\n  initialState,\n  reducers: {}, // SearchBar.tsx issues load on serviceName change, so no need to clear\n  extraReducers: (builder) => {\n    builder.addCase(loadRemoteServices.pending, (state) => {\n      state.isLoading = true;\n      state.remoteServices = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadRemoteServices.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.remoteServices = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadRemoteServices.rejected, (state, action) => {\n      state.isLoading = false;\n      state.remoteServices = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport default remoteServicesSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\n\nexport const loadServices = createAsyncThunk('services/fetch', async () => {\n  const resp = await fetch(api.SERVICES);\n  if (!resp.ok) {\n    throw Error(resp.statusText);\n  }\n  const json = await resp.json();\n  return json as string[];\n});\n\nexport interface ServicesState {\n  isLoading: boolean;\n  services: string[];\n  error?: SerializedError;\n}\n\nconst initialState: ServicesState = {\n  isLoading: false,\n  services: [],\n  error: undefined,\n};\n\nconst servicesSlice = createSlice({\n  name: 'services',\n  initialState,\n  reducers: {},\n  extraReducers: (builder) => {\n    builder.addCase(loadServices.pending, (state) => {\n      state.isLoading = true;\n      state.services = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadServices.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.services = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadServices.rejected, (state, action) => {\n      state.isLoading = false;\n      state.services = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport default servicesSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\n\nexport const loadSpans = createAsyncThunk(\n  'spans/fetch',\n  async (serviceName: string) => {\n    const params = new URLSearchParams();\n    params.set('serviceName', serviceName);\n    const resp = await fetch(`${api.SPANS}?${params.toString()}`);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const json = await resp.json();\n    return json as string[];\n  },\n);\n\nexport interface SpansState {\n  isLoading: boolean;\n  spans: string[];\n  error?: SerializedError;\n}\n\nconst initialState: SpansState = {\n  isLoading: false,\n  spans: [],\n  error: undefined,\n};\n\nconst spansSlice = createSlice({\n  name: 'spans',\n  initialState,\n  reducers: {}, // SearchBar.tsx issues load on serviceName change, so no need to clear\n  extraReducers: (builder) => {\n    builder.addCase(loadSpans.pending, (state) => {\n      state.isLoading = true;\n      state.spans = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadSpans.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.spans = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadSpans.rejected, (state, action) => {\n      state.isLoading = false;\n      state.spans = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport default spansSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-shadow */\n\nimport { faPlus } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport {\n  Box,\n  Button,\n  Theme,\n  createStyles,\n  makeStyles,\n} from '@material-ui/core';\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { connect } from 'react-redux';\nimport { ThunkDispatch } from 'redux-thunk';\n\nimport Criterion, { newCriterion } from '../Criterion';\nimport CriterionBox from './CriterionBox';\nimport { loadAutocompleteValues } from '../../../slices/autocompleteValuesSlice';\nimport { loadRemoteServices } from '../../../slices/remoteServicesSlice';\nimport { loadServices } from '../../../slices/servicesSlice';\nimport { loadSpans } from '../../../slices/spansSlice';\nimport { RootState } from '../../../store';\n\nconst useStyles = makeStyles((theme: Theme) =>\n  createStyles({\n    addButton: {\n      height: 40,\n      width: 40,\n      minWidth: 40,\n      color: theme.palette.common.white,\n    },\n  }),\n);\n\ntype SearchBarProps = {\n  searchTraces: () => void;\n  criteria: Criterion[];\n  onChange: (criteria: Criterion[]) => void;\n  serviceNames: string[];\n  isLoadingServiceNames: boolean;\n  spanNames: string[];\n  isLoadingSpanNames: boolean;\n  remoteServiceNames: string[];\n  isLoadingRemoteServiceNames: boolean;\n  autocompleteKeys: string[];\n  autocompleteValues: string[];\n  isLoadingAutocompleteValues: boolean;\n  loadServices: () => void;\n  loadRemoteServices: (serviceName: string) => void;\n  loadSpans: (serviceName: string) => void;\n  loadAutocompleteValues: (autocompleteKey: string) => void;\n};\n\nexport const SearchBarImpl: React.FC<SearchBarProps> = ({\n  searchTraces,\n  criteria,\n  onChange,\n  serviceNames,\n  isLoadingServiceNames,\n  spanNames,\n  isLoadingSpanNames,\n  remoteServiceNames,\n  isLoadingRemoteServiceNames,\n  autocompleteKeys,\n  autocompleteValues,\n  isLoadingAutocompleteValues,\n  loadServices,\n  loadRemoteServices,\n  loadSpans,\n  loadAutocompleteValues,\n}) => {\n  const classes = useStyles();\n\n  // criterionIndex is the index of the criterion currently being edited.\n  // If the value is -1, there is no criterion being edited.\n  const [criterionIndex, setCriterionIndex] = useState(-1);\n\n  const handleCriterionFocus = (index: number) => {\n    setCriterionIndex(index);\n  };\n\n  const handleCriterionChange = (index: number, criterion: Criterion) => {\n    const newCriteria = [...criteria];\n    newCriteria[index] = criterion;\n    onChange(newCriteria);\n  };\n\n  const handleCriterionBlur = () => {\n    setCriterionIndex(-1);\n  };\n\n  const handleCriterionDelete = (index: number) => {\n    const newCriteria = criteria.filter((_, i) => i !== index);\n    onChange(newCriteria);\n    setCriterionIndex(-1);\n  };\n\n  const handleCriterionDecide = (index: number) => {\n    if (index === criteria.length - 1) {\n      const newCriteria = [...criteria];\n      newCriteria.push(newCriterion('', ''));\n      onChange(newCriteria);\n      const nextCriterionIndex = criteria.length;\n      setCriterionIndex(nextCriterionIndex);\n    } else {\n      setCriterionIndex(-1);\n    }\n  };\n\n  const handleAddButtonClick = useCallback(() => {\n    const newCriteria = [...criteria];\n    newCriteria.push(newCriterion('', ''));\n    onChange(newCriteria);\n    const nextCriterionIndex = criteria.length;\n    setCriterionIndex(nextCriterionIndex);\n  }, [criteria, onChange]);\n\n  useEffect(() => {\n    loadServices();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const prevServiceName = useRef('');\n  useEffect(() => {\n    const criterion = criteria.find(\n      // eslint-disable-next-line no-shadow\n      (criterion) => criterion.key === 'serviceName',\n    );\n    const serviceName = criterion ? criterion.value : '';\n    if (serviceName !== prevServiceName.current) {\n      prevServiceName.current = serviceName;\n      loadSpans(serviceName);\n      loadRemoteServices(serviceName);\n    }\n  }, [criteria, loadSpans, loadRemoteServices]);\n\n  // Search for traces if not all criterions are in focus\n  // and the Enter key is pressed.\n  // Use ref to use the latest criterionIndex state in the callback.\n  const isFocusedRef = useRef(false);\n  isFocusedRef.current = criterionIndex !== -1;\n  const handleKeyDown = useCallback(\n    (event: KeyboardEvent) => {\n      // Use setTimeout to ensure that the callback is called\n      // after the criterionIndex has been updated.\n      setTimeout(() => {\n        if (!document.activeElement) {\n          return;\n        }\n        if (\n          !isFocusedRef.current &&\n          document.activeElement.tagName === 'BODY' &&\n          event.key === 'Enter'\n        ) {\n          searchTraces();\n        }\n      }, 0); // Maybe 0 is enough.\n    },\n    [searchTraces],\n  );\n  useEffect(() => {\n    window.addEventListener('keydown', handleKeyDown);\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleKeyDown]);\n\n  return (\n    <Box\n      minHeight={60}\n      display=\"flex\"\n      alignItems=\"center\"\n      pr={2}\n      pl={2}\n      pt={1}\n      pb={1}\n      borderRadius={3}\n      bgcolor=\"background.paper\"\n      flexWrap=\"wrap\"\n      borderColor=\"grey.400\"\n      border={1}\n    >\n      {criteria.map((criterion, index) => (\n        <CriterionBox\n          key={criterion.id}\n          criteria={criteria}\n          criterion={criterion}\n          criterionIndex={index}\n          serviceNames={serviceNames}\n          remoteServiceNames={remoteServiceNames}\n          spanNames={spanNames}\n          autocompleteKeys={autocompleteKeys}\n          autocompleteValues={autocompleteValues}\n          isLoadingServiceNames={isLoadingServiceNames}\n          isLoadingRemoteServiceNames={isLoadingRemoteServiceNames}\n          isLoadingSpanNames={isLoadingSpanNames}\n          isLoadingAutocompleteValues={isLoadingAutocompleteValues}\n          isFocused={index === criterionIndex}\n          onFocus={handleCriterionFocus}\n          onBlur={handleCriterionBlur}\n          onDecide={handleCriterionDecide}\n          onChange={handleCriterionChange}\n          onDelete={handleCriterionDelete}\n          loadAutocompleteValues={loadAutocompleteValues}\n        />\n      ))}\n      <Button\n        color=\"secondary\"\n        variant=\"contained\"\n        onClick={handleAddButtonClick}\n        className={classes.addButton}\n        data-testid=\"add-button\"\n      >\n        <FontAwesomeIcon icon={faPlus} size=\"lg\" />\n      </Button>\n    </Box>\n  );\n};\n\n// For unit testing, `connect` is easier to use than\n// useSelector or useDispatch hooks.\nconst mapStateToProps = (state: RootState) => ({\n  serviceNames: state.services.services,\n  isLoadingServiceNames: state.services.isLoading,\n  spanNames: state.spans.spans,\n  isLoadingSpanNames: state.spans.isLoading,\n  remoteServiceNames: state.remoteServices.remoteServices,\n  isLoadingRemoteServiceNames: state.remoteServices.isLoading,\n  autocompleteKeys: state.autocompleteKeys.autocompleteKeys,\n  autocompleteValues: state.autocompleteValues.autocompleteValues,\n  isLoadingAutocompleteValues: state.autocompleteValues.isLoading,\n});\n\n// TODO: Give the appropriate type to ThunkDispatch after TypeScriptizing all action creators.\nconst mapDispatchToProps = (\n  dispatch: ThunkDispatch<RootState, undefined, any>,\n) => ({\n  loadServices: () => {\n    dispatch(loadServices());\n  },\n  loadRemoteServices: (serviceName: string) => {\n    dispatch(loadRemoteServices(serviceName));\n  },\n  loadSpans: (serviceName: string) => {\n    dispatch(loadSpans(serviceName));\n  },\n  loadAutocompleteValues: (autocompleteKey: string) => {\n    dispatch(loadAutocompleteValues(autocompleteKey));\n  },\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(SearchBarImpl);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport moment from 'moment';\n\nexport const formatDuration = (duration) => {\n  if (duration === 0 || typeof duration === 'undefined') {\n    return '0ms';\n  }\n  if (duration < 1000) {\n    return `${duration}s`;\n  }\n  if (duration < 1000000) {\n    return `${(duration / 1000).toFixed(3)}ms`;\n  }\n  return `${(duration / 1000000).toFixed(3)}s`;\n};\n\nexport const formatTimestamp = (timestamp) =>\n  moment(timestamp / 1000).format('MM/DD HH:mm:ss.SSS');\n\n// moment.js only supports millisecond precision, however our timestamps have\n// microsecond precision. So we use moment.js to generate the human readable time\n// with just milliseconds and then append the last 3 digits of the timestamp\n// which are the microseconds.\n// NOTE: a.timestamp % 1000 would save a string conversion but drops leading zeros.\nexport const formatTimestampMicros = (timestamp) =>\n  `${formatTimestamp(timestamp)}_${timestamp.toString().slice(-3)}`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React, { useMemo, useCallback } from 'react';\nimport { faTimes } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { makeStyles, ThemeProvider } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Paper from '@material-ui/core/Paper';\n\nimport { selectServiceTheme } from '../../constants/color';\n\nconst useStyles = makeStyles((theme) => ({\n  paper: {\n    overflow: 'hidden',\n    display: 'flex',\n    flexShrink: 0,\n  },\n  buttonBase: {\n    height: '1.8rem',\n    paddingRight: '0.5rem',\n    paddingLeft: '0.5rem',\n    display: 'flex',\n    alignItems: 'center',\n    color: theme.palette.common.white,\n    backgroundColor: theme.palette.primary.dark,\n  },\n  clickableButton: {\n    cursor: 'pointer',\n    transition: theme.transitions.create(['background-color'], {\n      duration: theme.transitions.duration.short,\n    }),\n    '&:hover': {\n      backgroundColor: theme.palette.primary.main,\n    },\n  },\n}));\n\nconst propTypes = {\n  serviceName: PropTypes.string.isRequired,\n  count: PropTypes.number,\n  onClick: PropTypes.func,\n  onDelete: PropTypes.func,\n};\n\nconst defaultProps = {\n  count: null,\n  onClick: null,\n  onDelete: null,\n};\n\nconst ServiceBadgeImpl = ({ serviceName, count, onClick, onDelete }) => {\n  const classes = useStyles();\n\n  const label = useMemo(() => `${serviceName}${count ? ` (${count})` : ''}`, [\n    count,\n    serviceName,\n  ]);\n\n  const handleClick = useCallback(() => {\n    onClick(serviceName);\n  }, [onClick, serviceName]);\n\n  return (\n    <Paper className={classes.paper}>\n      <Box\n        className={`${classes.buttonBase} ${\n          onClick ? classes.clickableButton : ''\n        }`}\n        onClick={handleClick}\n        data-test=\"badge\"\n      >\n        {label}\n      </Box>\n      {onDelete ? (\n        <Box\n          className={`${classes.buttonBase} ${classes.clickableButton}`}\n          onClick={onDelete}\n          data-test=\"delete-button\"\n        >\n          <FontAwesomeIcon icon={faTimes} />\n        </Box>\n      ) : null}\n    </Paper>\n  );\n};\n\nServiceBadgeImpl.propTypes = propTypes;\nServiceBadgeImpl.defaultProps = defaultProps;\n\nconst ServiceBadge = ({ serviceName, ...props }) => {\n  const theme = selectServiceTheme(serviceName);\n\n  return (\n    <ThemeProvider theme={theme}>\n      <ServiceBadgeImpl serviceName={serviceName} {...props} />\n    </ThemeProvider>\n  );\n};\n\nServiceBadge.propTypes = propTypes;\nServiceBadge.defaultProps = defaultProps;\n\nexport default ServiceBadge;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport {\n  Box,\n  Collapse,\n  IconButton,\n  TableCell,\n  TableRow,\n  Typography,\n  Button,\n} from '@material-ui/core';\nimport KeyboardArrowDownIcon from '@material-ui/icons/KeyboardArrowDown';\nimport KeyboardArrowUpIcon from '@material-ui/icons/KeyboardArrowUp';\nimport moment from 'moment';\nimport React, { useMemo, useCallback } from 'react';\nimport { Link } from 'react-router-dom';\nimport styled from 'styled-components';\n\nimport { selectColorByInfoClass } from '../../constants/color';\nimport TraceSummary from '../../models/TraceSummary';\nimport { formatDuration } from '../../util/timestamp';\nimport ServiceBadge from '../common/ServiceBadge';\n\ninterface TraceSummaryRowProps {\n  traceSummary: TraceSummary;\n  toggleFilter: (serviceName: string) => void;\n  open: boolean;\n  toggleOpen: (traceId: string) => void;\n}\n\nconst TraceSummaryRow: React.FC<TraceSummaryRowProps> = ({\n  traceSummary,\n  toggleFilter,\n  open,\n  toggleOpen,\n}) => {\n  const startTime = moment(traceSummary.timestamp / 1000);\n\n  const sortedServiceSummaries = useMemo(\n    () =>\n      [...traceSummary.serviceSummaries].sort(\n        (a, b) => b.spanCount - a.spanCount,\n      ),\n    [traceSummary.serviceSummaries],\n  );\n\n  const handleToggleOpen = useCallback(() => {\n    toggleOpen(traceSummary.traceId);\n  }, [toggleOpen, traceSummary.traceId]);\n\n  return (\n    <>\n      <Root>\n        <TableCell>\n          <IconButton size=\"small\" onClick={handleToggleOpen}>\n            {open ? <KeyboardArrowUpIcon /> : <KeyboardArrowDownIcon />}\n          </IconButton>\n        </TableCell>\n        <TableCell>\n          <Box display=\"flex\" alignItems=\"center\">\n            <ServiceNameTypography variant=\"body1\">\n              {traceSummary.root.serviceName}\n            </ServiceNameTypography>\n            <Typography variant=\"body2\" color=\"textSecondary\">\n              {traceSummary.root.spanName}\n            </Typography>\n          </Box>\n        </TableCell>\n        <TableCell>\n          <Box display=\"flex\" justifyContent=\"flex-end\" alignItems=\"center\">\n            <FromNowTypography>{startTime.fromNow()}</FromNowTypography>\n            <Typography\n              variant=\"body2\"\n              color=\"textSecondary\"\n              data-testid=\"TraceSummaryRow-startTimeFormat\"\n            >\n              ({startTime.format('MM/DD HH:mm:ss:SSS')})\n            </Typography>\n          </Box>\n        </TableCell>\n        <TableCell align=\"right\">{traceSummary.spanCount}</TableCell>\n        <TableCell align=\"right\">\n          <Box\n            position=\"relative\"\n            width=\"100%\"\n            data-testid=\"TraceSummaryRow-duration\"\n          >\n            {formatDuration(traceSummary.duration)}\n            <DurationBar\n              width={traceSummary.width}\n              infoClass={traceSummary.infoClass}\n            />\n          </Box>\n        </TableCell>\n        <TableCell>\n          <Button\n            variant=\"contained\"\n            size=\"small\"\n            component={Link}\n            to={`traces/${traceSummary.traceId}`}\n          >\n            Show\n          </Button>\n        </TableCell>\n      </Root>\n      <TableRow>\n        <CollapsibleTableCell>\n          <Collapse in={open} timeout=\"auto\" unmountOnExit>\n            <Box margin={1}>\n              <Box display=\"flex\" alignItems=\"center\">\n                <Typography variant=\"body1\" color=\"textSecondary\">\n                  Trace ID:\n                </Typography>\n                <TraceIdTypography>{traceSummary.traceId}</TraceIdTypography>\n              </Box>\n              <BadgesWrapper>\n                {sortedServiceSummaries.map((serviceSummary) => (\n                  <ServiceBadge\n                    serviceName={serviceSummary.serviceName}\n                    count={serviceSummary.spanCount}\n                    onClick={toggleFilter}\n                  />\n                ))}\n              </BadgesWrapper>\n            </Box>\n          </Collapse>\n        </CollapsibleTableCell>\n      </TableRow>\n    </>\n  );\n};\n\nexport default TraceSummaryRow;\n\nconst Root = styled(TableRow)`\n  & > * {\n    border-bottom: unset;\n  }\n`;\n\nconst ServiceNameTypography = styled(Typography).attrs({\n  variant: 'body1',\n})`\n  margin-right: ${({ theme }) => theme.spacing(1)}px;\n  &::after {\n    content: ':';\n  }\n`;\n\nconst FromNowTypography = styled(Typography).attrs({\n  variant: 'body2',\n})`\n  margin-right: ${({ theme }) => theme.spacing(1)}px;\n`;\n\nconst DurationBar = styled.div<{ width: number; infoClass?: string }>`\n  position: absolute;\n  background-color: ${({ infoClass }) =>\n    selectColorByInfoClass(infoClass || '')};\n  opacity: 0.3;\n  top: 0;\n  left: 0;\n  height: 100%;\n  width: ${({ width }) => width}%;\n  border-top-right-radius: 3px;\n  border-bottom-right-radius: 3px;\n`;\n\nconst CollapsibleTableCell = styled(TableCell).attrs({\n  colSpan: 6,\n})`\n  padding-bottom: 0;\n  padding-top: 0;\n`;\n\nconst TraceIdTypography = styled(Typography).attrs({\n  variant: 'body1',\n})`\n  margin-left: ${({ theme }) => theme.spacing(0.5)}px;\n`;\n\nconst BadgesWrapper = styled.div`\n  display: flex;\n  flex-wrap: wrap;\n  & > * {\n    margin: ${({ theme }) => theme.spacing(0.5)}px;\n  }\n`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { Trans } from '@lingui/macro';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableContainer,\n  TableHead,\n  TableRow,\n  TableSortLabel,\n} from '@material-ui/core';\nimport React, { useState, useCallback } from 'react';\n\nimport TraceSummaryRow from './TraceSummaryRow';\nimport TraceSummary from '../../models/TraceSummary';\n\ninterface TraceSummaryTableProps {\n  traceSummaries: TraceSummary[];\n  toggleFilter: (serivceName: string) => void;\n  traceSummaryOpenMap: { [key: string]: boolean };\n  toggleTraceSummaryOpen: (traceId: string) => void;\n}\n\nconst TraceSummaryTable: React.FC<TraceSummaryTableProps> = ({\n  traceSummaries,\n  toggleFilter,\n  traceSummaryOpenMap,\n  toggleTraceSummaryOpen,\n}) => {\n  const [order, setOrder] = useState<'asc' | 'desc'>('desc');\n  const [orderBy, setOrderBy] = useState<\n    'duration' | 'timestamp' | 'spanCount'\n  >('duration');\n\n  const handleSortButtonClick = useCallback(\n    (event: React.MouseEvent<HTMLDivElement>) => {\n      const { cellkey } = event.currentTarget.dataset;\n      if (\n        !cellkey ||\n        (cellkey !== 'duration' &&\n          cellkey !== 'timestamp' &&\n          cellkey !== 'spanCount')\n      ) {\n        return;\n      }\n\n      if (cellkey === orderBy) {\n        setOrder((prev) => {\n          if (prev === 'asc') return 'desc';\n          return 'asc';\n        });\n      } else {\n        setOrder('desc');\n        setOrderBy(cellkey);\n      }\n    },\n    [orderBy],\n  );\n\n  return (\n    <TableContainer>\n      <Table>\n        <TableHead>\n          <TableRow>\n            <TableCell />\n            <TableCell>\n              <Trans>Root</Trans>\n            </TableCell>\n            {[\n              { label: <Trans>Start Time</Trans>, key: 'timestamp' },\n              { label: <Trans>Spans</Trans>, key: 'spanCount' },\n              { label: <Trans>Duration</Trans>, key: 'duration' },\n            ].map(({ label, key }) => (\n              <TableCell\n                key={key}\n                align=\"right\"\n                sortDirection={orderBy === key ? order : false}\n              >\n                <TableSortLabel\n                  active={orderBy === key}\n                  direction={orderBy === key ? order : 'asc'}\n                  data-cellkey={key}\n                  onClick={handleSortButtonClick}\n                >\n                  {label}\n                </TableSortLabel>\n              </TableCell>\n            ))}\n            <TableCell />\n          </TableRow>\n        </TableHead>\n        <TableBody>\n          {traceSummaries\n            .sort((a, b) => {\n              if (order === 'asc') {\n                return a[orderBy] - b[orderBy];\n              }\n              return b[orderBy] - a[orderBy];\n            })\n            .map((traceSummary) => (\n              <TraceSummaryRow\n                key={traceSummary.traceId}\n                traceSummary={traceSummary}\n                toggleFilter={toggleFilter}\n                open={!!traceSummaryOpenMap[traceSummary.traceId]}\n                toggleOpen={toggleTraceSummaryOpen}\n              />\n            ))}\n        </TableBody>\n      </Table>\n    </TableContainer>\n  );\n};\n\nexport default TraceSummaryTable;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-shadow */\n\nimport { faHistory, faSync, faSearch } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { Trans } from '@lingui/macro';\nimport {\n  Box,\n  Button,\n  ButtonGroup,\n  ButtonProps,\n  Collapse,\n  Container,\n  Divider,\n  Paper,\n  TextField,\n  Typography,\n} from '@material-ui/core';\nimport ExpandLessIcon from '@material-ui/icons/ExpandLess';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport SettingsIcon from '@material-ui/icons/Settings';\nimport { Autocomplete } from '@material-ui/lab';\nimport moment from 'moment';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory, useLocation } from 'react-router-dom';\nimport styled from 'styled-components';\n\nimport Criterion, { newCriterion } from './Criterion';\nimport LookbackMenu from './LookbackMenu';\nimport SearchBar from './SearchBar';\nimport TraceSummaryTable from './TraceSummaryTable';\nimport { Lookback, fixedLookbackMap, millisecondsToValue } from './lookback';\nimport { setAlert } from '../App/slice';\nimport { useUiConfig } from '../UiConfig';\nimport ExplainBox from '../common/ExplainBox';\nimport TraceSummary from '../../models/TraceSummary';\nimport { clearSearch, searchTraces } from '../../slices/tracesSlice';\nimport { RootState } from '../../store';\nimport { LoadingIndicator } from '../common/LoadingIndicator';\n\ninterface DiscoverPageContentProps {\n  autocompleteKeys: string[];\n}\n\n// Export for testing\nexport const useQueryParams = (autocompleteKeys: string[]) => {\n  const history = useHistory();\n  const location = useLocation();\n\n  const setQueryParams = useCallback(\n    (criteria: Criterion[], lookback: Lookback, limit: number) => {\n      const params = new URLSearchParams();\n      const annotationQuery: string[] = [];\n      criteria.forEach((criterion) => {\n        // If the key is 'tag' or a string included in autocompleteKeys,\n        // the criterion will be included in annotationQuery.\n        if (criterion.key === 'tagQuery') {\n          annotationQuery.push(criterion.value);\n        } else if (autocompleteKeys.includes(criterion.key)) {\n          if (criterion.value) {\n            annotationQuery.push(`${criterion.key}=${criterion.value}`);\n          } else {\n            annotationQuery.push(criterion.key);\n          }\n        } else {\n          params.set(criterion.key, criterion.value);\n        }\n      });\n      if (annotationQuery.length > 0) {\n        params.set('annotationQuery', annotationQuery.join(' and '));\n      }\n      switch (lookback.type) {\n        case 'fixed':\n          params.set('lookback', lookback.value);\n          params.set('endTs', lookback.endTime.valueOf().toString());\n          break;\n        case 'range':\n          params.set('lookback', 'range');\n          params.set('endTs', lookback.endTime.valueOf().toString());\n          params.set('startTs', lookback.startTime.valueOf().toString());\n          break;\n        case 'millis':\n          params.set('lookback', 'millis');\n          params.set('endTs', lookback.endTime.valueOf().toString());\n          params.set('millis', lookback.value.toString());\n          break;\n        default:\n      }\n      params.set('limit', limit.toString());\n      history.push({\n        pathname: location.pathname,\n        search: params.toString(),\n      });\n    },\n    [autocompleteKeys, history, location.pathname],\n  );\n\n  const criteria = useMemo(() => {\n    const ret: Criterion[] = [];\n    const params = new URLSearchParams(location.search);\n\n    params.forEach((value, key) => {\n      switch (key) {\n        case 'lookback':\n        case 'startTs':\n        case 'endTs':\n        case 'millis':\n        case 'limit':\n          break;\n        case 'annotationQuery': {\n          // Split annotationQuery into keys of autocompleteKeys and the others.\n          // If the autocompleteKeys is ['projectID', 'phase'] and the annotationQuery is\n          // 'projectID=projectA and phase=BETA and http.path=/api/v1/users and http.method=GET',\n          // criterion will be like the following.\n          // [\n          //   { key: 'tagQuery', value: 'http.path=/api/v1/users and http.method=GET' },\n          //   { key: 'projectID', value: 'projectA' },\n          //   { key: 'phase', value: 'BETA' },\n          // ]\n          const tagQuery: string[] = [];\n          const exps = value.split(' and ');\n          exps.forEach((exp) => {\n            const strs = exp.split('=');\n            if (strs.length === 0) {\n              return;\n            }\n            const [key, value] = strs;\n            if (autocompleteKeys.includes(key)) {\n              ret.push(newCriterion(key, value || ''));\n            } else {\n              tagQuery.push(exp);\n            }\n          });\n          ret.push(newCriterion('tagQuery', tagQuery.join(' and ')));\n          break;\n        }\n        default:\n          ret.push(newCriterion(key, value));\n          break;\n      }\n    });\n    return ret;\n  }, [autocompleteKeys, location.search]);\n\n  const lookback = useMemo<Lookback | undefined>(() => {\n    const ps = new URLSearchParams(location.search);\n    const lookback = ps.get('lookback');\n    if (!lookback) {\n      return undefined;\n    }\n\n    switch (lookback) {\n      case 'range': {\n        const startTs = ps.get('startTs');\n        const endTs = ps.get('endTs');\n        if (!endTs || !startTs) {\n          return undefined;\n        }\n        const startTime = moment(parseInt(startTs, 10));\n        const endTime = moment(parseInt(endTs, 10));\n        return {\n          type: 'range',\n          startTime,\n          endTime,\n        };\n      }\n      case 'millis': {\n        const endTs = ps.get('endTs');\n        const valueStr = ps.get('millis');\n        if (!endTs || !valueStr) {\n          return undefined;\n        }\n        const endTime = moment(parseInt(endTs, 10));\n        const value = parseInt(valueStr, 10);\n        return {\n          type: 'millis',\n          endTime,\n          value,\n        };\n      }\n      default: {\n        // Otherwise lookback should be 1m, 5m 15m, ...\n        const data = fixedLookbackMap[lookback];\n        if (!data) {\n          return undefined;\n        }\n        const endTs = ps.get('endTs');\n        if (!endTs) {\n          return undefined;\n        }\n        return {\n          type: 'fixed',\n          value: data.value,\n          endTime: moment(parseInt(endTs, 10)),\n        };\n      }\n    }\n  }, [location.search]);\n\n  const limit = useMemo(() => {\n    const ps = new URLSearchParams(location.search);\n    const limit = ps.get('limit');\n    if (!limit) {\n      return undefined;\n    }\n    return parseInt(limit, 10);\n  }, [location.search]);\n\n  return {\n    setQueryParams,\n    criteria,\n    lookback,\n    limit,\n  };\n};\n\n// Export for testing\nexport const parseDuration = (duration: string) => {\n  const regex = /^(\\d+)(s|ms|us)?$/;\n  const match = duration.match(regex);\n\n  if (!match || match.length < 2) {\n    return undefined;\n  }\n  if (match.length === 2 || typeof match[2] === 'undefined') {\n    return parseInt(match[1], 10);\n  }\n  switch (match[2]) {\n    case 's':\n      return parseInt(match[1], 10) * 1000 * 1000;\n    case 'ms':\n      return parseInt(match[1], 10) * 1000;\n    case 'us':\n      return parseInt(match[1], 10);\n    default:\n      return undefined;\n  }\n};\n\n// Export for testing\nexport const buildApiQuery = (\n  criteria: Criterion[],\n  lookback: Lookback,\n  limit: number,\n  autocompleteKeys: string[],\n) => {\n  const params: { [key: string]: string } = {};\n  const annotationQuery: string[] = [];\n  criteria.forEach((criterion) => {\n    if (criterion.key === 'tagQuery') {\n      annotationQuery.push(criterion.value);\n    } else if (autocompleteKeys.includes(criterion.key)) {\n      if (criterion.value) {\n        annotationQuery.push(`${criterion.key}=${criterion.value}`);\n      } else {\n        annotationQuery.push(criterion.key);\n      }\n    } else if (\n      criterion.key === 'minDuration' ||\n      criterion.key === 'maxDuration'\n    ) {\n      const duration = parseDuration(criterion.value);\n      if (duration) {\n        params[criterion.key] = duration.toString();\n      }\n    } else {\n      params[criterion.key] = criterion.value;\n    }\n  });\n  if (annotationQuery.length > 0) {\n    params.annotationQuery = annotationQuery.join(' and ');\n  }\n\n  params.endTs = lookback.endTime.valueOf().toString();\n  switch (lookback.type) {\n    case 'range': {\n      const lb = lookback.endTime.valueOf() - lookback.startTime.valueOf();\n      params.lookback = lb.toString();\n      break;\n    }\n    case 'millis': {\n      params.lookback = lookback.value.toString();\n      break;\n    }\n    case 'fixed': {\n      params.lookback = fixedLookbackMap[lookback.value].duration\n        .asMilliseconds()\n        .toString();\n      break;\n    }\n    default:\n  }\n\n  params.limit = limit.toString();\n  return params;\n};\n\nconst useFetchTraces = (\n  autocompleteKeys: string[],\n  criteria: Criterion[],\n  lookback?: Lookback,\n  limit?: number,\n) => {\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    // For searching, lookback and limit are always required.\n    // If it doesn't exist, clear trace summaries.\n    if (!lookback || !limit) {\n      dispatch(clearSearch());\n      return;\n    }\n    const params = buildApiQuery(criteria, lookback, limit, autocompleteKeys);\n    dispatch(searchTraces(params));\n  }, [autocompleteKeys, criteria, dispatch, limit, lookback]);\n};\n\nconst initialLookback = (\n  lookback: Lookback | undefined,\n  defaultLookback: number,\n): Lookback => {\n  if (lookback) {\n    return lookback;\n  }\n  const fixed = millisecondsToValue[defaultLookback];\n  if (fixed) {\n    return {\n      type: 'fixed',\n      value: fixed,\n      endTime: moment(),\n    };\n  }\n  return {\n    type: 'millis',\n    value: defaultLookback,\n    endTime: moment(),\n  };\n};\n\nconst useFilters = (traceSummaries: TraceSummary[]) => {\n  const [filters, setFilters] = useState<string[]>([]);\n\n  const filterOptions = useMemo(\n    () =>\n      Array.from(\n        traceSummaries.reduce((set, traceSummary) => {\n          traceSummary.serviceSummaries.forEach((serviceSummary) => {\n            set.add(serviceSummary.serviceName);\n          });\n          return set;\n        }, new Set<string>()),\n      ),\n    [traceSummaries],\n  );\n\n  const handleFiltersChange = useCallback((event: any, value: string[]) => {\n    setFilters(value);\n  }, []);\n\n  const toggleFilter = useCallback(\n    (serviceName: string) => {\n      if (filters.includes(serviceName)) {\n        setFilters(filters.filter((filter) => filter !== serviceName));\n      } else {\n        const newFilters = [...filters];\n        newFilters.push(serviceName);\n        setFilters(newFilters);\n      }\n    },\n    [filters],\n  );\n\n  return {\n    filters,\n    handleFiltersChange,\n    filterOptions,\n    toggleFilter,\n  };\n};\n\nconst useTraceSummaryOpenState = (traceSummaries: TraceSummary[]) => {\n  const [traceSummaryOpenMap, setTraceSummaryOpenMap] = useState<{\n    [key: string]: boolean;\n  }>({});\n\n  const expandAll = useCallback(() => {\n    setTraceSummaryOpenMap(\n      traceSummaries.reduce((acc, cur) => {\n        acc[cur.traceId] = true;\n        return acc;\n      }, {} as { [key: string]: boolean }),\n    );\n  }, [traceSummaries]);\n\n  const collapseAll = useCallback(() => {\n    setTraceSummaryOpenMap({});\n  }, []);\n\n  const toggleTraceSummaryOpen = useCallback((traceId: string) => {\n    setTraceSummaryOpenMap((prev) => {\n      const newTraceSummaryOpenMap = { ...prev };\n      newTraceSummaryOpenMap[traceId] = !newTraceSummaryOpenMap[traceId];\n      return newTraceSummaryOpenMap;\n    });\n  }, []);\n\n  return {\n    traceSummaryOpenMap,\n    expandAll,\n    collapseAll,\n    toggleTraceSummaryOpen,\n  };\n};\n\nconst DiscoverPageContent: React.FC<DiscoverPageContentProps> = ({\n  autocompleteKeys,\n}) => {\n  // Retrieve search criteria from the URL query string and use them to search for traces.\n  const { setQueryParams, criteria, lookback, limit } = useQueryParams(\n    autocompleteKeys,\n  );\n  useFetchTraces(autocompleteKeys, criteria, lookback, limit);\n\n  // Temporary search criteria.\n  const [tempCriteria, setTempCriteria] = useState(criteria);\n  const { defaultLookback, queryLimit } = useUiConfig();\n  const [tempLookback, setTempLookback] = useState<Lookback>(\n    initialLookback(lookback, defaultLookback),\n  );\n  const [tempLimit, setTempLimit] = useState(limit || queryLimit);\n\n  const lookbackDisplay = useMemo<string>(() => {\n    switch (tempLookback.type) {\n      case 'fixed':\n        return fixedLookbackMap[tempLookback.value].display;\n      case 'range':\n        return `${tempLookback.startTime.format(\n          'MM/DD/YYYY HH:mm:ss',\n        )} - ${tempLookback.endTime.format('MM/DD/YYYY HH:mm:ss')}`;\n      case 'millis':\n        return `${tempLookback.value}ms`;\n      default:\n        return '';\n    }\n  }, [tempLookback]);\n\n  const handleLimitChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      setTempLimit(parseInt(event.target.value, 10));\n    },\n    [],\n  );\n\n  const searchTraces = useCallback(() => {\n    const criteria = tempCriteria.filter((c) => !!c.key);\n\n    // If the lookback is fixed or millis, need to set the click time to endTime.\n    if (tempLookback.type === 'fixed' || tempLookback.type === 'millis') {\n      setQueryParams(\n        criteria,\n        { ...tempLookback, endTime: moment() },\n        tempLimit,\n      );\n    } else {\n      setQueryParams(criteria, tempLookback, tempLimit);\n    }\n  }, [setQueryParams, tempCriteria, tempLookback, tempLimit]);\n\n  const { isLoading, traceSummaries, error } = useSelector(\n    (state: RootState) => state.traces.search,\n  );\n\n  const [isShowingLookbackMenu, setIsShowingLookbackMenu] = useState(false);\n  const toggleLookbackMenu = useCallback(() => {\n    setIsShowingLookbackMenu((prev) => !prev);\n  }, []);\n  const closeLookbackMenu = useCallback(() => {\n    setIsShowingLookbackMenu(false);\n  }, []);\n\n  const [isOpeningSettings, setIsOpeningSettings] = useState(false);\n  const handleSettingsButtonClick = useCallback(() => {\n    setIsOpeningSettings((prev) => !prev);\n  }, []);\n\n  const {\n    filters,\n    handleFiltersChange,\n    filterOptions,\n    toggleFilter,\n  } = useFilters(traceSummaries);\n\n  const {\n    traceSummaryOpenMap,\n    expandAll,\n    collapseAll,\n    toggleTraceSummaryOpen,\n  } = useTraceSummaryOpenState(traceSummaries);\n\n  const filteredTraceSummaries = useMemo(() => {\n    return traceSummaries.filter((traceSummary) => {\n      const serviceNameSet = new Set(\n        traceSummary.serviceSummaries.map(\n          (serviceSummary) => serviceSummary.serviceName,\n        ),\n      );\n      return !filters.find((filter) => !serviceNameSet.has(filter));\n    });\n  }, [filters, traceSummaries]);\n\n  const dispatch = useDispatch();\n\n  // If there is a problem during the search, show it.\n  useEffect(() => {\n    if (error) {\n      let message = 'Failed to search';\n      if (error.message) {\n        message += `: ${error.message}`;\n      }\n      dispatch(\n        setAlert({\n          message,\n          severity: 'error',\n        }),\n      );\n    }\n  }, [dispatch, error]);\n\n  let content: JSX.Element | undefined;\n\n  if (isLoading) {\n    content = <LoadingIndicator />;\n  } else if (traceSummaries.length === 0) {\n    content = (\n      <ExplainBox\n        icon={faSearch}\n        headerText={<Trans>Search Traces</Trans>}\n        text={\n          <Trans>\n            Please select criteria in the search bar. Then, click the search\n            button.\n          </Trans>\n        }\n      />\n    );\n  } else {\n    content = (\n      <Paper elevation={3}>\n        <TraceSummaryTable\n          traceSummaries={filteredTraceSummaries}\n          toggleFilter={toggleFilter}\n          traceSummaryOpenMap={traceSummaryOpenMap}\n          toggleTraceSummaryOpen={toggleTraceSummaryOpen}\n        />\n      </Paper>\n    );\n  }\n\n  return (\n    <Box\n      width=\"100%\"\n      height=\"calc(100vh - 64px)\"\n      display=\"flex\"\n      flexDirection=\"column\"\n    >\n      <Box\n        bgcolor=\"background.paper\"\n        boxShadow={3}\n        pt={2}\n        pb={1.5}\n        zIndex={1000}\n      >\n        <Container>\n          <Box display=\"flex\">\n            <Box flexGrow={1} mr={1}>\n              <SearchBar\n                criteria={tempCriteria}\n                onChange={setTempCriteria}\n                searchTraces={searchTraces}\n              />\n            </Box>\n            <SearchButton onClick={searchTraces}>Run Query</SearchButton>\n            <SettingsButton\n              onClick={handleSettingsButtonClick}\n              isOpening={isOpeningSettings}\n              data-testid=\"settings-button\"\n            >\n              <SettingsIcon />\n            </SettingsButton>\n          </Box>\n        </Container>\n        <Collapse in={isOpeningSettings}>\n          <Box mt={1.5} mb={1.5}>\n            <Divider />\n          </Box>\n          <Container>\n            <Box\n              display=\"flex\"\n              alignItems=\"center\"\n              justifyContent=\"flex-end\"\n              mt={1.75}\n            >\n              <TextField\n                label={<Trans>Limit</Trans>}\n                type=\"number\"\n                variant=\"outlined\"\n                value={tempLimit}\n                onChange={handleLimitChange}\n                size=\"small\"\n                inputProps={{\n                  'data-testid': 'query-limit',\n                }}\n              />\n              <Box ml={1} position=\"relative\">\n                <LookbackButton\n                  onClick={toggleLookbackMenu}\n                  isShowingLookbackMenu={isShowingLookbackMenu}\n                >\n                  {lookbackDisplay}\n                </LookbackButton>\n                {isShowingLookbackMenu && (\n                  <LookbackMenu\n                    close={closeLookbackMenu}\n                    onChange={setTempLookback}\n                    lookback={tempLookback}\n                  />\n                )}\n              </Box>\n            </Box>\n          </Container>\n        </Collapse>\n        {traceSummaries.length > 0 && (\n          <>\n            <Box mt={1.5} mb={1.5}>\n              <Divider />\n            </Box>\n            <Container>\n              <Box\n                display=\"flex\"\n                justifyContent=\"space-between\"\n                alignItems=\"center\"\n              >\n                <Typography variant=\"h6\">\n                  {filteredTraceSummaries.length === 1 ? (\n                    <Trans>1 Result</Trans>\n                  ) : (\n                    <Trans>{filteredTraceSummaries.length} Results</Trans>\n                  )}\n                </Typography>\n\n                <Box display=\"flex\">\n                  <ButtonGroup>\n                    <Button onClick={expandAll}>Expand All</Button>\n                    <Button onClick={collapseAll}>Collapse All</Button>\n                  </ButtonGroup>\n                  <Box width={300} ml={2}>\n                    <Autocomplete\n                      multiple\n                      value={filters}\n                      options={filterOptions}\n                      renderInput={(params) => (\n                        <TextField\n                          {...params}\n                          variant=\"outlined\"\n                          label=\"Service filters\"\n                          placeholder=\"Service filters\"\n                          size=\"small\"\n                        />\n                      )}\n                      size=\"small\"\n                      onChange={handleFiltersChange}\n                    />\n                  </Box>\n                </Box>\n              </Box>\n            </Container>\n          </>\n        )}\n      </Box>\n      <Box flexGrow={1} overflow=\"auto\" pt={3} pb={3}>\n        <Container>{content}</Container>\n      </Box>\n    </Box>\n  );\n};\n\nexport default DiscoverPageContent;\n\nconst LookbackButton = styled(\n  ({\n    isShowingLookbackMenu,\n    ...rest\n  }: { isShowingLookbackMenu: boolean } & ButtonProps) => (\n    <Button\n      variant=\"outlined\"\n      startIcon={<FontAwesomeIcon icon={faHistory} />}\n      endIcon={isShowingLookbackMenu ? <ExpandLessIcon /> : <ExpandMoreIcon />}\n      {...rest}\n    />\n  ),\n)`\n  /* Align LookbackButton height with the TextField height. */\n  padding-top: 7.5px;\n  padding-bottom: 7.5px;\n`;\n\nconst SearchButton = styled(Button).attrs({\n  variant: 'contained',\n  color: 'primary',\n  startIcon: <FontAwesomeIcon icon={faSync} />,\n})`\n  flex-shrink: 0;\n  height: 60px;\n  min-width: 60px;\n  color: ${({ theme }) => theme.palette.common.white};\n`;\n\nconst SettingsButton = styled(\n  ({ isOpening, ...rest }: { isOpening: boolean } & ButtonProps) => (\n    <Button\n      variant=\"outlined\"\n      endIcon={isOpening ? <ExpandLessIcon /> : <ExpandMoreIcon />}\n      {...rest}\n    />\n  ),\n)`\n  flex-shrink: 0;\n  height: 60px;\n  min-width: 0px;\n  margin-left: ${({ theme }) => theme.spacing(1)}px;\n`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-param-reassign */\n\nimport {\n  SerializedError,\n  createAsyncThunk,\n  createSlice,\n} from '@reduxjs/toolkit';\n\nimport * as api from '../constants/api';\n\nexport const loadAutocompleteKeys = createAsyncThunk(\n  'autocompleteKeys/fetch',\n  async () => {\n    const resp = await fetch(api.AUTOCOMPLETE_KEYS);\n    if (!resp.ok) {\n      throw Error(resp.statusText);\n    }\n    const json = await resp.json();\n    return json as string[];\n  },\n);\n\nexport interface AutocompleteKeysState {\n  isLoading: boolean;\n  autocompleteKeys: string[];\n  error?: SerializedError;\n}\n\nconst initialState: AutocompleteKeysState = {\n  isLoading: false,\n  autocompleteKeys: [],\n  error: undefined,\n};\n\nconst autocompleteKeysSlice = createSlice({\n  name: 'autocompleteKeys',\n  initialState,\n  reducers: {},\n  extraReducers: (builder) => {\n    builder.addCase(loadAutocompleteKeys.pending, (state) => {\n      state.isLoading = true;\n      state.autocompleteKeys = [];\n      state.error = undefined;\n    });\n    builder.addCase(loadAutocompleteKeys.fulfilled, (state, action) => {\n      state.isLoading = false;\n      state.autocompleteKeys = action.payload;\n      state.error = undefined;\n    });\n    builder.addCase(loadAutocompleteKeys.rejected, (state, action) => {\n      state.isLoading = false;\n      state.autocompleteKeys = [];\n      state.error = action.error;\n    });\n  },\n});\n\nexport default autocompleteKeysSlice;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\n/* eslint-disable no-shadow */\n\nimport { Trans } from '@lingui/macro';\nimport { Box, CircularProgress, Typography } from '@material-ui/core';\nimport React, { useEffect } from 'react';\nimport { connect } from 'react-redux';\nimport { ThunkDispatch } from 'redux-thunk';\n\nimport DiscoverPageContent from './DiscoverPageContent';\nimport { useUiConfig } from '../UiConfig';\nimport { loadAutocompleteKeys } from '../../slices/autocompleteKeysSlice';\nimport { RootState } from '../../store';\n\ninterface DiscoverPageImplProps {\n  autocompleteKeys: string[];\n  isLoadingAutocompleteKeys: boolean;\n  loadAutocompleteKeys: () => void;\n}\n\nconst DiscoverPageImpl: React.FC<DiscoverPageImplProps> = ({\n  autocompleteKeys,\n  isLoadingAutocompleteKeys,\n  loadAutocompleteKeys,\n}) => {\n  const config = useUiConfig();\n\n  useEffect(() => {\n    loadAutocompleteKeys();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  if (!config.searchEnabled) {\n    return (\n      <Typography variant=\"body1\">\n        <Trans>\n          Searching has been disabled via the searchEnabled property. You can\n          still view specific traces of which you know the trace id by entering\n          it in the \"Trace ID...\" textbox on the top-right.\n        </Trans>\n      </Typography>\n    );\n  }\n\n  if (isLoadingAutocompleteKeys) {\n    // Need to fetch autocompleteKeys before displaying a search bar,\n    // because SearchBar uses autocompleteKeys inside.\n    return (\n      <Box\n        height=\"100vh\"\n        width=\"100%\"\n        top={0}\n        position=\"fixed\"\n        display=\"flex\"\n        alignItems=\"center\"\n        justifyContent=\"center\"\n      >\n        <CircularProgress />\n      </Box>\n    );\n  }\n\n  return <DiscoverPageContent autocompleteKeys={autocompleteKeys} />;\n};\n\n// For unit testing, `connect` is easier to use than\n// `useSelector` or `useDispatch` hooks.\nconst mapStateToProps = (state: RootState) => ({\n  autocompleteKeys: state.autocompleteKeys.autocompleteKeys,\n  isLoadingAutocompleteKeys: state.autocompleteKeys.isLoading,\n});\n\nconst mapDispatchToProps = (\n  dispatch: ThunkDispatch<RootState, undefined, any>,\n) => ({\n  loadAutocompleteKeys: () => {\n    dispatch(loadAutocompleteKeys());\n  },\n});\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DiscoverPageImpl);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\n\nexport const spanTagPropTypes = PropTypes.shape({\n  key: PropTypes.string.isRequired,\n  value: PropTypes.string.isRequired,\n});\n\nexport const spanTagsPropTypes = PropTypes.arrayOf(spanTagPropTypes);\n\nexport const spanAnnotationPropTypes = PropTypes.shape({\n  value: PropTypes.string.isRequired,\n  timestamp: PropTypes.number.isRequired,\n  endpoint: PropTypes.string.isRequired,\n  relativeTime: PropTypes.string.isRequired,\n});\n\nexport const spanAnnotationsPropTypes = PropTypes.arrayOf(\n  spanAnnotationPropTypes,\n);\n\n// TODO: Verify which fields we should enforce here, as some are optional per\n// https://github.com/openzipkin/zipkin-api/blob/master/zipkin2-api.yaml\nexport const detailedSpanPropTypes = PropTypes.shape({\n  spanId: PropTypes.string.isRequired,\n  spanName: PropTypes.string.isRequired,\n  parentId: PropTypes.string,\n  childIds: PropTypes.arrayOf(PropTypes.string).isRequired,\n  serviceName: PropTypes.string.isRequired,\n  serviceNames: PropTypes.arrayOf(PropTypes.string).isRequired,\n  timestamp: PropTypes.number.isRequired,\n  duration: PropTypes.number,\n  durationStr: PropTypes.string,\n  tags: spanTagsPropTypes.isRequired,\n  annotations: spanAnnotationsPropTypes.isRequired,\n  errorType: PropTypes.string.isRequired,\n  // Data for Trace Timeline\n  depth: PropTypes.number.isRequired,\n  width: PropTypes.number.isRequired,\n  left: PropTypes.number.isRequired,\n});\n\nexport const detailedSpansPropTypes = PropTypes.arrayOf(detailedSpanPropTypes);\n\nexport const spanServiceNameSummary = PropTypes.shape({\n  serviceName: PropTypes.string.isRequired,\n  spanCount: PropTypes.number.isRequired,\n});\n\nexport const spanServiceNameSummaries = PropTypes.arrayOf(\n  spanServiceNameSummary,\n);\n\nexport const traceSummaryPropTypes = PropTypes.shape({\n  traceId: PropTypes.string.isRequired,\n  timestamp: PropTypes.number.isRequired,\n  duration: PropTypes.number.isRequired,\n  durationStr: PropTypes.string.isRequired,\n  servicePercentage: PropTypes.number,\n  serviceSummaries: spanServiceNameSummaries.isRequired,\n  infoClass: PropTypes.string,\n  spanCount: PropTypes.number.isRequired,\n  width: PropTypes.number.isRequired,\n});\n\nexport const traceSummariesPropTypes = PropTypes.arrayOf(traceSummaryPropTypes);\n\nexport const detailedTraceSummaryPropTypes = PropTypes.shape({\n  traceId: PropTypes.string.isRequired,\n  spans: detailedSpansPropTypes.isRequired,\n  serviceNameAndSpanCounts: spanServiceNameSummaries.isRequired,\n  duration: PropTypes.number.isRequired,\n  durationStr: PropTypes.string.isRequired,\n  rootSpan: PropTypes.shape({\n    serviceName: PropTypes.string.isRequired,\n    spanName: PropTypes.string.isRequired,\n  }).isRequired,\n});\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { t, Trans } from '@lingui/macro';\nimport { useLingui } from '@lingui/react';\nimport PropTypes from 'prop-types';\nimport React, { useCallback } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { faDownload, faFileAlt } from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Grid from '@material-ui/core/Grid';\nimport Button from '@material-ui/core/Button';\nimport Typography from '@material-ui/core/Typography';\n\nimport { setAlert } from '../App/slice';\n\nimport { useUiConfig } from '../UiConfig';\n\nimport { detailedTraceSummaryPropTypes } from '../../prop-types';\nimport * as api from '../../constants/api';\n\nconst propTypes = {\n  traceSummary: detailedTraceSummaryPropTypes,\n  rootSpanIndex: PropTypes.number,\n};\n\nconst defaultProps = {\n  traceSummary: null,\n  rootSpanIndex: 0,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    paddingLeft: theme.spacing(3),\n    paddingRight: theme.spacing(3),\n  },\n  upperBox: {\n    width: '100%',\n    display: 'flex',\n    borderBottom: `1px solid ${theme.palette.grey[300]}`,\n    paddingTop: theme.spacing(1),\n  },\n  serviceNameAndSpanName: {\n    display: 'flex',\n    alignItems: 'center',\n  },\n  serviceName: {\n    textTransform: 'uppercase',\n  },\n  spanName: {\n    color: theme.palette.text.secondary,\n  },\n  lowerBox: {\n    marginTop: theme.spacing(0.5),\n    marginBottom: theme.spacing(0.5),\n  },\n  traceInfo: {\n    display: 'flex',\n    alignItems: 'center',\n  },\n  traceInfoEntry: {\n    marginRight: theme.spacing(1),\n    display: 'flex',\n  },\n  traceInfoLabel: {\n    fontWeight: 'bold',\n    color: theme.palette.grey[600],\n  },\n  traceInfoValue: {\n    fontWeight: 'bold',\n    marginLeft: theme.spacing(0.8),\n  },\n  actionButton: {\n    fontSize: '0.7rem',\n    lineHeight: 1.0,\n  },\n  actionButtonIcon: {\n    marginRight: theme.spacing(1),\n  },\n}));\n\nconst TraceSummaryHeader = React.memo(({ traceSummary, rootSpanIndex }) => {\n  const dispatch = useDispatch();\n  const classes = useStyles();\n  const { i18n } = useLingui();\n  const config = useUiConfig();\n\n  const logsUrl =\n    config.logsUrl && traceSummary\n      ? config.logsUrl.replace(/{traceId}/g, traceSummary.traceId)\n      : undefined;\n\n  const traceJsonUrl = traceSummary\n    ? `${api.TRACE}/${traceSummary.traceId}`\n    : undefined;\n\n  const archivePostUrl =\n    config.archivePostUrl && traceSummary ? config.archivePostUrl : undefined;\n\n  const archiveUrl =\n    config.archiveUrl && traceSummary\n      ? config.archiveUrl.replace('{traceId}', traceSummary.traceId)\n      : undefined;\n\n  const archiveClick = useCallback(() => {\n    // We don't store the raw json in the browser yet, so we need to make an\n    // HTTP call to retrieve it again.\n    fetch(`${api.TRACE}/${traceSummary.traceId}`)\n      .then((response) => {\n        if (!response.ok) {\n          throw new Error('Failed to fetch trace from backend');\n        }\n        return response.json();\n      })\n      .then((json) => {\n        // Add zipkin.archived tag to root span\n        /* eslint-disable-next-line no-restricted-syntax */\n        for (const span of json) {\n          if ('parentId' in span === false) {\n            const tags = span.tags || {};\n            tags['zipkin.archived'] = 'true';\n            span.tags = tags;\n            break;\n          }\n        }\n        return json;\n      })\n      .then((json) => {\n        return fetch(archivePostUrl, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(json),\n        });\n      })\n      .then((response) => {\n        if (\n          !response.ok ||\n          (response.status !== 202 && response.status === 200)\n        ) {\n          throw new Error('Failed to archive the trace');\n        }\n        if (archiveUrl) {\n          dispatch(\n            setAlert({\n              message: `Archive successful! This trace is now accessible at ${archiveUrl}`,\n              severity: 'success',\n            }),\n          );\n        } else {\n          dispatch(\n            setAlert({\n              message: `Archive successful!`,\n              severity: 'success',\n            }),\n          );\n        }\n      })\n      .catch(() => {\n        dispatch(\n          setAlert({\n            message: 'Failed to archive the trace',\n            severity: 'error',\n          }),\n        );\n      });\n  }, [archivePostUrl, archiveUrl, dispatch, traceSummary]);\n\n  const traceInfo = traceSummary ? (\n    <Box className={classes.traceInfo}>\n      {[\n        { label: i18n._(t`Duration`), value: traceSummary.durationStr },\n        {\n          label: i18n._(t`Services`),\n          value: traceSummary.serviceNameAndSpanCounts.length,\n        },\n        { label: i18n._(t`Depth`), value: traceSummary.depth },\n        { label: i18n._(t`Total Spans`), value: traceSummary.spans.length },\n        {\n          label: i18n._(t`Trace ID`),\n          value:\n            rootSpanIndex === 0\n              ? traceSummary.traceId\n              : `${traceSummary.traceId} - ${traceSummary.spans[rootSpanIndex].spanId}`,\n        },\n      ].map((entry) => (\n        <Box key={entry.label} className={classes.traceInfoEntry}>\n          <Box className={classes.traceInfoLabel}>{`${entry.label}:`}</Box>\n          <Box className={classes.traceInfoValue}>{entry.value}</Box>\n        </Box>\n      ))}\n    </Box>\n  ) : (\n    <div />\n  );\n\n  return (\n    <Box className={classes.root}>\n      <Box className={classes.upperBox}>\n        {traceSummary ? (\n          <>\n            <Typography variant=\"h5\" className={classes.serviceName}>\n              {traceSummary.rootSpan.serviceName}\n            </Typography>\n            <Typography variant=\"h5\" className={classes.spanName}>\n              {` : ${traceSummary.rootSpan.spanName}`}\n            </Typography>\n          </>\n        ) : null}\n      </Box>\n      <Grid container className={classes.lowerBox} justify=\"space-between\">\n        <Grid item xs={8}>\n          {traceInfo}\n        </Grid>\n        <Grid container item xs={4} justify=\"flex-end\" spacing={1}>\n          <Grid item>\n            <Button\n              variant=\"outlined\"\n              className={classes.actionButton}\n              href={traceJsonUrl}\n              download={traceSummary && `${traceSummary.traceId}.json`}\n              data-testid=\"download-json-link\"\n            >\n              <FontAwesomeIcon\n                icon={faDownload}\n                className={classes.actionButtonIcon}\n              />\n              <Trans>Download JSON</Trans>\n            </Button>\n          </Grid>\n          {logsUrl && (\n            <Grid item>\n              <Button\n                variant=\"outlined\"\n                className={classes.actionButton}\n                href={logsUrl}\n                target=\"_blank\"\n                rel=\"noopener\"\n                data-testid=\"view-logs-link\"\n              >\n                <FontAwesomeIcon\n                  icon={faFileAlt}\n                  className={classes.actionButtonIcon}\n                />\n                <Trans>View Logs</Trans>\n              </Button>\n            </Grid>\n          )}\n          {archivePostUrl && (\n            <Grid item>\n              <Button\n                variant=\"outlined\"\n                className={classes.actionButton}\n                target=\"_blank\"\n                rel=\"noopener\"\n                data-testid=\"archive-trace-link\"\n                onClick={archiveClick}\n              >\n                <FontAwesomeIcon\n                  icon={faFileAlt}\n                  className={classes.actionButtonIcon}\n                />\n                <Trans>Archive Trace</Trans>\n              </Button>\n            </Grid>\n          )}\n        </Grid>\n      </Grid>\n    </Box>\n  );\n});\n\nTraceSummaryHeader.propTypes = propTypes;\nTraceSummaryHeader.defaultProps = defaultProps;\n\nexport default TraceSummaryHeader;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n/* eslint-disable max-len */\n\n//\n// |-------|--------------|------------------------------------|------|\n//                                                                                         _\n//          ______________            ___________________               _                  |\n//         | SERVICE NAME |          |   DURATION BAR    |              |  spanBarHeight   | spanBarRowHeight\n//          --------------            -------------------               -                  |\n//                                                                                         -\n//\n// |-------|                                                   |------|\n//   spanTreeWidthPercent                                        timelineRightMarginPercent\n//         |--------------|\n//           serviceNameWidthPercent\n//                        |------------------------------------|\n//                          timelineWidthPercent\n//\nexport const spanTreeWidthPercent = 10; // %\nexport const serviceNameWidthPercent = 18; // %\nexport const timelineRightMarginPercent = 2; // %\nexport const timelineWidthPercent =\n  100 -\n  (spanTreeWidthPercent + serviceNameWidthPercent + timelineRightMarginPercent);\nexport const spanBarRowHeight = 30; // px\nexport const spanBarHeight = spanBarRowHeight - 4; // px;\n\nexport const spanTreeLineWidthPercentPerDepth = (depth) =>\n  spanTreeWidthPercent / (depth + 1); // %\nexport const serviceNameBadgeWidth = serviceNameWidthPercent - 2;\nexport const serviceNameBadgeHeight = 20;\nexport const serviceNameBadgeTranslate = `translate(16,${\n  -serviceNameBadgeHeight / 2\n})`; // px\nexport const spanToggleButtonLengthOfSide = 16; // px\nexport const spanToggleButtonTranslate = `translate(${\n  -spanToggleButtonLengthOfSide / 2\n},${-spanToggleButtonLengthOfSide / 2})`; // px\n\n//\n//                                                             _     _    _\n//                                                             |     |    |\n//                                                             | A's spanBarRowOffsetY\n//                                                             |     |    |\n//            _____________________________                    _     |    |\n// ----------|            SPAN A           |-----------------        |    |\n//            -----------------------------                          |    |\n//                                                                   | B's spanBarRowOffsetY\n//                       ______________________________              _    |\n// ---------------------|            SPAN B            |------            - B's spanBarLinePosY\n//                       ------------------------------\n//\n//                      |------------------------------|\n//                           B's spanBarWidthPercent\n// |--------------------|\n//   spanBarOffsetXPercent\n//\nexport const spanBarRowOffsetY = (index) => index * spanBarRowHeight; // px\nexport const spanBarOffsetY = (index) => spanBarRowOffsetY(index) + 2; // px\nexport const spanBarLinePosY = (index) =>\n  spanBarRowOffsetY(index) + spanBarRowHeight / 2; // px\nexport const spanBarWidthPercent = (width) =>\n  timelineWidthPercent * (width / 100); // %\nexport const spanBarOffsetXPercent = (left) =>\n  spanTreeWidthPercent +\n  serviceNameWidthPercent +\n  timelineWidthPercent * (left / 100); // %\n\nexport const timelineHeight = (spanCounts) => spanBarRowHeight * spanCounts; // px\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React, { useMemo } from 'react';\nimport { makeStyles } from '@material-ui/styles';\n\nimport {\n  spanBarLinePosY,\n  spanToggleButtonTranslate,\n  spanTreeLineWidthPercentPerDepth,\n  spanToggleButtonLengthOfSide,\n  serviceNameWidthPercent,\n  spanTreeWidthPercent,\n  serviceNameBadgeTranslate,\n  serviceNameBadgeWidth,\n  serviceNameBadgeHeight,\n} from '../sizing';\nimport { detailedSpansPropTypes } from '../../../prop-types';\nimport { selectServiceColor } from '../../../constants/color';\n\nexport const buildTraceTree = (spans, childrenHiddenSpanIds) => {\n  const stack = [];\n\n  const horizontalLineDataList = [];\n  const verticalLineDataList = [];\n  const buttonDataList = [];\n  const serviceNameDataList = [];\n\n  for (let i = 0; i < spans.length; i += 1) {\n    const currentSpan = spans[i];\n\n    // This is a root span.\n    if (stack.length === 0) {\n      stack.push({ index: i, depth: currentSpan.depth });\n      continue;\n    }\n\n    const stackTop = stack[stack.length - 1];\n\n    // X  stackTop (parent)\n    // |\n    // |---Y  currentSpan\n    if (stackTop.depth < currentSpan.depth) {\n      const parent = stackTop;\n      stack.push({ index: i, depth: currentSpan.depth });\n      // X\n      // |\n      // |+++Y  <- Write this horizontal line.\n      horizontalLineDataList.push({ x: parent.depth, y: i });\n      serviceNameDataList.push({\n        x: currentSpan.depth,\n        y: i,\n        serviceName: currentSpan.serviceName,\n      });\n      if (childrenHiddenSpanIds[currentSpan.spanId]) {\n        buttonDataList.push({\n          x: currentSpan.depth,\n          y: i,\n          spanId: currentSpan.spanId,\n          isClosed: true,\n        });\n      }\n      continue;\n    }\n\n    // X  parent\n    // |\n    // |---Y  stackTop\n    // |\n    // |---Z  currentSpan\n    if (stackTop.depth === currentSpan.depth) {\n      stack.pop();\n      const parent = stack[stack.length - 1];\n      stack.push({ index: i, depth: currentSpan.depth });\n      // X\n      // |\n      // |---Y\n      // |\n      // |+++Z  <- Write this horizontal line.\n      horizontalLineDataList.push({ x: parent.depth, y: i });\n      serviceNameDataList.push({\n        x: currentSpan.depth,\n        y: i,\n        serviceName: currentSpan.serviceName,\n      });\n      if (childrenHiddenSpanIds[currentSpan.spanId]) {\n        buttonDataList.push({\n          x: currentSpan.depth,\n          y: i,\n          spanId: currentSpan.spanId,\n          isClosed: true,\n        });\n      }\n      continue;\n    }\n\n    // A  parent\n    // |\n    // |---B\n    // |   |\n    // |   |---C  stackTop\n    // |\n    // |---D  currentSpan\n    if (stackTop.depth > currentSpan.depth) {\n      const popped = [];\n      for (let j = stack.length - 1; j >= 0; j -= 1) {\n        if (stack[j].depth < currentSpan.depth) {\n          break;\n        }\n        popped.push(stack.pop());\n      }\n      const parent = stack[stack.length - 1];\n      stack.push({ index: i, depth: currentSpan.depth });\n      // A\n      // |\n      // |---B\n      // |   |\n      // |   |---C\n      // |\n      // |+++D  <- Write this horizontal line.\n      horizontalLineDataList.push({ x: parent.depth, y: i });\n      serviceNameDataList.push({\n        x: currentSpan.depth,\n        y: i,\n        serviceName: currentSpan.serviceName,\n      });\n      if (childrenHiddenSpanIds[currentSpan.spanId]) {\n        buttonDataList.push({\n          x: currentSpan.depth,\n          y: i,\n          spanId: currentSpan.spanId,\n          isClosed: true,\n        });\n      }\n      for (let j = 0; j < popped.length - 1; j += 1) {\n        // A\n        // |\n        // |---B\n        // |   +      <- Write these vertical lines.\n        // |   +---C\n        // |\n        // |---D\n        verticalLineDataList.push({\n          x: popped[j + 1].depth,\n          y1: popped[j].index,\n          y2: popped[j + 1].index,\n        });\n        buttonDataList.push({\n          x: popped[j + 1].depth,\n          y: popped[j + 1].index,\n          spanId: spans[popped[j + 1].index].spanId,\n        });\n      }\n      continue;\n    }\n  }\n  // A++++  Root span. Write this horizontal line.\n  // |\n  // |---B\n  horizontalLineDataList.push({ x: spans[0].depth, y: 0 });\n  serviceNameDataList.push({\n    x: spans[0].depth,\n    y: 0,\n    serviceName: spans[0].serviceName,\n  });\n  if (childrenHiddenSpanIds[spans[0].spanId]) {\n    buttonDataList.push({\n      x: spans[0].depth,\n      y: 0,\n      spanId: spans[0].spanId,\n      isClosed: true,\n    });\n  }\n\n  for (let j = 0; j < stack.length - 1; j += 1) {\n    // A  Root span\n    // +         <- Write these vertical lines.\n    // +---B\n    //     +\n    //     +---C\n    verticalLineDataList.push({\n      x: stack[j].depth,\n      y1: stack[j].index,\n      y2: stack[j + 1].index,\n    });\n    buttonDataList.push({\n      x: stack[j].depth,\n      y: stack[j].index,\n      spanId: spans[stack[j].index].spanId,\n    });\n  }\n\n  return {\n    horizontalLineDataList,\n    verticalLineDataList,\n    buttonDataList,\n    serviceNameDataList,\n  };\n};\n\nconst propTypes = {\n  spans: detailedSpansPropTypes.isRequired,\n  depth: PropTypes.number.isRequired,\n  childrenHiddenSpanIds: PropTypes.shape({}).isRequired,\n  onChildrenToggle: PropTypes.func.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  line: {\n    stroke: theme.palette.grey[300],\n    strokeWidth: '1px',\n  },\n  spanToggleButton: {\n    cursor: 'pointer',\n    opacity: 0,\n    backgroundColor: theme.palette.grey[300],\n    '&:hover': {\n      opacity: 0.1,\n    },\n  },\n  buttonIcon: {\n    stroke: theme.palette.grey[800],\n    strokeWidth: 2,\n  },\n  spanToggleButtonInternal: {\n    stroke: theme.palette.grey[700],\n    strokeWidth: 1,\n    fill: theme.palette.common.white,\n  },\n  serviceBadgeText: {\n    textTransform: 'uppercase',\n  },\n}));\n\nconst TraceTree = React.memo(\n  ({ spans, depth, childrenHiddenSpanIds, onChildrenToggle }) => {\n    const classes = useStyles();\n    const {\n      horizontalLineDataList,\n      verticalLineDataList,\n      buttonDataList,\n      serviceNameDataList,\n    } = useMemo(() => buildTraceTree(spans, childrenHiddenSpanIds), [\n      spans,\n      childrenHiddenSpanIds,\n    ]);\n\n    return (\n      <g>\n        {horizontalLineDataList.map(({ x, y }) => (\n          <line\n            key={`${x}-${y}`}\n            x1={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n            x2={`${spanTreeWidthPercent + serviceNameWidthPercent}%`}\n            y1={spanBarLinePosY(y)}\n            y2={spanBarLinePosY(y)}\n            className={classes.line}\n          />\n        ))}\n        {serviceNameDataList.map(({ x, y, serviceName }) => (\n          <g transform={serviceNameBadgeTranslate} key={`${x}-${y}`}>\n            <svg\n              x={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n              y={spanBarLinePosY(y)}\n              width={`${serviceNameBadgeWidth}%`}\n              height={serviceNameBadgeHeight}\n            >\n              <rect\n                rx={3}\n                ry={3}\n                x={0}\n                y={0}\n                width=\"100%\"\n                height=\"100%\"\n                fill={selectServiceColor(serviceName)}\n              />\n              <text\n                x=\"50%\"\n                y=\"50%\"\n                textAnchor=\"middle\"\n                dominantBaseline=\"central\"\n                fill=\"white\"\n                className={classes.serviceBadgeText}\n              >\n                {serviceName}\n              </text>\n            </svg>\n          </g>\n        ))}\n        {verticalLineDataList.map(({ x, y1, y2 }) => (\n          <line\n            key={`${x}-${y1}-${y2}`}\n            x1={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n            x2={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n            y1={spanBarLinePosY(y1)}\n            y2={spanBarLinePosY(y2)}\n            className={classes.line}\n          />\n        ))}\n        {buttonDataList.map(({ x, y, spanId, isClosed }) => (\n          <g key={spanId} transform={spanToggleButtonTranslate}>\n            <rect\n              rx={2}\n              ry={2}\n              x={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n              y={spanBarLinePosY(y)}\n              width={spanToggleButtonLengthOfSide}\n              height={spanToggleButtonLengthOfSide}\n              className={classes.spanToggleButtonInternal}\n            />\n            <svg\n              x={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n              y={spanBarLinePosY(y)}\n              className={classes.buttonIcon}\n            >\n              <line\n                x1={0}\n                x2={spanToggleButtonLengthOfSide}\n                y1={spanToggleButtonLengthOfSide / 2}\n                y2={spanToggleButtonLengthOfSide / 2}\n              />\n              {isClosed ? (\n                <line\n                  x1={spanToggleButtonLengthOfSide / 2}\n                  x2={spanToggleButtonLengthOfSide / 2}\n                  y1={0}\n                  y2={spanToggleButtonLengthOfSide}\n                />\n              ) : null}\n            </svg>\n            <rect\n              rx={2}\n              ry={2}\n              x={`${x * spanTreeLineWidthPercentPerDepth(depth)}%`}\n              y={spanBarLinePosY(y)}\n              width={spanToggleButtonLengthOfSide}\n              height={spanToggleButtonLengthOfSide}\n              onClick={() => onChildrenToggle(spanId)}\n              className={classes.spanToggleButton}\n            />\n          </g>\n        ))}\n      </g>\n    );\n  },\n);\n\nTraceTree.propTypes = propTypes;\n\nexport default TraceTree;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React, { useMemo, useCallback } from 'react';\nimport classnames from 'classnames';\nimport { makeStyles } from '@material-ui/styles';\n\nimport {\n  spanBarRowOffsetY,\n  spanBarOffsetY,\n  spanBarRowHeight,\n  spanBarWidthPercent,\n  spanBarOffsetXPercent,\n  spanTreeWidthPercent,\n  serviceNameWidthPercent,\n  spanBarLinePosY,\n  spanBarHeight,\n} from '../sizing';\nimport { detailedSpanPropTypes } from '../../../prop-types';\nimport { selectColorByErrorType } from '../../../constants/color';\n\nconst minWidth = 0.25;\n\nconst propTypes = {\n  span: detailedSpanPropTypes.isRequired,\n  index: PropTypes.number.isRequired,\n  onRowClick: PropTypes.func.isRequired,\n  isFocused: PropTypes.bool.isRequired,\n  startTs: PropTypes.number.isRequired,\n  endTs: PropTypes.number.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  line: {\n    stroke: theme.palette.grey[300],\n    strokeWidth: '1px',\n  },\n  bar: {\n    opacity: 0.8,\n  },\n  row: {\n    opacity: 0,\n    fill: theme.palette.grey[500],\n    cursor: 'pointer',\n    '&:hover': {\n      opacity: 0.2,\n    },\n  },\n  'row--focused': {\n    opacity: 0.3,\n  },\n  text: {\n    fontSize: '1.03rem',\n  },\n}));\n\nconst calculateLeftAndWidth = (startTs, endTs, spanDuration, spanTimestamp) => {\n  const duration = endTs - startTs;\n  if (spanDuration) {\n    return {\n      width: Math.max((spanDuration / duration) * 100, minWidth),\n      left: ((spanTimestamp - startTs) / duration) * 100,\n    };\n  }\n  // If duration is 0, it can be considered that this span is the only\n  // span displayed on the trace timeline graph.\n  // In that case, width should be 100% and left should be 0%.\n  if (duration === 0) {\n    return {\n      width: 100,\n      left: 0,\n    };\n  }\n  // Even if the span doesn't have duration, should give the span the width\n  // to display it in the UI.\n  return {\n    width: minWidth,\n    left: ((spanTimestamp - startTs) / duration) * 100,\n  };\n};\n\nconst TraceTimelineRow = React.memo(\n  ({ span, index, onRowClick, isFocused, startTs, endTs }) => {\n    const classes = useStyles();\n    const { left, width } = useMemo(\n      () =>\n        calculateLeftAndWidth(startTs, endTs, span.duration, span.timestamp),\n      [startTs, endTs, span.duration, span.timestamp],\n    );\n    const handleClick = useCallback(() => onRowClick(span.spanId), [\n      onRowClick,\n      span.spanId,\n    ]);\n    const durationStr = span.durationStr ? `[${span.durationStr}]` : '';\n    const isTextLeft = endTs - span.timestamp > (endTs - startTs) / 2;\n\n    return (\n      <g>\n        <line\n          x1={`${spanTreeWidthPercent + serviceNameWidthPercent}%`}\n          x2=\"100%\"\n          y1={spanBarLinePosY(index)}\n          y2={spanBarLinePosY(index)}\n          className={classes.line}\n        />\n        <rect\n          width={`${spanBarWidthPercent(width)}%`}\n          height={spanBarHeight}\n          x={`${spanBarOffsetXPercent(left)}%`}\n          y={spanBarOffsetY(index)}\n          rx={4}\n          ry={4}\n          className={classes.bar}\n          style={{\n            fill: selectColorByErrorType(span.errorType),\n          }}\n        />\n        {isTextLeft ? (\n          <text\n            x={`${spanBarOffsetXPercent(left) + 1}%`}\n            y={spanBarOffsetY(index) + spanBarRowHeight / 2}\n            className={classes.text}\n          >\n            {`${span.spanName} ${durationStr}`}\n          </text>\n        ) : (\n          <text\n            x={`${\n              spanBarOffsetXPercent(left) + spanBarWidthPercent(width) - 1\n            }%`}\n            y={spanBarOffsetY(index) + spanBarRowHeight / 2}\n            textAnchor=\"end\"\n            className={classes.text}\n          >\n            {`${span.spanName} ${durationStr}`}\n          </text>\n        )}\n        <rect\n          className={classnames(classes.row, {\n            [classes['row--focused']]: isFocused,\n          })}\n          x={0}\n          y={spanBarRowOffsetY(index)}\n          width=\"100%\"\n          height={spanBarRowHeight}\n          onClick={handleClick}\n        />\n      </g>\n    );\n  },\n);\n\nTraceTimelineRow.propTypes = propTypes;\n\nexport default TraceTimelineRow;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport React from 'react';\nimport { makeStyles } from '@material-ui/styles';\n\nimport {\n  spanTreeWidthPercent,\n  serviceNameWidthPercent,\n  timelineWidthPercent,\n} from '../sizing';\n\nconst numTimeMarkers = 4;\n\nconst useStyles = makeStyles((theme) => ({\n  line: {\n    stroke: theme.palette.grey[300],\n    strokeWidth: '1px',\n  },\n}));\n\nconst TimeMarker = React.memo(() => {\n  const classes = useStyles();\n  const timeMarkers = [];\n\n  for (let i = 0; i < numTimeMarkers; i += 1) {\n    const portion = i / (numTimeMarkers - 1);\n    const xPercent =\n      spanTreeWidthPercent +\n      serviceNameWidthPercent +\n      timelineWidthPercent * portion;\n\n    timeMarkers.push(\n      <line\n        key={portion}\n        x1={`${xPercent}%`}\n        x2={`${xPercent}%`}\n        y1=\"0\"\n        y2=\"100%\"\n        className={classes.line}\n      />,\n    );\n  }\n  return <g>{timeMarkers}</g>;\n});\n\nexport default TimeMarker;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React from 'react';\n\nimport TraceTree from './TraceTree';\nimport TraceTimelineRow from './TraceTimelineRow';\nimport { detailedSpansPropTypes } from '../../../prop-types';\nimport { timelineHeight } from '../sizing';\nimport TimeMarker from './TimeMarker';\n\nconst propTypes = {\n  currentSpanId: PropTypes.string.isRequired,\n  spans: detailedSpansPropTypes.isRequired,\n  depth: PropTypes.number.isRequired,\n  childrenHiddenSpanIds: PropTypes.shape({}).isRequired,\n  isRootedTrace: PropTypes.bool.isRequired,\n  onRowClick: PropTypes.func.isRequired,\n  onChildrenToggle: PropTypes.func.isRequired,\n  startTs: PropTypes.number.isRequired,\n  endTs: PropTypes.number.isRequired,\n};\n\nconst TraceTimeline = React.memo(\n  ({\n    currentSpanId,\n    spans,\n    depth,\n    childrenHiddenSpanIds,\n    isRootedTrace,\n    onRowClick,\n    onChildrenToggle,\n    startTs,\n    endTs,\n  }) => (\n    <svg\n      version=\"1.1\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      width=\"100%\"\n      height={`${timelineHeight(spans.length)}px`}\n    >\n      <TimeMarker />\n      {spans.map((span, idx) => (\n        <TraceTimelineRow\n          key={span.spanId}\n          span={span}\n          onRowClick={onRowClick}\n          index={idx}\n          isFocused={currentSpanId === span.spanId}\n          startTs={startTs}\n          endTs={endTs}\n        />\n      ))}\n      {isRootedTrace ? (\n        <TraceTree\n          spans={spans}\n          depth={depth}\n          childrenHiddenSpanIds={childrenHiddenSpanIds}\n          onChildrenToggle={onChildrenToggle}\n        />\n      ) : null}\n    </svg>\n  ),\n);\n\nTraceTimeline.propTypes = propTypes;\n\nexport default TraceTimeline;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React from 'react';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport classNames from 'classnames';\n\nimport {\n  spanTreeWidthPercent,\n  timelineWidthPercent,\n  serviceNameWidthPercent,\n} from '../sizing';\nimport { formatDuration } from '../../../util/timestamp';\n\nconst propTypes = {\n  startTs: PropTypes.number.isRequired,\n  endTs: PropTypes.number.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  marker: {\n    height: '100%',\n    width: '1px',\n    backgroundColor: theme.palette.grey[500],\n    position: 'absolute',\n  },\n  label: {\n    fontSize: '0.8rem',\n    left: '4px',\n    position: 'absolute',\n  },\n  'label--last': {\n    left: 'initial',\n    right: '4px',\n  },\n}));\n\nconst numTimeMarkers = 4;\n\nconst TimeMarker = React.memo(({ startTs, endTs }) => {\n  const classes = useStyles();\n  const timeMarkers = [];\n\n  for (let i = 0; i < numTimeMarkers; i += 1) {\n    const label = startTs + (i / (numTimeMarkers - 1)) * (endTs - startTs);\n    const portion = i / (numTimeMarkers - 1);\n\n    timeMarkers.push(\n      <Box\n        key={portion}\n        position=\"absolute\"\n        className={classes.marker}\n        style={{ left: `${portion * 100}%` }}\n        data-testid=\"TimeMarker-marker\"\n      >\n        <Box\n          component=\"span\"\n          position=\"absolute\"\n          className={classNames(classes.label, {\n            [classes['label--last']]: portion >= 1,\n          })}\n          data-testid=\"TimeMarker-label\"\n        >\n          {formatDuration(label)}\n        </Box>\n      </Box>,\n    );\n  }\n  return (\n    <Box display=\"flex\">\n      <Box width={`${spanTreeWidthPercent + serviceNameWidthPercent}%`} />\n      <Box\n        mt={1}\n        height={15}\n        position=\"relative\"\n        width={`${timelineWidthPercent}%`}\n      >\n        {timeMarkers}\n      </Box>\n    </Box>\n  );\n});\n\nTimeMarker.propTypes = propTypes;\n\nexport default TimeMarker;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport PropTypes from 'prop-types';\nimport React from 'react';\nimport {\n  faAngleUp,\n  faAngleDown,\n  faAngleDoubleRight,\n  faAngleDoubleLeft,\n} from '@fortawesome/free-solid-svg-icons';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Button from '@material-ui/core/Button';\nimport ButtonGroup from '@material-ui/core/ButtonGroup';\n\nimport TimeMarker from './TimeMarker';\n\nconst propTypes = {\n  startTs: PropTypes.number.isRequired,\n  endTs: PropTypes.number.isRequired,\n  isRerooted: PropTypes.bool.isRequired,\n  isRootedTrace: PropTypes.bool.isRequired,\n  onResetRerootButtonClick: PropTypes.func.isRequired,\n  isSpanDetailOpened: PropTypes.bool.isRequired,\n  onSpanDetailToggle: PropTypes.func.isRequired,\n  onCollapseButtonClick: PropTypes.func.isRequired,\n  onExpandButtonClick: PropTypes.func.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    borderBottom: `1px solid ${theme.palette.grey[300]}`,\n    backgroundColor: theme.palette.grey[100],\n  },\n  textButton: {\n    fontSize: '1.2rem',\n    minWidth: '2rem',\n    width: '2rem',\n  },\n}));\n\nconst TraceTimelineHeader = React.memo(\n  ({\n    startTs,\n    endTs,\n    isRerooted,\n    isRootedTrace,\n    onResetRerootButtonClick,\n    isSpanDetailOpened,\n    onSpanDetailToggle,\n    onCollapseButtonClick,\n    onExpandButtonClick,\n  }) => {\n    const classes = useStyles();\n\n    return (\n      <Box className={classes.root}>\n        <Box display=\"flex\" justifyContent=\"space-between\" mt={1} mr={1} ml={1}>\n          <Box display=\"flex\" alignItems=\"center\">\n            <ButtonGroup>\n              <Button\n                className={classes.textButton}\n                disabled={!isRootedTrace}\n                onClick={onCollapseButtonClick}\n              >\n                <FontAwesomeIcon icon={faAngleUp} />\n              </Button>\n              <Button\n                className={classes.textButton}\n                disabled={!isRootedTrace}\n                onClick={onExpandButtonClick}\n              >\n                <FontAwesomeIcon icon={faAngleDown} />\n              </Button>\n            </ButtonGroup>\n            {isRootedTrace && isRerooted ? (\n              <Box ml={1}>\n                <Button variant=\"outlined\" onClick={onResetRerootButtonClick}>\n                  Reset root\n                </Button>\n              </Box>\n            ) : null}\n          </Box>\n          <Button className={classes.textButton} onClick={onSpanDetailToggle}>\n            <FontAwesomeIcon\n              icon={isSpanDetailOpened ? faAngleDoubleRight : faAngleDoubleLeft}\n            />\n          </Button>\n        </Box>\n        <TimeMarker startTs={startTs} endTs={endTs} />\n      </Box>\n    );\n  },\n);\n\nTraceTimelineHeader.propTypes = propTypes;\n\nexport default TraceTimelineHeader;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n// Annotation's value may not be unique, so timestamp is also used in annotation key.\nexport const generateAnnotationKey = (annotation) =>\n  `${annotation.value}-${annotation.timestamp}`;\n\n// Tag's key may not be unique, so value is also used.\nexport const generateTagKey = (tag) => `${tag.key}-${tag.value}`;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport React from 'react';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Table from '@material-ui/core/Table';\nimport TableBody from '@material-ui/core/TableBody';\nimport TableCell from '@material-ui/core/TableCell';\nimport TableRow from '@material-ui/core/TableRow';\nimport Paper from '@material-ui/core/Paper';\n\nimport { generateTagKey } from './util';\nimport { spanTagsPropTypes } from '../../../prop-types';\n\nconst useStyles = makeStyles((theme) => ({\n  cell: {\n    paddingTop: theme.spacing(1),\n    paddingBottom: theme.spacing(1),\n    // overflow-wrap does not work well for elements with \"display: table-cell\",\n    // so use word-break as a workaround.\n    wordBreak: 'break-all',\n  },\n  key: {\n    color: theme.palette.grey[500],\n    fontWeight: theme.typography.fontWeightBold,\n  },\n  value: {\n    fontSize: '1.05rem',\n    'white-space': 'pre-line',\n  },\n}));\n\nconst propTypes = {\n  tags: spanTagsPropTypes.isRequired,\n};\n\nconst SpanTags = React.memo(({ tags }) => {\n  const classes = useStyles();\n\n  return (\n    <Paper>\n      <Table>\n        <TableBody>\n          {tags.map((tag) => (\n            <TableRow key={generateTagKey(tag)}>\n              <TableCell className={classes.cell}>\n                <Box className={classes.key} data-testid=\"SpanTags-key\">\n                  {tag.key}\n                </Box>\n                <Box className={classes.value} data-testid=\"SpanTags-value\">\n                  {tag.value}\n                </Box>\n              </TableCell>\n            </TableRow>\n          ))}\n        </TableBody>\n      </Table>\n    </Paper>\n  );\n});\n\nSpanTags.propTypes = propTypes;\n\nexport default SpanTags;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { t } from '@lingui/macro';\nimport { useLingui } from '@lingui/react';\nimport React from 'react';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Table from '@material-ui/core/Table';\nimport TableBody from '@material-ui/core/TableBody';\nimport TableCell from '@material-ui/core/TableCell';\nimport TableRow from '@material-ui/core/TableRow';\nimport Paper from '@material-ui/core/Paper';\n\nimport { spanAnnotationPropTypes } from '../../../prop-types';\nimport { formatTimestampMicros } from '../../../util/timestamp';\n\nconst propTypes = {\n  annotation: spanAnnotationPropTypes.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  cell: {\n    paddingTop: theme.spacing(1),\n    paddingBottom: theme.spacing(1),\n    // overflow-wrap does not work well for elements with \"display: table-cell\",\n    // so use word-break as a workaround.\n    wordBreak: 'break-all',\n  },\n}));\n\nconst SpanAnnotation = React.memo(({ annotation }) => {\n  const classes = useStyles();\n  const { i18n } = useLingui();\n\n  return (\n    <Box>\n      <Box fontSize=\"1.1rem\" mb={0.5}>\n        {annotation.value}\n      </Box>\n      <Paper>\n        <Table>\n          <TableBody data-testid=\"span-annotation--table-body\">\n            {[\n              {\n                label: i18n._(t`Start Time`),\n                value: formatTimestampMicros(annotation.timestamp),\n              },\n              {\n                label: i18n._(t`Relative Time`),\n                value: annotation.relativeTime,\n              },\n              { label: i18n._(t`Address`), value: annotation.endpoint },\n            ].map((e) => (\n              <TableRow key={e.label}>\n                <TableCell\n                  className={classes.cell}\n                  data-testid=\"span-annotation--label\"\n                >\n                  {e.label}\n                </TableCell>\n                <TableCell\n                  className={classes.cell}\n                  data-testid=\"span-annotation--value\"\n                >\n                  {e.value}\n                </TableCell>\n              </TableRow>\n            ))}\n          </TableBody>\n        </Table>\n      </Paper>\n    </Box>\n  );\n});\n\nSpanAnnotation.propTypes = propTypes;\n\nexport default SpanAnnotation;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Box from '@material-ui/core/Box';\nimport { makeStyles } from '@material-ui/styles';\nimport classnames from 'classnames';\nimport minBy from 'lodash/minBy';\nimport maxBy from 'lodash/maxBy';\n\nimport { selectServiceColor } from '../../../constants/color';\nimport { spanAnnotationsPropTypes } from '../../../prop-types';\nimport { generateAnnotationKey } from './util';\n\n//\n// Size & Position:\n//\n//        ____________________________________           _\n// ------|              SPAN BAR              |-----     | spanBarHeight\n//        ------------------------------------           -\n//\n// |-----------------------------------------------|\n//                     width = 100%\n// |-----|                                    |----|\n//   leftOffsetPercent                      rightOffsetPercent\n//\n//   Spanbar's width and left and right edge coordinates are as follows\n//\n//       |------------------------------------|\n//                    spanBarWidth = 100 - (leftOffsetPercent + rightOffsetPercent) (%)\n//       |\n//       x = leftOffsetPercent (%)\n//                                            |\n//                                          x = 100 - rightOffsetPercent (%)\n//\n// ============================================================================\n//\n// Annotation Position:\n//\n//        ____________________________________           _\n// ------|         @    SPAN BAR              |-----     | spanBarHeight\n//        ------------------------------------           -\n//\n//       |---------|--------------------------|\n//           A%                 100-A%\n//                 |\n//                 x = spanBarWidth * (A / 100) + leftOffsetPercent (%)\n//\n//\n// ============================================================================\n//\n// Example:\n//\n//        ____________________________________           _\n// ------|         @    SPAN BAR              |-----     | spanBarHeight\n//        ------------------------------------           -\n//\n// |-----------------------------------------------|\n//                       width = 100% = 500px\n// |-----|                                    |----|\n//    5%                                         5%\n//       |---------|--------------------------|\n//           30%                70%\n//\n//                 |\n//               x = spanBarWidth * (A / 100) + leftOffsetPercent\n//                 = (100 - (5 + 5)) * (30 / 100) + 5\n//                 = 32%\n//                 = 500 * 0.32 = 160px\n//\n\nconst leftOffsetPercent = 5;\nconst rightOffsetPercent = 5;\nconst spanBarHeight = '16'; // px\n\nconst propTypes = {\n  serviceName: PropTypes.string.isRequired,\n  annotations: spanAnnotationsPropTypes.isRequired,\n  onAnnotationCircleClick: PropTypes.func.isRequired,\n  currentAnnotationKey: PropTypes.string,\n};\n\nconst defaultProps = {\n  currentAnnotationKey: '',\n};\n\nconst useStyles = makeStyles((theme) => ({\n  svg: {\n    stroke: theme.palette.grey[500],\n    strokeWidth: '1px',\n  },\n  circle: {\n    cursor: 'pointer',\n    fill: theme.palette.common.white,\n    '&:hover': {\n      fill: theme.palette.grey[400],\n    },\n  },\n  'circle--selected': {\n    fill: theme.palette.grey[400],\n    strokeWidth: '3px',\n  },\n}));\n\nconst SpanAnnotationGraph = React.memo(\n  ({\n    serviceName,\n    annotations,\n    onAnnotationCircleClick,\n    currentAnnotationKey,\n  }) => {\n    const classes = useStyles();\n\n    let minTs;\n    let maxTs;\n    if (annotations.length === 0) {\n      minTs = 0;\n      maxTs = 0;\n    } else if (annotations.length === 1) {\n      minTs = annotations[0].timestamp;\n      maxTs = minTs + 1;\n    } else {\n      minTs = minBy(annotations, 'timestamp').timestamp;\n      maxTs = maxBy(annotations, 'timestamp').timestamp;\n    }\n\n    const duration = maxTs - minTs;\n\n    return (\n      <Box height=\"50px\" width=\"100%\" display=\"flex\" alignItems=\"center\">\n        <svg width=\"100%\" height={spanBarHeight} className={classes.svg}>\n          <line x1=\"0%\" x2=\"100%\" y1=\"8px\" y2=\"8px\" />\n          <rect\n            x={`${leftOffsetPercent}%`}\n            y=\"0\"\n            width={`${100 - (leftOffsetPercent + rightOffsetPercent)}%`}\n            height={spanBarHeight}\n            rx={2}\n            ry={2}\n            fill={selectServiceColor(serviceName)}\n          />\n          {annotations.map((annotation) => {\n            const annotationKey = generateAnnotationKey(annotation);\n            const cx =\n              (100 - (leftOffsetPercent + rightOffsetPercent)) *\n                ((annotation.timestamp - minTs) / duration) +\n              leftOffsetPercent;\n            return (\n              <circle\n                key={annotationKey}\n                cx={`${cx}%`}\n                cy=\"8px\"\n                r=\"6px\"\n                className={classnames(classes.circle, {\n                  [classes['circle--selected']]:\n                    annotationKey === currentAnnotationKey,\n                })}\n                onClick={() => onAnnotationCircleClick(annotation)}\n                data-testid=\"span-annotation-graph--circle\"\n              />\n            );\n          })}\n        </svg>\n      </Box>\n    );\n  },\n);\n\nSpanAnnotationGraph.propTypes = propTypes;\nSpanAnnotationGraph.defaultProps = defaultProps;\n\nexport default SpanAnnotationGraph;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { Trans } from '@lingui/macro';\nimport React, { useState, useEffect, useCallback, useMemo } from 'react';\nimport Box from '@material-ui/core/Box';\nimport Button from '@material-ui/core/Button';\n\nimport { generateAnnotationKey } from './util';\nimport SpanAnnotation from './SpanAnnotation';\nimport SpanAnnotationGraph from './SpanAnnotationGraph';\nimport { detailedSpanPropTypes } from '../../../prop-types';\n\nconst propTypes = {\n  span: detailedSpanPropTypes.isRequired,\n};\n\nconst SpanAnnotations = React.memo(({ span }) => {\n  const [currentAnnotationKey, setCurrentAnnotationKey] = useState();\n  const [areAllAnnotationsOpened, setAreAllAnnotationsOpened] = useState(false);\n\n  const handleAnnotationCircleClick = useCallback(\n    (annotation) => {\n      // If all annotations have already been expanded, close all of them.\n      if (areAllAnnotationsOpened) {\n        setAreAllAnnotationsOpened(false);\n      }\n      // If an annotation that has already been focused is selected, unfocus it.\n      const key = generateAnnotationKey(annotation);\n      setCurrentAnnotationKey((prev) => (prev === key ? null : key));\n    },\n    [areAllAnnotationsOpened],\n  );\n\n  // Initialize states when a different span is selected.\n  useEffect(() => {\n    setCurrentAnnotationKey(null);\n    setAreAllAnnotationsOpened(false);\n  }, [span.spanId]);\n\n  const currentAnnotation = useMemo(\n    () =>\n      span.annotations.find((annotation) => {\n        const key = generateAnnotationKey(annotation);\n        return key === currentAnnotationKey;\n      }),\n    [currentAnnotationKey, span.annotations],\n  );\n\n  const handleExpandToggle = useCallback(() => {\n    // When expanding all annotations, if any annotation is already selected, clear it.\n    if (!areAllAnnotationsOpened) {\n      setCurrentAnnotationKey(null);\n    }\n    setAreAllAnnotationsOpened((prev) => !prev);\n  }, [areAllAnnotationsOpened]);\n\n  return (\n    <>\n      <SpanAnnotationGraph\n        serviceName={span.serviceName}\n        annotations={span.annotations}\n        onAnnotationCircleClick={handleAnnotationCircleClick}\n        currentAnnotaionKey={currentAnnotationKey}\n      />\n      {\n        /* eslint no-nested-ternary: 0 */\n        areAllAnnotationsOpened ? (\n          span.annotations.map((annotation) => (\n            <Box\n              mt={1}\n              key={generateAnnotationKey(annotation)}\n              data-testid=\"span-annotations--annotation\"\n            >\n              <SpanAnnotation annotation={annotation} />\n            </Box>\n          ))\n        ) : currentAnnotation ? (\n          <Box mt={1} data-testid=\"span-annotations--annotation\">\n            <SpanAnnotation annotation={currentAnnotation} />\n          </Box>\n        ) : null\n      }\n      <Box width=\"100%\" display=\"flex\" justifyContent=\"flex-end\" mt={2}>\n        <Button\n          variant=\"contained\"\n          onClick={handleExpandToggle}\n          data-testid=\"span-annotations--toggle-button\"\n        >\n          {areAllAnnotationsOpened ? (\n            <Trans>hide annotations</Trans>\n          ) : (\n            <Trans>show all annotations</Trans>\n          )}\n        </Button>\n      </Box>\n    </>\n  );\n});\n\nSpanAnnotations.propTypes = propTypes;\n\nexport default SpanAnnotations;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { t, Trans } from '@lingui/macro';\nimport { useLingui } from '@lingui/react';\nimport PropTypes from 'prop-types';\nimport React from 'react';\nimport { makeStyles } from '@material-ui/styles';\nimport Box from '@material-ui/core/Box';\nimport Typography from '@material-ui/core/Typography';\n\nimport SpanTags from './SpanTags';\nimport SpanAnnotations from './SpanAnnotations';\nimport { detailedSpanPropTypes } from '../../../prop-types';\n\nconst propTypes = {\n  span: detailedSpanPropTypes.isRequired,\n  minHeight: PropTypes.number.isRequired,\n};\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    width: '100%',\n    borderLeft: `1px solid ${theme.palette.grey[300]}`,\n    backgroundColor: theme.palette.grey[100],\n  },\n  serviceName: {\n    textTransform: 'uppercase',\n    overflowWrap: 'break-word',\n  },\n  spanName: {\n    color: theme.palette.text.secondary,\n    overflowWrap: 'break-word',\n  },\n  annotationsAndTagsBox: {\n    paddingTop: theme.spacing(1),\n    paddingLeft: theme.spacing(2),\n    paddingRight: theme.spacing(2),\n    paddingBottom: theme.spacing(1.5),\n  },\n  annotationsAndTagsTitle: {\n    fontWeight: 'bold',\n    marginBottom: theme.spacing(0.5),\n  },\n  spanIds: {\n    display: 'flex',\n    justifyContent: 'flex-end',\n    paddingLeft: theme.spacing(2),\n    paddingRight: theme.spacing(2),\n    paddingTop: theme.spacing(0.1),\n    paddingBottom: theme.spacing(0.1),\n    fontSize: '0.8rem',\n    borderBottom: `1px solid ${theme.palette.grey[300]}`,\n  },\n  spanIdEntry: {\n    display: 'flex',\n  },\n  spanIdLabel: {\n    color: theme.palette.grey[700],\n    marginRight: theme.spacing(0.25),\n  },\n  spanIdValue: {\n    color: theme.palette.grey[800],\n    marginRight: theme.spacing(1),\n  },\n}));\n\nconst SpanDetail = React.memo(({ span, minHeight }) => {\n  const classes = useStyles();\n  const { i18n } = useLingui();\n\n  const spanIds = (\n    <Box className={classes.spanIds}>\n      {[\n        { label: i18n._(t`Span ID`), value: span.spanId },\n        { label: i18n._(t`Parent ID`), value: span.parentId },\n      ].map((entry) => (\n        <Box className={classes.spanIdEntry}>\n          <Box className={classes.spanIdLabel}>{`${entry.label}:`}</Box>\n          <Box className={classes.spanIdValue}>\n            {entry.value || <Trans>None</Trans>}\n          </Box>\n        </Box>\n      ))}\n    </Box>\n  );\n\n  return (\n    <Box minHeight={minHeight} className={classes.root}>\n      <Box pt={2} pl={2} pr={2} pb={1.5}>\n        <Typography variant=\"h5\" className={classes.serviceName}>\n          {span.serviceName}\n        </Typography>\n        <Typography variant=\"h6\" className={classes.spanName}>\n          {span.spanName}\n        </Typography>\n      </Box>\n      {spanIds}\n      <Box className={classes.annotationsAndTagsBox}>\n        <Typography variant=\"h6\" className={classes.annotationsAndTagsTitle}>\n          <Trans>Annotations</Trans>\n        </Typography>\n        <SpanAnnotations span={span} />\n      </Box>\n      <Box className={classes.annotationsAndTagsBox}>\n        <Typography variant=\"h6\" className={classes.annotationsAndTagsTitle}>\n          <Trans>Tags</Trans>\n        </Typography>\n        <SpanTags tags={span.tags} />\n      </Box>\n    </Box>\n  );\n});\n\nSpanDetail.propTypes = propTypes;\n\nexport default SpanDetail;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport React, { useState, useCallback, useMemo } from 'react';\nimport Box from '@material-ui/core/Box';\nimport { AutoSizer } from 'react-virtualized';\nimport minBy from 'lodash/minBy';\n\nimport TraceSummaryHeader from './TraceSummaryHeader';\nimport TraceTimeline from './TraceTimeline';\nimport TraceTimelineHeader from './TraceTimelineHeader';\nimport SpanDetail from './SpanDetail';\nimport { detailedTraceSummaryPropTypes } from '../../prop-types';\nimport { hasRootSpan } from '../../util/trace';\n\nconst findSpanIndex = (spans, spanId) =>\n  spans.findIndex((span) => span.spanId === spanId);\n\nconst propTypes = {\n  traceSummary: detailedTraceSummaryPropTypes.isRequired,\n};\n\nconst TraceSummary = React.memo(({ traceSummary }) => {\n  const isRootedTrace = hasRootSpan(traceSummary.spans);\n  const [rootSpanIndex, setRootSpanIndex] = useState(0);\n  const isRerooted = rootSpanIndex !== 0;\n  const [currentSpanIndex, setCurrentSpanIndex] = useState(0);\n  const [childrenHiddenSpanIndices, setChildrenHiddenSpanIndices] = useState(\n    {},\n  );\n  const [isSpanDetailOpened, setIsSpanDetailOpened] = useState(true);\n  const traceTimelineWidthPercent = isSpanDetailOpened ? 60 : 100;\n\n  const handleChildrenToggle = useCallback(\n    (spanId) => {\n      const spanIndex = findSpanIndex(traceSummary.spans, spanId);\n      setChildrenHiddenSpanIndices((prev) => ({\n        ...prev,\n        [spanIndex]: !prev[spanIndex],\n      }));\n    },\n    [traceSummary.spans],\n  );\n\n  const handleResetRerootButtonClick = useCallback(() => {\n    setRootSpanIndex(0);\n  }, []);\n\n  const handleTimelineRowClick = useCallback(\n    (spanId) => {\n      const idx = traceSummary.spans.findIndex(\n        (span) => span.spanId === spanId,\n      );\n      if (isRootedTrace && currentSpanIndex === idx) {\n        if (rootSpanIndex === idx) {\n          setRootSpanIndex(0);\n        } else {\n          setRootSpanIndex(idx);\n        }\n      }\n      setCurrentSpanIndex(idx);\n      setIsSpanDetailOpened(true);\n    },\n    [currentSpanIndex, isRootedTrace, traceSummary.spans, rootSpanIndex],\n  );\n\n  const rerootedTree = useMemo(() => {\n    // If the trace does not have a root span, the trace is not filtered anymore\n    // and the entire trace should be displayed.\n    if (!isRootedTrace) {\n      return traceSummary.spans;\n    }\n\n    const rootSpan = traceSummary.spans[rootSpanIndex];\n    const spans = [rootSpan];\n    for (let i = rootSpanIndex + 1; i < traceSummary.spans.length; i += 1) {\n      const span = traceSummary.spans[i];\n      if (span.depth <= rootSpan.depth) {\n        break;\n      }\n      spans.push(span);\n    }\n    return spans;\n  }, [isRootedTrace, rootSpanIndex, traceSummary.spans]);\n\n  // shownTree is a list of spans excluding hidden spans from rerootedTree.\n  const shownTree = useMemo(() => {\n    let childrenHiddenSpanDepth;\n    return rerootedTree.reduce((acc, span) => {\n      if (!!childrenHiddenSpanDepth && span.depth > childrenHiddenSpanDepth) {\n        return acc;\n      }\n      childrenHiddenSpanDepth = null;\n      acc.push(span);\n      const spanIndex = findSpanIndex(traceSummary.spans, span.spanId);\n      if (childrenHiddenSpanIndices[spanIndex]) {\n        childrenHiddenSpanDepth = span.depth;\n      }\n      return acc;\n    }, []);\n  }, [rerootedTree, childrenHiddenSpanIndices, traceSummary.spans]);\n\n  const childrenHiddenSpanIds = React.useMemo(\n    () =>\n      Object.keys(childrenHiddenSpanIndices)\n        .filter((spanIndex) => !!childrenHiddenSpanIndices[spanIndex])\n        .reduce((acc, spanIndex) => {\n          acc[traceSummary.spans[spanIndex].spanId] = true;\n          return acc;\n        }, {}),\n    [traceSummary.spans, childrenHiddenSpanIndices],\n  );\n\n  // Find the minumum and maximum timestamps in the shown spans.\n  const startTs = useMemo(() => minBy(rerootedTree, 'timestamp').timestamp, [\n    rerootedTree,\n  ]);\n  const endTs = useMemo(\n    () =>\n      rerootedTree\n        .map((span) => {\n          let ts = span.timestamp;\n          if (span.duration) {\n            ts += span.duration;\n          }\n          return ts;\n        })\n        .reduce((a, b) => Math.max(a, b)),\n    [rerootedTree],\n  );\n\n  const handleSpanDetailToggle = useCallback(() => {\n    setIsSpanDetailOpened((prev) => !prev);\n  }, []);\n\n  const handleExpandButtonClick = useCallback(() => {\n    const expandedSpanIndices = shownTree\n      .filter((span) => !!childrenHiddenSpanIds[span.spanId])\n      .reduce((acc, span) => {\n        const spanIndex = findSpanIndex(traceSummary.spans, span.spanId);\n        acc[spanIndex] = false;\n        return acc;\n      }, {});\n    setChildrenHiddenSpanIndices((prev) => ({\n      ...prev,\n      ...expandedSpanIndices,\n    }));\n  }, [shownTree, traceSummary.spans, childrenHiddenSpanIds]);\n\n  const handleCollapseButtonClick = useCallback(() => {\n    const spanIndex = findSpanIndex(traceSummary.spans, shownTree[0].spanId);\n    setChildrenHiddenSpanIndices((prev) => ({\n      ...prev,\n      [spanIndex]: true,\n    }));\n  }, [shownTree, traceSummary.spans]);\n\n  return (\n    <Box height=\"calc(100vh - 64px)\" display=\"flex\" flexDirection=\"column\">\n      <Box boxShadow={3} zIndex={1}>\n        <TraceSummaryHeader\n          traceSummary={traceSummary}\n          rootSpanIndex={rootSpanIndex}\n        />\n      </Box>\n      <Box height=\"100%\" display=\"flex\">\n        <Box\n          width={`${traceTimelineWidthPercent}%`}\n          display=\"flex\"\n          flexDirection=\"column\"\n        >\n          <TraceTimelineHeader\n            startTs={startTs - traceSummary.spans[0].timestamp}\n            endTs={endTs - traceSummary.spans[0].timestamp}\n            isRerooted={isRerooted}\n            isRootedTrace={isRootedTrace}\n            onResetRerootButtonClick={handleResetRerootButtonClick}\n            isSpanDetailOpened={isSpanDetailOpened}\n            onSpanDetailToggle={handleSpanDetailToggle}\n            onCollapseButtonClick={handleCollapseButtonClick}\n            onExpandButtonClick={handleExpandButtonClick}\n          />\n          <Box flexGrow={1} width=\"100%\">\n            <AutoSizer>\n              {({ height, width }) => (\n                <Box height={height} width={width} overflow=\"auto\">\n                  <TraceTimeline\n                    currentSpanId={traceSummary.spans[currentSpanIndex].spanId}\n                    spans={shownTree}\n                    depth={traceSummary.depth}\n                    childrenHiddenSpanIds={childrenHiddenSpanIds}\n                    isRootedTrace={isRootedTrace}\n                    onRowClick={handleTimelineRowClick}\n                    onChildrenToggle={handleChildrenToggle}\n                    startTs={startTs}\n                    endTs={endTs}\n                  />\n                </Box>\n              )}\n            </AutoSizer>\n          </Box>\n        </Box>\n        <Box width={`${100 - traceTimelineWidthPercent}%`}>\n          <AutoSizer>\n            {({ height, width }) => (\n              <Box height={height} width={width} overflow=\"auto\">\n                <SpanDetail\n                  span={traceSummary.spans[currentSpanIndex]}\n                  minHeight={height}\n                />\n              </Box>\n            )}\n          </AutoSizer>\n        </Box>\n      </Box>\n    </Box>\n  );\n});\n\nTraceSummary.propTypes = propTypes;\n\nexport default TraceSummary;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport PropTypes from 'prop-types';\nimport React, { useEffect, useRef } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { withRouter } from 'react-router-dom';\n\nimport TraceSummary from './TraceSummary';\nimport { setAlert } from '../App/slice';\nimport { LoadingIndicator } from '../common/LoadingIndicator';\nimport { loadTrace } from '../../slices/tracesSlice';\n\nconst propTypes = {\n  match: PropTypes.shape({\n    params: PropTypes.shape({\n      traceId: PropTypes.string.isRequired,\n    }),\n  }).isRequired,\n};\n\nexport const TracePageImpl = React.memo(({ match }) => {\n  const { traceId } = match.params;\n\n  const { isLoading, traceSummary, error } = useSelector((state) => ({\n    isLoading: state.traces.traces[traceId]?.isLoading || false,\n    traceSummary: state.traces.traces[traceId]?.adjustedTrace || undefined,\n    error: state.traces.traces[traceId]?.error || undefined,\n  }));\n\n  const dispatch = useDispatch();\n\n  useEffect(() => {\n    dispatch(loadTrace(traceId));\n  }, [traceId, dispatch]);\n\n  const firstUpdate = useRef(true);\n  useEffect(() => {\n    // In the first rendering, skip this useEffect, because isLoading\n    // is always false and traceSummary always is undefined.\n    if (firstUpdate.current) {\n      firstUpdate.current = false;\n      return;\n    }\n    if (!isLoading && !traceSummary) {\n      let message = 'No trace found';\n      if (error && error.message) {\n        message += `: ${error.message}`;\n      }\n      dispatch(\n        setAlert({\n          message,\n          severity: 'error',\n        }),\n      );\n    }\n  }, [dispatch, error, isLoading, traceSummary]);\n\n  if (isLoading) {\n    return <LoadingIndicator />;\n  }\n\n  if (!traceSummary) {\n    return null;\n  }\n  return <TraceSummary traceSummary={traceSummary} />;\n});\n\nTracePageImpl.propTypes = propTypes;\n\nexport default withRouter(TracePageImpl);\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport { combineReducers } from 'redux';\n\nimport appSlice from '../components/App/slice';\nimport autocompleteKeysSlice from '../slices/autocompleteKeysSlice';\nimport autocompleteValuesSlice from '../slices/autocompleteValuesSlice';\nimport dependenciesSlice from '../slices/dependenciesSlice';\nimport remoteServicesSlice from '../slices/remoteServicesSlice';\nimport servicesSlice from '../slices/servicesSlice';\nimport spansSlice from '../slices/spansSlice';\nimport tracesSlice from '../slices/tracesSlice';\n\nconst createReducer = () =>\n  combineReducers({\n    [appSlice.name]: appSlice.reducer,\n    [autocompleteKeysSlice.name]: autocompleteKeysSlice.reducer,\n    [autocompleteValuesSlice.name]: autocompleteValuesSlice.reducer,\n    [dependenciesSlice.name]: dependenciesSlice.reducer,\n    [remoteServicesSlice.name]: remoteServicesSlice.reducer,\n    [servicesSlice.name]: servicesSlice.reducer,\n    [spansSlice.name]: spansSlice.reducer,\n    [tracesSlice.name]: tracesSlice.reducer,\n  });\n\nexport default createReducer;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { createStore, applyMiddleware } from 'redux';\nimport thunk from 'redux-thunk';\n\nimport createReducer from '../reducers';\n\nexport default function configureStore(config) {\n  return createStore(createReducer(config), applyMiddleware(thunk));\n}\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport Snackbar from '@material-ui/core/Snackbar';\nimport Alert from '@material-ui/lab/Alert';\nimport React, { useCallback } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\n\nimport { RootState } from '../../store';\n\nimport { clearAlert } from './slice';\n\n/**\n * Renders a message at the top of the page, usually to indicate success / failure of a background\n * action.\n */\nconst AlertSnackbar: React.FC = () => {\n  const dispatch = useDispatch();\n  const { alert, alertOpen } = useSelector((state: RootState) => state.app);\n  const onSnackbarClose = useCallback(() => dispatch(clearAlert()), [dispatch]);\n  return (\n    <Snackbar\n      open={alertOpen}\n      autoHideDuration={3000}\n      onClose={onSnackbarClose}\n      anchorOrigin={{\n        vertical: 'top',\n        horizontal: 'center',\n      }}\n    >\n      <Alert elevation={6} variant=\"filled\" severity={alert.severity}>\n        {alert.message}\n      </Alert>\n    </Snackbar>\n  );\n};\n\nexport default AlertSnackbar;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport MomentUtils from '@date-io/moment';\nimport { I18nProvider } from '@lingui/react';\nimport {\n  CircularProgress,\n  ThemeProvider as MuiThemeProvider,\n} from '@material-ui/core';\nimport { MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport React, { Suspense } from 'react';\nimport { Provider } from 'react-redux';\nimport { BrowserRouter, Route } from 'react-router-dom';\nimport { useTitle } from 'react-use';\nimport { ThemeProvider } from 'styled-components';\n\nimport Layout from './Layout';\nimport DependenciesPage from '../DependenciesPage';\nimport DiscoverPage from '../DiscoverPage';\nimport TracePage from '../TracePage';\nimport { UiConfig, UiConfigConsumer } from '../UiConfig';\nimport configureStore from '../../store/configure-store';\nimport { theme } from '../../constants/color';\nimport { i18n } from '../../util/locale';\nimport { BASE_PATH } from '../../constants/api';\nimport AlertSnackbar from './AlertSnackbar';\n\nconst App: React.FC = () => {\n  useTitle('Zipkin');\n\n  return (\n    <Suspense fallback={<CircularProgress />}>\n      <UiConfig>\n        <MuiPickersUtilsProvider utils={MomentUtils}>\n          <ThemeProvider theme={theme}>\n            <MuiThemeProvider theme={theme}>\n              <UiConfigConsumer>\n                {(config) => (\n                  <Provider store={configureStore(config)}>\n                    <AlertSnackbar />\n                    <I18nProvider i18n={i18n}>\n                      <BrowserRouter basename={BASE_PATH}>\n                        <Layout>\n                          <Route exact path=\"/\" component={DiscoverPage} />\n                          {config.dependency.enabled && (\n                            <Route\n                              exact\n                              path=\"/dependency\"\n                              component={DependenciesPage}\n                            />\n                          )}\n                          <Route\n                            exact\n                            path={['/traces/:traceId', '/traceViewer']}\n                            component={TracePage}\n                          />\n                        </Layout>\n                      </BrowserRouter>\n                    </I18nProvider>\n                  </Provider>\n                )}\n              </UiConfigConsumer>\n            </MuiThemeProvider>\n          </ThemeProvider>\n        </MuiPickersUtilsProvider>\n      </UiConfig>\n    </Suspense>\n  );\n};\n\nexport default App;\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport React from 'react';\nimport ReactDOM from 'react-dom';\n\nimport App from './components/App';\nimport './index.css';\n\nReactDOM.render(<App />, document.getElementById('root'));\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport isEqual from 'lodash/isEqual';\nimport sortBy from 'lodash/sortBy';\nimport unionWith from 'lodash/unionWith';\n\nexport function normalizeTraceId(traceId) {\n  if (traceId.length > 16) {\n    const result = traceId.padStart(32, '0');\n    // undo prefix if it will result in a 64-bit trace ID\n    if (result.startsWith('0000000000000000')) return result.substring(16);\n    return result;\n  }\n  return traceId.padStart(16, '0');\n}\n\nfunction isEndpoint(endpoint) {\n  return endpoint && Object.keys(endpoint).length > 0;\n}\n\n// This cleans potential dirty v2 inputs, like normalizing IDs etc. It does not affect the input\nexport function clean(span) {\n  const res = {\n    traceId: normalizeTraceId(span.traceId),\n  };\n\n  // take care not to create self-referencing spans even if the input data is incorrect\n  const id = span.id.padStart(16, '0');\n  if (span.parentId) {\n    const parentId = span.parentId.padStart(16, '0');\n    if (parentId !== id) res.parentId = parentId;\n  }\n  res.id = id;\n\n  if (span.name && span.name !== '' && span.name !== 'unknown')\n    res.name = span.name;\n  if (span.kind) res.kind = span.kind;\n\n  if (span.timestamp) res.timestamp = span.timestamp;\n  if (span.duration) res.duration = span.duration;\n\n  if (isEndpoint(span.localEndpoint))\n    res.localEndpoint = { ...span.localEndpoint };\n  if (isEndpoint(span.remoteEndpoint))\n    res.remoteEndpoint = { ...span.remoteEndpoint };\n\n  res.annotations = span.annotations ? span.annotations.slice(0) : [];\n  if (res.annotations.length > 1) {\n    res.annotations = sortBy(unionWith(res.annotations, isEqual), [\n      'timestamp',\n      'value',\n    ]);\n  }\n\n  res.tags = span.tags || {};\n\n  if (span.debug) res.debug = true;\n  // shared is for the server side, unset it if accidentally set on the client side\n  if (span.shared && span.kind !== 'CLIENT') res.shared = true;\n\n  return res;\n}\n\n// exposed for testing. assumes spans are already clean\nexport function merge(left, right) {\n  const res = {\n    traceId: right.traceId.length > 16 ? right.traceId : left.traceId,\n  };\n\n  const parentId = left.parentId || right.parentId;\n  if (parentId) res.parentId = parentId;\n\n  res.id = left.id;\n  const name = left.name || right.name;\n  if (name) res.name = name;\n\n  const kind = left.kind || right.kind;\n  if (kind) res.kind = kind;\n\n  const timestamp = left.timestamp || right.timestamp;\n  if (timestamp) res.timestamp = timestamp;\n  const duration = left.duration || right.duration;\n  if (duration) res.duration = duration;\n\n  const localEndpoint = { ...left.localEndpoint, ...right.localEndpoint };\n  if (isEndpoint(localEndpoint)) res.localEndpoint = localEndpoint;\n  const remoteEndpoint = { ...left.remoteEndpoint, ...right.remoteEndpoint };\n  if (isEndpoint(remoteEndpoint)) res.remoteEndpoint = remoteEndpoint;\n\n  if (left.annotations.length === 0) {\n    res.annotations = right.annotations;\n  } else if (right.annotations.length === 0) {\n    res.annotations = left.annotations;\n  } else {\n    res.annotations = sortBy(\n      unionWith(left.annotations, right.annotations, isEqual),\n      ['timestamp', 'value'],\n    );\n  }\n\n  res.tags = { ...left.tags, ...right.tags };\n\n  if (left.debug || right.debug) res.debug = true;\n  if (left.shared || right.shared) res.shared = true;\n  return res;\n}\n\n// compares potentially undefined input\nexport function compare(a, b) {\n  if (!a && !b) return 0;\n  if (!a) return -1;\n  if (!b) return 1;\n  return (a > b) - (a < b);\n}\n\nfunction isUndefined(ref) {\n  return typeof ref === 'undefined';\n}\n\n/*\n * Put spans with null endpoints first, so that their data can be attached to the first span with\n * the same ID and endpoint. It is possible that a server can get the same request on a different\n * port. Not addressing this.\n */\nfunction compareEndpoint(left, right) {\n  // handle nulls first\n  if (isUndefined(left)) return -1;\n  if (isUndefined(right)) return 1;\n\n  const byService = compare(left.serviceName, right.serviceName);\n  if (byService !== 0) return byService;\n  const byIpV4 = compare(left.ipv4, right.ipv4);\n  if (byIpV4 !== 0) return byIpV4;\n  return compare(left.ipv6, right.ipv6);\n}\n\n// false or null first (client first)\nfunction compareShared(left, right) {\n  const leftNotShared = isUndefined(left.shared) || !left.shared;\n  const rightNotShared = isUndefined(right.shared) || !right.shared;\n\n  if (leftNotShared && rightNotShared) {\n    return left.kind === 'CLIENT' ? -1 : 1;\n  }\n  if (leftNotShared) return -1;\n  if (rightNotShared) return 1;\n  return 0;\n}\n\nexport function cleanupComparator(left, right) {\n  // exported for testing\n  const bySpanId = compare(left.id, right.id);\n  if (bySpanId !== 0) return bySpanId;\n  const byShared = compareShared(left, right);\n  if (byShared !== 0) return byShared;\n  return compareEndpoint(left.localEndpoint, right.localEndpoint);\n}\n\nfunction tryMerge(current, endpoint) {\n  if (!endpoint) return true;\n  if (\n    current.serviceName &&\n    endpoint.serviceName &&\n    current.serviceName !== endpoint.serviceName\n  ) {\n    return false;\n  }\n  if (current.ipv4 && endpoint.ipv4 && current.ipv4 !== endpoint.ipv4) {\n    return false;\n  }\n  if (current.ipv6 && endpoint.ipv6 && current.ipv6 !== endpoint.ipv6) {\n    return false;\n  }\n  if (current.port && endpoint.port && current.port !== endpoint.port) {\n    return false;\n  }\n  if (!current.serviceName) {\n    current.serviceName = endpoint.serviceName; // eslint-disable-line no-param-reassign\n  }\n  if (!current.ipv4) current.ipv4 = endpoint.ipv4; // eslint-disable-line no-param-reassign\n  if (!current.ipv6) current.ipv6 = endpoint.ipv6; // eslint-disable-line no-param-reassign\n  if (!current.port) current.port = endpoint.portAsInt; // eslint-disable-line no-param-reassign\n  return true;\n}\n\n// sort by timestamp, then name, root/shared first in case of skew\nexport function spanComparator(a, b) {\n  // exported for testing\n  if (!a.parentId && b.parentId) {\n    // a is root\n    return -1;\n  }\n  if (a.parentId && !b.parentId) {\n    // b is root\n    return 1;\n  }\n\n  // order client first in case of shared spans (shared is always server)\n  if (a.id === b.id) return compareShared(a, b);\n\n  // Either a and b are root or neither are. sort by shared timestamp, then name\n  return compare(a.timestamp, b.timestamp) || compare(a.name, b.name);\n}\n\n/*\n * Spans can be sent in multiple parts. Also client and server spans can share the same ID. This\n * merges both scenarios.\n */\nexport function mergeV2ById(spans) {\n  let { length } = spans;\n  if (length === 0) return spans;\n\n  const result = [];\n\n  // Let's cleanup any spans and pick the longest ID\n  let traceId;\n  spans.forEach((span) => {\n    const cleaned = clean(span);\n    if (!traceId || traceId.length !== 32) traceId = cleaned.traceId;\n    result.push(cleaned);\n  });\n\n  if (length <= 1) return result;\n  result.sort(cleanupComparator);\n\n  // Now start any fixes or merging\n  let last;\n  for (let i = 0; i < length; i += 1) {\n    let span = result[i];\n\n    // Choose the longest trace ID\n    if (span.traceId.length !== traceId.length) {\n      span.traceId = traceId;\n    }\n\n    const localEndpoint = span.localEndpoint ? { ...span.localEndpoint } : {};\n    while (i + 1 < length) {\n      const next = result[i + 1];\n      if (next.id !== span.id) break;\n\n      // This cautiously merges with the next span, if we think it was sent in multiple pieces.\n      if (\n        span.shared === next.shared &&\n        tryMerge(localEndpoint, next.localEndpoint)\n      ) {\n        span = merge(span, next);\n\n        // remove the merged element\n        length -= 1;\n        result.splice(i + 1, 1);\n        continue;\n      }\n      break;\n    }\n\n    // Zipkin and B3 originally used the same span ID between client and server. Some\n    // instrumentation are inconsistent about adding the shared flag on the server side. Since we\n    // have the entire trace, and it is ordered client-first, we can correct a missing shared flag.\n    if (last && last.id === span.id) {\n      // Backfill missing shared flag as some instrumentation doesn't add it\n      if (last.kind === 'CLIENT' && span.kind === 'SERVER' && !span.shared) {\n        span.shared = true;\n      }\n\n      // handle a shared RPC server span that wasn't propagated its parent span ID\n      if (span.shared && !span.parentId && last.parentId) {\n        span.parentId = last.parentId;\n      }\n    }\n\n    last = span;\n    result[i] = span;\n  }\n\n  const sorted = result.sort(spanComparator);\n\n  // Look to see if there is a root span, in case we need to correct its shared flag\n  if (sorted[0].parentId || !sorted[0].shared) return sorted;\n\n  // Sorting puts root spans first. If there's only one root, remove any shared flag.\n  if (sorted.length === 1 || sorted[1].parentId) {\n    delete sorted[0].shared;\n  }\n\n  return sorted;\n}\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { compare, mergeV2ById } from './span-cleaner';\n\n/*\n * Convenience type representing a trace tree. Multiple Zipkin features require a trace tree. For\n * example, looking at network boundaries to correct clock skew and aggregating requests paths imply\n * visiting the tree.\n */\n// originally zipkin2.internal.SpanNode.java\nexport class SpanNode {\n  constructor(span) {\n    this._parent = undefined; // no default\n    this._span = span; // undefined is possible when this is a synthetic root node\n    this._children = [];\n  }\n\n  // Returns the parent, or undefined if root.\n  get parent() {\n    return this._parent;\n  }\n\n  _setParent(newParent) {\n    this._parent = newParent;\n  }\n\n  // Returns the span, or undefined if a synthetic root node\n  get span() {\n    return this._span;\n  }\n\n  // Returns the children of this node\n  get children() {\n    return this._children;\n  }\n\n  // Mutable as some transformations, such as clock skew, adjust the current node in the tree.\n  setSpan(span) {\n    if (!span) throw new Error('span was undefined');\n    this._span = span;\n  }\n\n  // Adds the child IFF it isn't already a child.\n  addChild(child) {\n    if (!child) throw new Error('child was undefined');\n    if (child === this)\n      throw new Error(`circular dependency on ${this.toString()}`);\n    child._setParent(this);\n    this._children.push(child);\n  }\n\n  // throws an error if the trace was empty\n  queueRootMostSpans() {\n    const queue = [];\n    // since the input data could be headless, we first push onto the queue the root-most spans\n    if (typeof this.span === 'undefined') {\n      // synthetic root\n      this.children.forEach((child) => queue.push(child));\n    } else {\n      queue.push(this);\n    }\n    if (queue.length === 0) throw new Error('Trace was empty');\n    return queue;\n  }\n\n  // Invokes the callback for each span resulting from a breadth-first traversal at this node\n  traverse(spanCallback) {\n    const queue = this.queueRootMostSpans();\n\n    while (queue.length > 0) {\n      const current = queue.shift();\n\n      spanCallback(current.span);\n\n      const { children } = current;\n      for (let i = 0; i < children.length; i += 1) {\n        queue.push(children[i]);\n      }\n    }\n  }\n\n  toString() {\n    if (this._span) return `SpanNode(${JSON.stringify(this._span)})`;\n    return 'SpanNode()';\n  }\n}\n\n// In javascript, dict keys can't be objects\nfunction keyString(id, shared = false, endpoint) {\n  if (!shared) return id;\n  const endpointString = endpoint ? JSON.stringify(endpoint) : 'x';\n  return `${id}-${endpointString}`;\n}\n\nfunction nodeByTimestamp(a, b) {\n  return compare(a.span.timestamp, b.span.timestamp);\n}\n\nfunction sortChildren(node) {\n  if (node.children.length > 0) {\n    node.children.sort(nodeByTimestamp);\n  }\n}\n\nfunction sortTreeByTimestamp(root) {\n  const queue = [];\n  queue.push(root);\n\n  while (queue.length > 0) {\n    const current = queue.shift();\n\n    sortChildren(current);\n\n    const { children } = current;\n    for (let i = 0; i < children.length; i += 1) {\n      queue.push(children[i]);\n    }\n  }\n}\n\nexport class SpanNodeBuilder {\n  constructor(params) {\n    const { debug = false } = params;\n    this._debug = debug;\n    this._rootSpan = undefined;\n    this._keyToNode = {};\n    this._spanToParent = {};\n  }\n\n  /*\n   * We index spans by (id, shared, localEndpoint) before processing them. This latter fields\n   * (shared, endpoint) are important because in zipkin (specifically B3), a server can share\n   * (re-use) the same ID as its client. This impacts processing quite a bit when multiple servers\n   * share one span ID.\n   *\n   * In a Zipkin trace, a parent (client) and child (server) can share the same ID if in an\n   * RPC. If two different servers respond to the same client, the only way for us to tell which\n   * is which is by endpoint. Our goal is to retain full paths across multiple endpoints. Even\n   * though instrumentation should be configured in such a way that a client never sends the same\n   * span ID to multiple servers, it can happen. Accordingly, we index defensively including any\n   * endpoint data that might be available.\n   */\n  _index(span) {\n    let idKey;\n    let parentKey;\n\n    if (span.shared) {\n      // we need to classify a shared span by its endpoint in case multiple servers respond to the\n      // same ID sent by the client.\n      idKey = keyString(span.id, true, span.localEndpoint);\n      // the parent of a server span is a client, which is not ambiguous for a given span ID.\n      parentKey = span.id;\n    } else {\n      idKey = span.id;\n      parentKey = span.parentId;\n    }\n\n    this._spanToParent[idKey] = parentKey;\n  }\n\n  /**\n   * Processing is taking a span and placing it at the most appropriate place in the trace tree.\n   * For example, if this is a server span, it would be a different node, and a child of its client\n   * even if they share the same span ID.\n   *\n   * Processing is defensive of typical problems in span reporting, such as depth-first. For\n   * example, depth-first reporting implies you can see spans missing their parent. Hence, the\n   * result of processing all spans can be a virtual root node.\n   */\n  _process(span) {\n    const endpoint = span.localEndpoint;\n    const key = keyString(span.id, span.shared, span.localEndpoint);\n    const noEndpointKey = endpoint ? keyString(span.id, span.shared) : key;\n\n    let parent;\n    if (span.shared) {\n      // Shared is a server span. It will very likely be on a different endpoint than the client.\n      // Clients are not ambiguous by ID, so we don't need to qualify by endpoint.\n      parent = span.id;\n    } else if (span.parentId) {\n      // We are not a root span, and not a shared server span. Proceed in most specific to least.\n\n      // We could be the child of a shared server span (ex a local (intermediate) span on the same\n      // endpoint). This is the most specific case, so we try this first.\n      parent = keyString(span.parentId, true, endpoint);\n      if (this._spanToParent[parent]) {\n        this._spanToParent[noEndpointKey] = parent;\n      } else {\n        // If there's no shared parent, fall back to normal case which is unqualified beyond ID.\n        parent = span.parentId;\n      }\n    } else if (this._rootSpan) {\n      // we are root or don't know our parent\n      if (this._debug) {\n        const prefix = 'attributing span missing parent to root';\n        /* eslint-disable no-console */\n        console.log(\n          `${prefix}: traceId=${span.traceId}, rootId=${this._rootSpan.span.id}, id=${span.id}`,\n        );\n      }\n    }\n\n    const node = new SpanNode(span);\n    // special-case root, and attribute missing parents to it. In\n    // other words, assume that the first root is the \"real\" root.\n    if (!parent && !this._rootSpan) {\n      this._rootSpan = node;\n      delete this._spanToParent[noEndpointKey];\n    } else if (span.shared) {\n      // In the case of shared server span, we need to address it both ways, in case intermediate\n      // spans are lacking endpoint information.\n      this._keyToNode[key] = node;\n      this._keyToNode[noEndpointKey] = node;\n    } else {\n      this._keyToNode[noEndpointKey] = node;\n    }\n  }\n\n  /*\n   * Builds a trace tree by merging and processing the input or returns an empty tree.\n   *\n   * While the input can be incomplete or redundant, they must all be a part of the same trace\n   * (e.g. all share the same trace ID).\n   */\n  build(spans) {\n    if (spans.length === 0) throw new Error('Trace was empty');\n\n    // In order to make a tree, we need clean data. This will merge any duplicates so that we\n    // don't have redundant leaves on the tree.\n    const cleaned = mergeV2ById(spans);\n    const { length } = cleaned;\n    const [{ traceId }] = cleaned;\n\n    if (this._debug) {\n      /* eslint-disable no-console */\n      console.log(`building trace tree: traceId=${traceId}`);\n    }\n\n    // Next, index all the spans so that we can understand any relationships.\n    for (let i = 0; i < length; i += 1) {\n      this._index(cleaned[i]);\n    }\n\n    // Now that we've index references to all spans, we can revise any parent-child relationships.\n    // Notably, by now, we can tell which is the root-most.\n    for (let i = 0; i < length; i += 1) {\n      this._process(cleaned[i]);\n    }\n\n    if (!this._rootSpan) {\n      if (this._debug) {\n        /* eslint-disable no-console */\n        console.log(\n          `substituting dummy node for missing root span: traceId=${traceId}`,\n        );\n      }\n      this._rootSpan = new SpanNode();\n    }\n\n    // At this point, we have the most reliable parent-child relationships and can allocate spans\n    // corresponding the the best place in the trace tree.\n    Object.keys(this._spanToParent).forEach((key) => {\n      const child = this._keyToNode[key];\n      const parent = this._keyToNode[this._spanToParent[key]];\n\n      if (!parent) {\n        // Handle headless by attaching spans missing parents to root\n        this._rootSpan.addChild(child);\n      } else {\n        parent.addChild(child);\n      }\n    });\n\n    sortTreeByTimestamp(this._rootSpan);\n\n    return this._rootSpan;\n  }\n}\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { SpanNode, SpanNodeBuilder } from './span-node';\n\nclass ClockSkew {\n  constructor(params) {\n    const { endpoint, skew } = params;\n    this._endpoint = endpoint;\n    this._skew = skew;\n  }\n\n  get endpoint() {\n    return this._endpoint;\n  }\n\n  get skew() {\n    return this._skew;\n  }\n}\n\nexport function ipsMatch(a, b) {\n  // export for testing\n  if (!a || !b) return false;\n  if (a.ipv6 && b.ipv6 && a.ipv6 === b.ipv6) {\n    return true;\n  }\n  if (!a.ipv4 && !b.ipv4) return false;\n  return a.ipv4 === b.ipv4;\n}\n\n// If any annotation has an IP with skew associated, adjust accordingly.\nfunction adjustTimestamps(span, skew) {\n  if (!ipsMatch(skew.endpoint, span.localEndpoint)) return span;\n\n  const result = { ...span };\n  if (span.timestamp) result.timestamp = span.timestamp - skew.skew;\n  const annotationLength = span.annotations.length;\n  if (annotationLength > 0) result.annotations = [];\n  for (let i = 0; i < annotationLength; i += 1) {\n    const a = span.annotations[i];\n    result.annotations[i] = {\n      timestamp: a.timestamp - skew.skew,\n      value: a.value,\n    };\n  }\n  return result;\n}\n\n/* Uses span kind to determine if there's clock skew. */\nexport function getClockSkew(node) {\n  // export for testing\n  const parent = node.parent ? node.parent.span : undefined;\n  const child = node.span;\n  if (!parent) return undefined;\n\n  // skew is only detectable client to server\n  if (parent.kind !== 'CLIENT' || child.kind !== 'SERVER') return undefined;\n\n  let oneWay = false;\n  const clientTimestamp = parent.timestamp;\n  const serverTimestamp = child.timestamp;\n  if (!clientTimestamp || !serverTimestamp) return undefined;\n\n  // skew is when the server happens before the client\n  if (serverTimestamp > clientTimestamp) return undefined;\n\n  const clientDuration = parent.duration;\n  const serverDuration = child.duration;\n  if (!clientDuration || !serverDuration) oneWay = true;\n\n  const server = child.localEndpoint;\n  if (!server) return undefined;\n  const client = parent.localEndpoint;\n  if (!client) return undefined;\n\n  // There's no skew if the RPC is going to itself\n  if (ipsMatch(server, client)) return undefined;\n\n  if (oneWay) {\n    const latency = serverTimestamp - clientTimestamp;\n\n    // the only way there is skew is when the client appears to be after the server\n    if (latency > 0) return undefined;\n    // We can't currently do better than push the client and server apart by minimum duration (1)\n    return new ClockSkew({ endpoint: server, skew: latency - 1 });\n  }\n  // If the client finished before the server (async), we still know the server must have happened\n  // after the client. So, push 1us.\n  if (clientDuration < serverDuration) {\n    const skew = serverTimestamp - clientTimestamp - 1;\n    return new ClockSkew({ endpoint: server, skew });\n  }\n\n  // We assume latency is half the difference between the client and server duration.\n  const latency = (clientDuration - serverDuration) / 2;\n\n  // We can't see skew when send happens before receive\n  if (latency < 0) return undefined;\n\n  const skew = serverTimestamp - latency - clientTimestamp;\n  if (skew !== 0) return new ClockSkew({ endpoint: server, skew });\n\n  return undefined;\n}\n\n/*\n * Recursively adjust the timestamps on the span trace. Root span is the reference point, all\n * children's timestamps gets adjusted based on that span's timestamps.\n */\nfunction adjust(node, skewFromParent) {\n  // adjust skew for the endpoint brought over from the parent span\n  if (skewFromParent) {\n    node.setSpan(adjustTimestamps(node.span, skewFromParent));\n  }\n\n  // Is there any skew in the current span?\n  let skew = getClockSkew(node);\n  if (skew) {\n    // the current span's skew may be a different endpoint than its parent, so adjust again.\n    node.setSpan(adjustTimestamps(node.span, skew));\n  } else if (skewFromParent) {\n    // Assumes we are on the same host: propagate skew from our parent\n    skew = skewFromParent;\n  }\n  // propagate skew to any children\n  node.children.forEach((child) => adjust(child, skew));\n}\n\nexport function treeCorrectedForClockSkew(spans, debug = false) {\n  if (spans.length === 0) return new SpanNode();\n\n  const trace = new SpanNodeBuilder({ debug }).build(spans);\n\n  if (!trace.span) {\n    if (debug) {\n      /* eslint-disable no-console */\n      console.log(\n        `skipping clock skew adjustment due to missing root span: traceId=${spans[0].traceId}`,\n      );\n    }\n    return trace;\n  }\n\n  const childrenOfRoot = trace.children;\n  for (let i = 0; i < childrenOfRoot.length; i += 1) {\n    const next = childrenOfRoot[i].span;\n    if (next.parentId || next.shared) continue;\n\n    const { traceId } = next;\n    const spanId = next.id;\n    const rootSpanId = trace.span.id;\n    if (debug) {\n      /* eslint-disable no-console */\n      const prefix = 'skipping redundant root span';\n      console.log(\n        `${prefix}: traceId=${traceId}, rootSpanId=${rootSpanId}, spanId=${spanId}`,\n      );\n    }\n    return trace;\n  }\n\n  adjust(trace);\n  return trace;\n}\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nconst CLIENT_SEND = 'cs';\nconst CLIENT_SEND_FRAGMENT = 'csf';\nconst CLIENT_RECEIVE = 'cr';\nconst CLIENT_RECEIVE_FRAGMENT = 'crf';\nconst MESSAGE_SEND = 'ms';\nconst MESSAGE_RECEIVE = 'mr';\nconst SERVER_SEND = 'ss';\nconst SERVER_SEND_FRAGMENT = 'ssf';\nconst SERVER_RECEIVE = 'sr';\nconst SERVER_RECEIVE_FRAGMENT = 'srf';\nconst SERVER_ADDR = 'sa';\nconst CLIENT_ADDR = 'ca';\nconst MESSAGE_ADDR = 'ma';\nconst WIRE_SEND = 'ws';\nconst WIRE_RECEIVE = 'wr';\nconst LOCAL_COMPONENT = 'lc';\n\nexport const ConstantNames = {};\nConstantNames[CLIENT_SEND] = 'Client Send';\nConstantNames[CLIENT_SEND_FRAGMENT] = 'Client Send Fragment';\nConstantNames[CLIENT_RECEIVE] = 'Client Receive';\nConstantNames[CLIENT_RECEIVE_FRAGMENT] = 'Client Receive Fragment';\nConstantNames[MESSAGE_SEND] = 'Producer Send';\nConstantNames[MESSAGE_RECEIVE] = 'Consumer Receive';\nConstantNames[SERVER_SEND] = 'Server Send';\nConstantNames[SERVER_SEND_FRAGMENT] = 'Server Send Fragment';\nConstantNames[SERVER_RECEIVE] = 'Server Receive';\nConstantNames[SERVER_RECEIVE_FRAGMENT] = 'Server Receive Fragment';\nConstantNames[CLIENT_ADDR] = 'Client Address';\nConstantNames[MESSAGE_ADDR] = 'Broker Address';\nConstantNames[SERVER_ADDR] = 'Server Address';\nConstantNames[WIRE_SEND] = 'Wire Send';\nConstantNames[WIRE_RECEIVE] = 'Wire Receive';\nConstantNames[LOCAL_COMPONENT] = 'Local Component';\n// Don't add ERROR to ConstantNames -- css coloring depends on constant name 'error'\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport { ConstantNames } from './trace-constants';\n\n// returns 'critical' if one of the spans has an error tag or currentErrorType was already critical,\n// returns 'transient' if one of the spans has an ERROR annotation, else\n// returns currentErrorType\nexport function getErrorType(span, currentErrorType) {\n  if (currentErrorType === 'critical') return currentErrorType;\n  if (span.tags.error !== undefined) {\n    // empty error tag is ok\n    return 'critical';\n  }\n  if (span.annotations.findIndex((ann) => ann.value === 'error') !== -1) {\n    return 'transient';\n  }\n  return currentErrorType;\n}\n\nexport function formatEndpoint(endpoint) {\n  if (!endpoint) return undefined;\n  const { ipv4, ipv6, port, serviceName } = endpoint;\n  if (ipv4 || ipv6) {\n    const ip = ipv6 ? `[${ipv6}]` : ipv4; // arbitrarily prefer ipv6\n    const portString = port ? `:${port}` : '';\n    const serviceNameString = serviceName ? ` (${serviceName})` : '';\n    return ip + portString + serviceNameString;\n  }\n  return serviceName || '';\n}\n\n/*\n * Derived means not annotated directly. Ex 'Server Start' reflects the the timestamp of a\n * kind=SERVER span. 'Server Finish' is timestamp+duration of the same.\n */\nfunction toAnnotationRow(a, localFormatted, isDerived = false) {\n  const res = {\n    isDerived,\n    value: ConstantNames[a.value] || a.value,\n    timestamp: a.timestamp,\n  };\n  if (localFormatted) res.endpoint = localFormatted;\n  return res;\n}\n\nfunction parseAnnotationRows(span) {\n  const localFormatted = formatEndpoint(span.localEndpoint) || undefined;\n\n  let startTs = span.timestamp || 0;\n  let endTs = startTs && span.duration ? startTs + span.duration : 0;\n  let msTs = 0;\n  let wsTs = 0;\n  let wrTs = 0;\n  let mrTs = 0;\n\n  let begin;\n  let end;\n\n  let { kind } = span;\n\n  // scan annotations in case there are better timestamps, or inferred kind\n  const annotationsToAdd = [];\n  span.annotations.forEach((a) => {\n    switch (a.value) {\n      case 'cs':\n        kind = 'CLIENT';\n        if (a.timestamp <= startTs) {\n          startTs = a.timestamp;\n        } else {\n          annotationsToAdd.push(a);\n        }\n        break;\n      case 'sr':\n        kind = 'SERVER';\n        if (a.timestamp <= startTs) {\n          startTs = a.timestamp;\n        } else {\n          annotationsToAdd.push(a);\n        }\n        break;\n      case 'ss':\n        kind = 'SERVER';\n        if (a.timestamp >= endTs) {\n          endTs = a.timestamp;\n        } else {\n          annotationsToAdd.push(a);\n        }\n        break;\n      case 'cr':\n        kind = 'CLIENT';\n        if (a.timestamp >= endTs) {\n          endTs = a.timestamp;\n        } else {\n          annotationsToAdd.push(a);\n        }\n        break;\n      case 'ms':\n        kind = 'PRODUCER';\n        msTs = a.timestamp;\n        break;\n      case 'mr':\n        kind = 'CONSUMER';\n        mrTs = a.timestamp;\n        break;\n      case 'ws':\n        wsTs = a.timestamp;\n        break;\n      case 'wr':\n        wrTs = a.timestamp;\n        break;\n      default:\n        annotationsToAdd.push(a);\n    }\n  });\n\n  switch (kind) {\n    case 'CLIENT':\n      begin = 'Client Start';\n      end = 'Client Finish';\n      break;\n    case 'SERVER':\n      begin = 'Server Start';\n      end = 'Server Finish';\n      break;\n    case 'PRODUCER':\n      begin = 'Producer Start';\n      end = 'Producer Finish';\n      if (startTs === 0 || (msTs !== 0 && msTs < startTs)) {\n        startTs = msTs;\n        msTs = 0;\n      }\n      if (endTs === 0 || (wsTs !== 0 && wsTs > endTs)) {\n        endTs = wsTs;\n        wsTs = 0;\n      }\n      break;\n    case 'CONSUMER':\n      if (startTs === 0 || (wrTs !== 0 && wrTs < startTs)) {\n        startTs = wrTs;\n        wrTs = 0;\n      }\n      if (endTs === 0 || (mrTs !== 0 && mrTs > endTs)) {\n        endTs = mrTs;\n        mrTs = 0;\n      }\n      if (endTs !== 0 || wrTs !== 0) {\n        begin = 'Consumer Start';\n        end = 'Consumer Finish';\n      } else {\n        begin = 'Consumer Start';\n      }\n      break;\n    default:\n  }\n\n  // restore sometimes special-cased annotations\n  if (msTs) annotationsToAdd.push({ timestamp: msTs, value: 'ms' });\n  if (wsTs) annotationsToAdd.push({ timestamp: wsTs, value: 'ws' });\n  if (wrTs) annotationsToAdd.push({ timestamp: wrTs, value: 'wr' });\n  if (mrTs) annotationsToAdd.push({ timestamp: mrTs, value: 'mr' });\n\n  const beginAnnotation = startTs && begin;\n  const endAnnotation = endTs && end;\n\n  const annotations = []; // prefer empty to undefined for arrays\n\n  if (beginAnnotation) {\n    annotations.push(\n      toAnnotationRow(\n        {\n          value: begin,\n          timestamp: startTs,\n        },\n        localFormatted,\n        true,\n      ),\n    );\n  }\n\n  annotationsToAdd.forEach((a) => {\n    if (beginAnnotation && a.value === begin) return;\n    if (endAnnotation && a.value === end) return;\n    annotations.push(toAnnotationRow(a, localFormatted));\n  });\n\n  if (endAnnotation) {\n    annotations.push(\n      toAnnotationRow(\n        {\n          value: end,\n          timestamp: endTs,\n        },\n        localFormatted,\n        true,\n      ),\n    );\n  }\n  return annotations;\n}\n\nfunction parseTagRows(span) {\n  const localFormatted = formatEndpoint(span.localEndpoint) || undefined;\n\n  const tagRows = []; // prefer empty to undefined for arrays\n  const keys = Object.keys(span.tags);\n  if (keys.length > 0) {\n    keys.forEach((key) => {\n      const tagRow = {\n        key: ConstantNames[key] || key,\n        value: span.tags[key],\n      };\n      if (localFormatted) tagRow.endpoints = [localFormatted];\n      tagRows.push(tagRow);\n    });\n  }\n\n  // Ensure there's at least some data that will display the local address\n  if (\n    !span.kind &&\n    span.annotations.length === 0 &&\n    localFormatted &&\n    keys.length === 0\n  ) {\n    tagRows.push({\n      key: 'Local Address',\n      value: localFormatted,\n    });\n  }\n\n  let addr;\n  switch (span.kind) {\n    case 'CLIENT':\n      addr = 'Server Address';\n      break;\n    case 'SERVER':\n      addr = 'Client Address';\n      break;\n    case 'PRODUCER':\n      addr = 'Broker Address';\n      break;\n    case 'CONSUMER':\n      addr = 'Broker Address';\n      break;\n    default:\n  }\n\n  if (span.remoteEndpoint) {\n    tagRows.push({\n      key: addr || 'Server Address', // default when we don't know the endpoint\n      value: formatEndpoint(span.remoteEndpoint),\n    });\n  }\n  return tagRows;\n}\n\n// This ensures we don't add duplicate annotations on merge\nfunction maybePushAnnotation(annotations, a) {\n  if (\n    annotations.findIndex(\n      (b) => a.timestamp === b.timestamp && a.value === b.value,\n    ) === -1\n  ) {\n    annotations.push(a);\n  }\n}\n\n// This ensures we only add rows for tags that are unique on key and value on merge\nfunction maybePushTag(tags, a) {\n  const sameKeyAndValue = tags.filter(\n    (b) => a.key === b.key && a.value === b.value,\n  );\n  if (sameKeyAndValue.length === 0) {\n    tags.push(a);\n    return;\n  }\n  if ((a.endpoints || []).length === 0) {\n    return; // no endpoints to merge\n  }\n  // Handle when tags are reported by different endpoints\n  sameKeyAndValue.forEach((t) => {\n    if (!t.endpoints) t.endpoints = []; // eslint-disable-line no-param-reassign\n    a.endpoints.forEach((endpoint) => {\n      if (t.endpoints.indexOf(endpoint) === -1) {\n        t.endpoints.push(endpoint);\n      }\n    });\n  });\n}\n\n// This guards to ensure we don't add duplicate service names on merge\nfunction maybePushServiceName(serviceNames, serviceName) {\n  if (!serviceName) return;\n  if (serviceNames.findIndex((s) => s === serviceName) === -1) {\n    serviceNames.push(serviceName);\n  }\n}\n\nexport function getServiceName(endpoint) {\n  return endpoint ? endpoint.serviceName : undefined;\n}\n\nfunction isNullOrUndefined(ref) {\n  return typeof ref === 'undefined' || ref === null;\n}\n\n// Merges the data into a single span row, which is lacking presentation information\nexport function newSpanRow(spansToMerge, isLeafSpan) {\n  const [first] = spansToMerge;\n  const res = {\n    spanId: first.id,\n    serviceNames: [],\n    annotations: [],\n    tags: [],\n    errorType: 'none',\n  };\n\n  let sharedTimestamp;\n  let sharedDuration;\n  spansToMerge.forEach((next) => {\n    if (next.parentId) res.parentId = next.parentId;\n    if (next.name && (!res.spanName || next.kind === 'SERVER')) {\n      res.spanName = next.name; // prefer the server's span name\n    }\n\n    if (next.shared) {\n      // save off any shared timestamp, it is our second choice\n      if (!sharedTimestamp) sharedTimestamp = next.timestamp;\n      if (!sharedDuration) sharedDuration = next.duration;\n    } else {\n      if (!res.timestamp && next.timestamp) res.timestamp = next.timestamp;\n      if (!res.duration && next.duration) res.duration = next.duration;\n    }\n\n    const nextLocalServiceName = getServiceName(next.localEndpoint);\n    const nextRemoteServiceName = getServiceName(next.remoteEndpoint);\n    if (nextLocalServiceName && next.kind === 'SERVER') {\n      res.serviceName = nextLocalServiceName; // prefer the server's service name\n    } else if (\n      isLeafSpan &&\n      nextRemoteServiceName &&\n      next.kind === 'CLIENT' &&\n      !res.serviceName\n    ) {\n      // use the client's remote service name only on leaf spans\n      res.serviceName = nextRemoteServiceName;\n    } else if (nextLocalServiceName && !res.serviceName) {\n      res.serviceName = nextLocalServiceName;\n    }\n\n    maybePushServiceName(res.serviceNames, nextLocalServiceName);\n    maybePushServiceName(res.serviceNames, nextRemoteServiceName);\n\n    parseAnnotationRows(next).forEach((a) =>\n      maybePushAnnotation(res.annotations, a),\n    );\n    parseTagRows(next).forEach((t) => maybePushTag(res.tags, t));\n\n    res.errorType = getErrorType(next, res.errorType);\n\n    if (next.debug) res.debug = true;\n  });\n\n  // timestamp is used to derive positional data later\n  if (!res.timestamp && sharedTimestamp) res.timestamp = sharedTimestamp;\n  // duration is used for deriving data, and also for the zoom function\n  if (!res.duration && sharedDuration) res.duration = sharedDuration;\n\n  // Ensure no required property failures rendering an incomplete or malformed trace\n  if (isNullOrUndefined(res.duration)) res.duration = 0;\n  if (isNullOrUndefined(res.spanName)) res.spanName = 'unknown';\n  if (isNullOrUndefined(res.serviceName)) res.serviceName = 'unknown';\n  res.annotations.forEach((a) => {\n    // eslint-disable-next-line no-param-reassign\n    if (isNullOrUndefined(a.endpoint)) a.endpoint = 'unknown';\n  });\n\n  res.serviceNames.sort();\n  res.annotations.sort((a, b) => a.timestamp - b.timestamp);\n  return res;\n}\n","/*\n * Copyright 2015-2020 The OpenZipkin Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n * in compliance with the License. You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software distributed under the License\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n * or implied. See the License for the specific language governing permissions and limitations under\n * the License.\n */\nimport orderBy from 'lodash/orderBy';\nimport moment from 'moment';\nimport { compare } from './span-cleaner';\nimport { getErrorType, newSpanRow, getServiceName } from './span-row';\n\n// To ensure data doesn't scroll off the screen, we need all timestamps, not just\n// client/server ones.\nexport function addTimestamps(span, timestamps) {\n  if (!span.timestamp) return;\n  timestamps.push(span.timestamp);\n  if (!span.duration) return;\n  timestamps.push(span.timestamp + span.duration);\n}\n\nexport function getMaxDuration(timestamps) {\n  if (timestamps.length > 1) {\n    timestamps.sort();\n    return timestamps[timestamps.length - 1] - timestamps[0];\n  }\n  return 0;\n}\n\nfunction pushEntry(dict, key, value) {\n  if (dict[key]) {\n    dict[key].push(value);\n  } else {\n    dict[key] = [value]; // eslint-disable-line no-param-reassign\n  }\n}\n\nfunction addServiceNameTimestampDuration(span, groupedTimestamps) {\n  const value = {\n    timestamp: span.timestamp || 0, // only used by totalDuration\n    duration: span.duration || 0,\n  };\n\n  if (span.localEndpoint && span.localEndpoint.serviceName) {\n    pushEntry(groupedTimestamps, span.localEndpoint.serviceName, value);\n  }\n  // TODO: only do this if it is a leaf span and a client or producer.\n  // If we are at the bottom of the tree, it can be helpful to count also against a remote\n  // uninstrumented service\n  if (span.remoteEndpoint && span.remoteEndpoint.serviceName) {\n    pushEntry(groupedTimestamps, span.remoteEndpoint.serviceName, value);\n  }\n}\n\nfunction nodeByTimestamp(a, b) {\n  return compare(a.span.timestamp, b.span.timestamp);\n}\n\n// Returns null on empty or when missing a timestamp\nexport function traceSummary(root) {\n  const timestamps = [];\n  const groupedTimestamps = {};\n\n  let traceId;\n  let spanCount = 0;\n  let errorType = 'none';\n\n  root.traverse((span) => {\n    spanCount += 1;\n    traceId = span.traceId;\n    errorType = getErrorType(span, errorType);\n    addTimestamps(span, timestamps);\n    addServiceNameTimestampDuration(span, groupedTimestamps);\n  });\n\n  if (timestamps.length === 0)\n    throw new Error(`Trace ${traceId} is missing a timestamp`);\n\n  // If the first element does not exist, Error will be thrown.\n  // So we don't have to check rootSpan exisitence.\n  const [rootSpan] = root.queueRootMostSpans();\n  const rootServiceName =\n    getServiceName(rootSpan._span.localEndpoint) ||\n    getServiceName(rootSpan._span.remoteEndpoint) ||\n    'unknown';\n  const rootSpanName = rootSpan._span.name || 'unknown';\n\n  return {\n    traceId,\n    timestamp: timestamps[0],\n    duration: getMaxDuration(timestamps),\n    groupedTimestamps,\n    errorType,\n    spanCount,\n    root: {\n      serviceName: rootServiceName,\n      spanName: rootSpanName,\n    },\n  };\n}\n\nfunction formatDate(timestamp, utc) {\n  let m = moment(timestamp / 1000);\n  if (utc) {\n    m = m.utc();\n  }\n  return m.format('MM-DD-YYYYTHH:mm:ss.SSSZZ');\n}\n\nexport function mkDurationStr(duration) {\n  if (duration === 0 || typeof duration === 'undefined') {\n    return '';\n  }\n  if (duration < 1000) {\n    return `${duration.toFixed(0)}s`;\n  }\n  if (duration < 1000000) {\n    if (duration % 1000 === 0) {\n      // Sometimes spans are in milliseconds resolution\n      return `${(duration / 1000).toFixed(0)}ms`;\n    }\n    return `${(duration / 1000).toFixed(3)}ms`;\n  }\n  return `${(duration / 1000000).toFixed(3)}s`;\n}\n\n// Returns a list of {:serviceName, :spanCount} ordered descending by trace duration\nexport function getServiceSummaries(groupedTimestamps) {\n  const services = Object.entries(groupedTimestamps).map(\n    ([serviceName, sts]) => ({\n      serviceName,\n      spanCount: sts.length,\n      maxSpanDuration: Math.max(...sts.map((t) => t.duration)),\n    }),\n  );\n  return orderBy(\n    services,\n    ['maxSpanDuration', 'serviceName'],\n    ['desc', 'asc'],\n  ).map((summary) => ({\n    serviceName: summary.serviceName,\n    spanCount: summary.spanCount,\n  }));\n}\n\nexport function traceSummaries(serviceName, summaries, utc = false) {\n  const maxDuration = Math.max(...summaries.map((s) => s.duration));\n\n  return summaries\n    .map((t) => {\n      const { timestamp } = t;\n\n      const res = {\n        traceId: t.traceId, // used to navigate to trace screen\n        timestamp, // used only for client-side sort\n        startTs: formatDate(timestamp, utc),\n        spanCount: t.spanCount,\n        root: t.root,\n      };\n\n      const duration = t.duration || 0;\n      if (duration) {\n        // used to show the relative duration this trace was compared to others\n        res.width = parseInt(\n          (parseFloat(duration) / parseFloat(maxDuration)) * 100,\n          10,\n        );\n        res.duration = duration; // Used in summary view and client-side sort\n        res.durationStr = mkDurationStr(duration);\n      }\n\n      // groupedTimestamps is keyed by service name, if there are no service names in the trace,\n      // don't try to add data dependent on service names.\n      if (Object.keys(t.groupedTimestamps).length !== 0) {\n        res.serviceSummaries = getServiceSummaries(t.groupedTimestamps);\n      } else {\n        res.serviceSummaries = [];\n      }\n\n      if (t.errorType !== 'none') res.infoClass = `trace-error-${t.errorType}`;\n      return res;\n    })\n    .sort((t1, t2) => {\n      const durationComparison = t2.duration - t1.duration;\n      if (durationComparison === 0) {\n        return t1.traceId.localeCompare(t2.traceId);\n      }\n      return durationComparison;\n    });\n}\n\nfunction incrementEntry(dict, key) {\n  if (dict[key]) {\n    dict[key] += 1; // eslint-disable-line no-param-reassign\n  } else {\n    dict[key] = 1; // eslint-disable-line no-param-reassign\n  }\n}\n\n// We need to do an initial traversal in order to get the timestamp and duration of the trace,\n// as that is used for positioning spans later.\nfunction getTraceTimestampAndDuration(root) {\n  const timestamps = [];\n  root.traverse((span) => addTimestamps(span, timestamps));\n  return {\n    timestamp: timestamps[0] || 0,\n    duration: getMaxDuration(timestamps),\n  };\n}\n\nfunction addLayoutDetails(\n  spanRow,\n  traceTimestamp,\n  traceDuration,\n  depth,\n  childIds,\n) {\n  /* eslint-disable no-param-reassign */\n  spanRow.childIds = childIds;\n  spanRow.depth = depth + 1;\n  spanRow.depthClass = (depth - 1) % 6;\n\n  // Add the correct width and duration string for the span\n  if (spanRow.duration) {\n    // implies traceDuration, as trace duration is derived from spans\n    const width = traceDuration ? (spanRow.duration / traceDuration) * 100 : 0;\n    spanRow.width = width < 0.1 ? 0.1 : width;\n    spanRow.durationStr = mkDurationStr(spanRow.duration); // bubble over the span in trace view\n  } else {\n    spanRow.width = 0.1;\n    spanRow.durationStr = '';\n  }\n\n  if (traceDuration) {\n    // position the span at the correct offset in the trace diagram.\n    spanRow.left = ((spanRow.timestamp - traceTimestamp) / traceDuration) * 100;\n\n    // position each annotation at the offset in the trace diagram.\n    spanRow.annotations.forEach((a) => {\n      /* eslint-disable no-param-reassign */\n      // left offset here is from the span\n      a.left = spanRow.duration\n        ? ((a.timestamp - spanRow.timestamp) / spanRow.duration) * 100\n        : 0;\n      // relative time is for the trace itself\n      a.relativeTime = mkDurationStr(a.timestamp - traceTimestamp);\n      a.width = 8; // size of the dot\n    });\n  } else {\n    spanRow.left = 0;\n  }\n}\n\n// TODO: Revisit naming\nexport function detailedTraceSummary(root) {\n  const serviceNameToCount = {};\n  let queue = root.queueRootMostSpans();\n  const modelview = {\n    traceId: queue[0].span.traceId,\n    depth: 0,\n    spans: [],\n  };\n\n  const { timestamp, duration } = getTraceTimestampAndDuration(root);\n  if (!timestamp)\n    throw new Error(`Trace ${modelview.traceId} is missing a timestamp`);\n\n  while (queue.length > 0) {\n    let current = queue.shift();\n\n    // This is more than a normal tree traversal, as we are merging any server spans that share the\n    // same ID. When that's the case, we pull up any of their children as if they are our own.\n    const spansToMerge = [current.span];\n    const children = [];\n    current.children.forEach((child) => {\n      if (current.span.id === child.span.id) {\n        spansToMerge.push(child.span);\n        child.children.forEach((grandChild) => children.push(grandChild));\n      } else {\n        children.push(child);\n      }\n    });\n\n    // Pulling up children may affect our sort order. We re-sort to ensure rows are added in\n    // timestamp order.\n    children.sort(nodeByTimestamp);\n    queue = children.concat(queue);\n    const childIds = children.map((child) => child.span.id);\n\n    // The mustache template expects one row per span ID. To get the correct depth class, we need to\n    // count distinct span IDs above us.\n    let depth = 1;\n    while (current.parent && current.parent.span) {\n      if (current.parent.span.id !== current.span.id) depth += 1;\n      current = current.parent;\n    }\n    // If we are the deepest span, mark the trace accordingly\n    if (depth > modelview.depth) modelview.depth = depth;\n\n    const isLeafSpan = children.length === 0;\n    const spanRow = newSpanRow(spansToMerge, isLeafSpan);\n\n    addLayoutDetails(spanRow, timestamp, duration, depth, childIds);\n    // NOTE: This will increment both the local and remote service name\n    //\n    // TODO: We should only do this if it is a leaf span and a client or producer. If we are at the\n    // bottom of the tree, it can be helpful to count also against a remote uninstrumented service.\n    spanRow.serviceNames.forEach((serviceName) =>\n      incrementEntry(serviceNameToCount, serviceName),\n    );\n\n    modelview.spans.push(spanRow);\n  }\n\n  modelview.rootSpan = {};\n  // If the first element does not exist, Error will be thrown.\n  // So we don't have to check rootSpan existence.\n  const [rootSpan] = root.queueRootMostSpans();\n  modelview.rootSpan.serviceName =\n    getServiceName(rootSpan._span.localEndpoint) ||\n    getServiceName(rootSpan._span.remoteEndpoint) ||\n    'unknown';\n  modelview.rootSpan.spanName = rootSpan._span.name || 'unknown';\n\n  modelview.serviceNameAndSpanCounts = Object.keys(serviceNameToCount)\n    .sort()\n    .map((serviceName) => ({\n      serviceName,\n      spanCount: serviceNameToCount[serviceName],\n    }));\n\n  // the zoom feature needs backups and timeMarkers regardless of if there is a trace duration\n  modelview.spansBackup = modelview.spans;\n  modelview.timeMarkers = [0.0, 0.2, 0.4, 0.6, 0.8, 1.0].map((p, index) => ({\n    index,\n    time: mkDurationStr(duration * p),\n  }));\n  modelview.timeMarkersBackup = modelview.timeMarkers;\n\n  modelview.duration = duration;\n  modelview.durationStr = mkDurationStr(duration);\n\n  return modelview;\n}\n"],"sourceRoot":""}